<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NexMe - Conecta con personas cerca de ti</title>
    <!-- v7.7.6 Build: 2025-12-14 | UPDATE: Color aclarado #1a1f26 para barra y degradados -->
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Encuentra y conecta con personas cerca de ti">
    <meta name="theme-color" content="#1a1f26">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA2kFaHgj0LpeB3MJBUTG_piDyW_zJ1wzU&libraries=places,geometry"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100vh;
            height: 100dvh;
        }

        #root {
            width: 100%;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            padding: 0;
        }

        .radar-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #google-map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .map-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            background: linear-gradient(180deg, rgba(26, 31, 38, 0.95) 0%, rgba(26, 31, 38, 0.7) 70%, transparent 100%);
            backdrop-filter: blur(12px);
            padding: max(env(safe-area-inset-top), 12px) 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            color: #c9d1d9;
        }

        .map-people-counter {
            background: rgba(13, 17, 23, 0.9);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 8px 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(56, 189, 98, 0.2);
        }

        .map-people-counter-number {
            font-size: 16px;
            font-weight: 700;
            color: #38bd62;
        }

        .map-people-counter-text {
            font-size: 12px;
            color: rgba(230, 237, 243, 0.8);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Slider de radio - Dise√±o sutil para sidebar */
        .radius-slider-section {
            padding: 20px 20px 16px 20px;
            border-top: 1px solid rgba(48, 54, 61, 0.3);
            border-bottom: 1px solid rgba(48, 54, 61, 0.3);
            margin-top: 12px;
        }

        .radius-slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .radius-slider-title {
            font-size: 11px;
            font-weight: 500;
            color: #6e7681;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .radius-slider-value {
            font-size: 14px;
            font-weight: 600;
            color: #38bd62;
        }

        .radius-slider-track {
            position: relative;
            width: 100%;
            height: 6px;
            background: #161b22;
            border-radius: 3px;
            cursor: pointer;
            touch-action: none;
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        .radius-slider-progress {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, rgba(56, 189, 98, 0.5) 0%, #38bd62 100%);
            border-radius: 3px;
        }

        .radius-slider-thumb {
            position: absolute;
            top: 50%;
            width: 18px;
            height: 18px;
            background: linear-gradient(145deg, #3fcf6e 0%, #2ea556 100%);
            border: 2px solid #0d1117;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: grab;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            touch-action: none;
        }

        .radius-slider-marks {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
        }

        .radius-slider-mark {
            font-size: 9px;
            color: #6e7681;
            font-weight: 500;
        }

        .thought-input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 90;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 50px 12px 16px 12px;
            background: linear-gradient(to bottom, 
                rgba(26, 31, 38, 0) 0%, 
                rgba(26, 31, 38, 0.8) 40%, 
                rgba(26, 31, 38, 1) 70%,
                rgba(26, 31, 38, 1) 100%
            );
        }

        .thought-input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            background: #1f2c34;
            border-radius: 24px;
            padding: 6px 12px;
            gap: 8px;
            border: 1px solid rgba(134, 150, 160, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .thought-input-icon {
            width: 24px;
            height: 24px;
            color: #8696a0;
            cursor: pointer;
            flex-shrink: 0;
            transition: color 0.2s ease;
        }

        .thought-input-icon:hover {
            color: #aebac1;
        }

        .thought-input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 8px 4px;
            color: #e9edef;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            outline: none;
            min-width: 0;
        }

        .thought-input::placeholder {
            color: #8696a0;
        }

        .send-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #00a884;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: background 0.2s ease;
        }

        .send-button:hover {
            background: #06cf9c;
        }

        .send-button svg {
            width: 22px;
            height: 22px;
            color: #fff;
        }

        .location-permission {
            position: fixed;
            inset: 0;
            background: rgba(13, 17, 23, 0.97);
            backdrop-filter: blur(20px);
            z-index: 400;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
        }

        .permission-card {
            background: rgba(22, 27, 34, 0.95);
            border: 1px solid rgba(48, 54, 61, 0.6);
            border-radius: 18px;
            padding: 34px 26px;
            text-align: center;
            max-width: 350px;
        }

        .permission-icon {
            width: 68px;
            height: 68px;
            margin: 0 auto 22px;
            color: #58a6ff;
        }

        .permission-card h2 {
            font-size: 21px;
            color: #f0f6fc;
            margin-bottom: 11px;
        }

        .permission-card p {
            color: #8b949e;
            line-height: 1.6;
            font-size: 14px;
        }

        .gps-dots {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .gps-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #38bd62;
            animation: pulse 1s ease-in-out infinite;
        }

        .gps-dot:nth-child(2) { animation-delay: 0.2s; }
        .gps-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.04); }
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            15% { transform: scale(1.08); }
            30% { transform: scale(1); }
            45% { transform: scale(1.06); }
            60% { transform: scale(1); }
        }

        .sidebar, .profile-overlay, .tech-settings-overlay, .chat-overlay {
            position: fixed;
            inset: 0;
            background: #0d1117;
            z-index: 200;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .sidebar {
            width: 280px;
            transform: translateX(-100%);
            border-right: 1px solid rgba(48, 54, 61, 0.5);
        }

        .sidebar.active, .profile-overlay.active, 
        .tech-settings-overlay.active, .chat-overlay.active {
            transform: translateX(0);
        }

        .overlay-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 150;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .overlay-backdrop.active {
            opacity: 1;
            pointer-events: all;
        }

        .sidebar-header, .profile-header, .tech-settings-header, .chat-header {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 20px;
            background: rgba(22, 27, 34, 0.95);
            border-bottom: 1px solid rgba(48, 54, 61, 0.5);
        }

        .sidebar-header h2, .profile-header h2, .tech-settings-header h2 {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
            color: #f0f6fc;
            margin: 0;
        }

        .sidebar-content, .profile-content, .tech-settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px 0;
        }

        .sidebar-item {
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            color: #c9d1d9;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .sidebar-item:hover {
            background: rgba(48, 54, 61, 0.3);
        }

        .sidebar-item svg {
            width: 22px;
            height: 22px;
            color: #8b949e;
        }

        .profile-content { padding: 24px 20px; }

        .profile-avatar-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 28px;
        }

        .profile-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid rgba(88, 166, 255, 0.3);
            object-fit: cover;
            margin-bottom: 16px;
        }

        .profile-name {
            font-size: 24px;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 4px;
        }

        .profile-bio {
            color: #8b949e;
            text-align: center;
            font-size: 14px;
        }

        .profile-section { margin-bottom: 24px; }

        .profile-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #8b949e;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .profile-field {
            background: rgba(22, 27, 34, 0.6);
            border: 1px solid rgba(48, 54, 61, 0.4);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .profile-field-label { color: #8b949e; font-size: 14px; }
        .profile-field-value { color: #f0f6fc; font-size: 14px; font-weight: 500; }

        /* INBOX PANEL - Nueva estructura */
        .inbox-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0d1117;
            z-index: 200;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            padding-top: 10px;
        }
        
        .inbox-panel.active {
            transform: translateX(0);
        }

        .inbox-stories {
            display: flex;
            gap: 16px;
            padding: 12px 16px 16px 16px;
            overflow-x: auto;
            border-bottom: 1px solid rgba(48, 54, 61, 0.5);
            align-items: flex-end;
        }
        
        .inbox-stories::-webkit-scrollbar { display: none; }
        .inbox-stories { scrollbar-width: none; }

        .inbox-story-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 75px;
            cursor: pointer;
            position: relative;
        }

        .inbox-bubble {
            background: #3a3a3a;
            color: #e0e0e0;
            padding: 6px 10px;
            border-radius: 14px;
            font-size: 11px;
            white-space: nowrap;
            max-width: 90px;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: -12px;
            z-index: 2;
        }

        .inbox-story-ring {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            padding: 3px;
            background: #404040;
        }
        
        .inbox-story-ring.has-story {
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
        }
        
        .inbox-story-ring.has-unread {
            background: linear-gradient(45deg, #f7d046, #ffb347, #f7d046);
        }

        .inbox-story-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #0d1117;
        }

        .inbox-add-btn {
            position: absolute;
            bottom: 26px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: #38bd62;
            border-radius: 50%;
            border: 2px solid #0d1117;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 14px;
            font-weight: bold;
        }

        .inbox-story-name {
            font-size: 11px;
            color: #e6edf3;
            margin-top: 6px;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
        }

        .inbox-tabs-bar {
            display: flex;
            border-bottom: 1px solid rgba(48, 54, 61, 0.5);
        }

        .inbox-tab-btn {
            flex: 1;
            padding: 14px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #8b949e;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .inbox-tab-btn.active {
            color: #f0f6fc;
            border-bottom-color: #f0f6fc;
        }

        .inbox-conversations {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .inbox-no-chats {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
            color: #6e7681;
        }

        .inbox-conv-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
        }

        .inbox-conv-item:active {
            background: rgba(255,255,255,0.05);
        }

        .inbox-conv-avatar-wrap {
            position: relative;
        }

        .inbox-conv-avatar {
            width: 54px;
            height: 54px;
            border-radius: 50%;
            object-fit: cover;
        }

        .inbox-conv-online {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            background: #38bd62;
            border: 3px solid #0d1117;
            border-radius: 50%;
        }

        .inbox-conv-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .inbox-conv-name {
            font-size: 15px;
            font-weight: 600;
            color: #f0f6fc;
        }

        .inbox-conv-preview {
            font-size: 13px;
            color: #8b949e;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .inbox-conv-dist {
            font-size: 12px;
            color: #38bd62;
        }

        .tech-settings-content { padding: 20px; }

        .tech-mode-selector { margin-bottom: 30px; }

        .tech-mode-selector h3, .tech-list h3 {
            font-size: 14px;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 12px;
            text-transform: uppercase;
        }

        .tech-mode-options { display: flex; gap: 12px; }

        .tech-mode-option {
            flex: 1;
            padding: 12px;
            background: rgba(22, 27, 34, 0.5);
            border: 2px solid rgba(48, 54, 61, 0.5);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
        }

        .tech-mode-option.active {
            background: rgba(56, 189, 98, 0.15);
            border-color: rgba(56, 189, 98, 0.6);
        }

        .tech-mode-option .icon { font-size: 24px; margin-bottom: 6px; }
        .tech-mode-option .label { font-size: 12px; font-weight: 600; color: #c9d1d9; }
        .tech-mode-option.active .label { color: #38bd62; }
        .tech-mode-option .description { font-size: 10px; color: #8b949e; margin-top: 4px; }

        .tech-list { margin-top: 20px; }

        .tech-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: rgba(22, 27, 34, 0.5);
            border: 1px solid rgba(48, 54, 61, 0.5);
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .tech-item.disabled { opacity: 0.5; pointer-events: none; }
        .tech-item-info { flex: 1; }

        .tech-item-name {
            font-size: 15px;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tech-item-icon { font-size: 18px; }
        .tech-item-description { font-size: 12px; color: #8b949e; }

        .tech-toggle {
            position: relative;
            width: 50px;
            height: 28px;
            background: rgba(139, 148, 158, 0.3);
            border-radius: 14px;
            cursor: pointer;
        }

        .tech-toggle.active { background: rgba(56, 189, 98, 0.5); }

        .tech-toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: #8b949e;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .tech-toggle.active::after { left: 25px; background: #38bd62; }

        .preferences-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .preferences-overlay.active { opacity: 1; visibility: visible; }

        .preferences-container {
            background: #161b22;
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid rgba(48, 54, 61, 0.5);
        }

        .preferences-header {
            padding: 20px;
            border-bottom: 1px solid rgba(48, 54, 61, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: #161b22;
            z-index: 10;
        }

        .preferences-header h2 { margin: 0; font-size: 18px; color: #e6edf3; }

        .preferences-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(139, 148, 158, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .preferences-close svg { width: 18px; height: 18px; color: #8b949e; }

        .preferences-section {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(48, 54, 61, 0.3);
        }

        .preferences-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #8b949e;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .preferences-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .preferences-label { font-size: 14px; color: #e6edf3; }

        .preferences-select {
            background: #21262d;
            border: 1px solid rgba(48, 54, 61, 0.5);
            border-radius: 8px;
            padding: 8px 12px;
            color: #e6edf3;
            font-size: 14px;
            outline: none;
            min-width: 120px;
        }

        .preferences-input {
            background: #21262d;
            border: 1px solid rgba(48, 54, 61, 0.5);
            border-radius: 8px;
            padding: 8px 12px;
            color: #e6edf3;
            font-size: 14px;
            outline: none;
            width: 70px;
            text-align: center;
        }

        .age-range-container { display: flex; align-items: center; gap: 8px; }
        .age-range-separator { color: #8b949e; }

        .interests-grid { display: flex; flex-wrap: wrap; gap: 8px; }

        .interest-chip {
            padding: 8px 14px;
            background: #21262d;
            border: 1px solid rgba(48, 54, 61, 0.5);
            border-radius: 20px;
            font-size: 13px;
            color: #8b949e;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .interest-chip.selected {
            background: rgba(56, 189, 98, 0.2);
            border-color: #38bd62;
            color: #38bd62;
        }

        .looking-for-grid { display: flex; flex-direction: column; gap: 8px; }

        .looking-for-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #21262d;
            border: 1px solid rgba(48, 54, 61, 0.5);
            border-radius: 10px;
            cursor: pointer;
        }

        .looking-for-option.selected {
            background: rgba(56, 189, 98, 0.15);
            border-color: #38bd62;
        }

        .looking-for-checkbox {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid #8b949e;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .looking-for-option.selected .looking-for-checkbox {
            background: #38bd62;
            border-color: #38bd62;
        }

        .looking-for-checkbox svg { width: 14px; height: 14px; color: #fff; opacity: 0; }
        .looking-for-option.selected .looking-for-checkbox svg { opacity: 1; }
        .looking-for-label { font-size: 14px; color: #e6edf3; }

        .preferences-save-btn {
            width: 100%;
            padding: 14px;
            background: #38bd62;
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
        }

        .chat-header { 
            background: #1f2c33; 
            border: none; 
        }

        .chat-user-info { flex: 1; display: flex; align-items: center; gap: 12px; }

        .chat-user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }

        .chat-user-details h3 { font-size: 16px; font-weight: 400; color: #e9edef; margin: 0; }
        .chat-user-details p { font-size: 13px; color: #8696a0; margin: 0; }

        .chat-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: #0b141a;
        }

        .chat-info {
            background: rgba(22, 27, 34, 0.6);
            border: 1px solid rgba(48, 54, 61, 0.3);
            padding: 12px 16px;
            border-radius: 10px;
            color: #8b949e;
            font-size: 13px;
            text-align: center;
        }

        .message {
            max-width: 75%;
            padding: 6px 7px 8px 9px;
            border-radius: 8px;
            font-size: 14.2px;
            line-height: 19px;
            position: relative;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
            margin-bottom: 2px;
        }

        .message.sent {
            background: #005c4b;
            color: #e9edef;
            align-self: flex-end;
            border-radius: 8px 8px 0 8px;
        }

        .message.received {
            background: #1f2c33;
            color: #e9edef;
            align-self: flex-start;
            border-radius: 0 8px 8px 8px;
        }

        .message-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin-left: 8px;
            float: right;
            margin-top: 4px;
        }

        .chat-input-container {
            padding: 5px 8px;
            background: #1f2c33;
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            background: #2a3942;
            border: none;
            border-radius: 20px;
            padding: 10px 12px;
            color: #e9edef;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            outline: none;
        }

        .chat-input::placeholder { color: #8696a0; }

        .chat-send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #00a884;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .chat-send-btn:disabled { background: #182229; }
        .chat-send-btn svg { color: #0b141a; width: 24px; height: 24px; }
        .chat-send-btn:disabled svg { color: #8696a0; }

        .instagram-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9998;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .instagram-modal-backdrop.active { opacity: 1; pointer-events: all; }

        .instagram-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(13, 17, 23, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 20px 20px 0 0;
            padding: 20px;
            z-index: 9999;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .instagram-modal.active { transform: translateY(0); }

        .instagram-modal-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }

        .instagram-modal-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(142, 142, 142, 0.3);
        }

        .instagram-modal-info { flex: 1; }
        .instagram-modal-name { font-size: 16px; font-weight: 600; color: #f0f6fc; margin-bottom: 4px; }
        .instagram-modal-distance { font-size: 14px; color: #8b949e; }
        .instagram-modal-actions { display: flex; gap: 12px; align-items: center; }

        .instagram-modal-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            padding: 12px 20px;
            color: #e6edf3;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            outline: none;
        }

        .instagram-modal-input::placeholder { color: #6e7681; }

        .instagram-modal-send {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #38bd62 0%, #2ea556 100%);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .instagram-modal-send:disabled {
            background: rgba(48, 54, 61, 0.5);
            cursor: not-allowed;
        }

        .instagram-modal-send svg { width: 20px; height: 20px; color: #fff; }
        .instagram-modal-send:disabled svg { color: #6e7681; }

        .story-viewer {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .story-viewer.active { opacity: 1; visibility: visible; }

        .story-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .story-progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            z-index: 10;
        }

        .story-progress-fill {
            height: 100%;
            background: #fff;
            animation: storyProgress 5s linear forwards;
        }

        @keyframes storyProgress {
            from { width: 0%; }
            to { width: 100%; }
        }

        .story-header {
            position: absolute;
            top: 16px;
            left: 16px;
            right: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }

        .story-user-info { display: flex; align-items: center; gap: 12px; }

        .story-user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #fff;
            object-fit: cover;
        }

        .story-user-name {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .story-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .story-close svg { width: 20px; height: 20px; color: #fff; }

        .story-image { max-width: 100%; max-height: 100%; object-fit: contain; }

        .story-reactions {
            position: absolute;
            bottom: 110px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 11;
        }

        .story-reaction-btn {
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
            transition: transform 0.15s ease;
        }

        .story-reaction-btn:hover { transform: scale(1.1); }

        /* Emoji burst animation */
        .emoji-burst-container {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 10000;
            overflow: hidden;
        }
        
        .emoji-bubble {
            position: absolute;
            font-size: 32px;
            animation: emojiBurst 1.5s ease-out forwards;
            opacity: 0;
        }
        
        @keyframes emojiBurst {
            0% {
                opacity: 1;
                transform: translateY(0) scale(0.5) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: translateY(-200px) scale(1.2) rotate(15deg);
            }
            100% {
                opacity: 0;
                transform: translateY(-400px) scale(0.8) rotate(-10deg);
            }
        }

        .story-message-btn {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            padding: 14px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50px;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            z-index: 11;
        }

        .story-upload-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 300;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .story-upload-overlay.active { display: flex; }

        .story-upload-container {
            width: 100%;
            max-width: 500px;
            background: #161b22;
            border-radius: 16px;
            padding: 24px;
        }

        .story-upload-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .story-upload-header h2 { font-size: 20px; font-weight: 600; color: #f0f6fc; margin: 0; }

        .story-upload-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
        }

        .story-upload-close svg { width: 20px; height: 20px; color: #8b949e; }

        .story-preview-area {
            width: 100%;
            aspect-ratio: 9/16;
            max-height: 60vh;
            background: #0d1117;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
        }

        .story-preview-area img { width: 100%; height: 100%; object-fit: cover; }

        .story-preview-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            color: #6e7681;
        }

        .story-preview-placeholder svg { width: 64px; height: 64px; }

        .story-upload-actions { display: flex; gap: 12px; }

        .story-select-btn, .story-publish-btn {
            flex: 1;
            height: 48px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .story-select-btn {
            background: rgba(56, 189, 98, 0.15);
            color: #38bd62;
            border: 1px solid rgba(56, 189, 98, 0.3);
        }

        .story-publish-btn {
            background: linear-gradient(135deg, #38bd62 0%, #2d9d51 100%);
            color: #fff;
        }

        .story-publish-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .story-remove-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .story-remove-btn svg { width: 20px; height: 20px; color: #fff; }

        .social-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(22, 27, 34, 0.98);
            border: 1px solid rgba(56, 189, 98, 0.3);
            border-radius: 16px;
            padding: 16px 20px;
            max-width: 340px;
            width: calc(100% - 40px);
            z-index: 9998;
            backdrop-filter: blur(10px);
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-50%) translateY(-30px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .social-notification-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }

        .social-notification-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 2px solid rgba(56, 189, 98, 0.5);
            object-fit: cover;
        }

        .social-notification-info { flex: 1; }
        .social-notification-name { font-size: 15px; font-weight: 600; color: #f0f6fc; margin-bottom: 2px; }
        .social-notification-distance { font-size: 13px; color: #8b949e; }
        .social-notification-message { font-size: 14px; color: #c9d1d9; line-height: 1.5; margin-bottom: 12px; }
        .social-notification-actions { display: flex; gap: 8px; }

        .social-notification-btn {
            flex: 1;
            height: 38px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .social-notification-btn-primary {
            background: linear-gradient(135deg, #38bd62 0%, #2d9d51 100%);
            color: #fff;
        }

        .social-notification-btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: #8b949e;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .social-notification-close {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .social-notification-close svg { width: 14px; height: 14px; color: #8b949e; }

        @keyframes magnetPull {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.15); opacity: 1; }
            80% { transform: scale(0.95); }
            100% { transform: scale(1); opacity: 1; }
        }

        .avatar-entering {
            animation: magnetPull 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        html { overscroll-behavior: none; }

        .emoji-picker {
            position: absolute;
            bottom: 60px;
            left: 0px;
            background: rgba(30, 35, 42, 0.98);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            padding: 8px 12px;
            display: flex;
            gap: 8px;
            border: 1px solid rgba(56, 189, 98, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            transform: scale(0) translateY(10px);
            opacity: 0;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: bottom left;
            z-index: 9999;
            pointer-events: none;
        }

        .emoji-picker.active {
            transform: scale(1) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .emoji-picker-item {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.15s ease;
            background: transparent;
        }

        .emoji-picker-item:hover {
            background: rgba(56, 189, 98, 0.2);
            transform: scale(1.15);
        }

        .emoji-picker-item:active {
            transform: scale(0.95);
        }

        @keyframes emojiBubbleFloat {
            0% {
                transform: translateY(0) scale(0);
                opacity: 0;
            }
            15% {
                transform: translateY(-5px) scale(1.2);
                opacity: 1;
            }
            30% {
                transform: translateY(-15px) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-60px) scale(0.6);
                opacity: 0;
            }
        }

        .emoji-bubble {
            position: absolute;
            font-size: 16px;
            pointer-events: none;
            animation: emojiBubbleFloat 3s ease-out forwards;
            z-index: 100;
        }

        .emoji-bubble:nth-child(1) { animation-delay: 0s; }
        .emoji-bubble:nth-child(2) { animation-delay: 0.15s; }
        .emoji-bubble:nth-child(3) { animation-delay: 0.3s; }
        .emoji-bubble:nth-child(4) { animation-delay: 0.45s; }
        .emoji-bubble:nth-child(5) { animation-delay: 0.6s; }
        .emoji-bubble:nth-child(6) { animation-delay: 0.75s; }
        .emoji-bubble:nth-child(7) { animation-delay: 0.9s; }
        .emoji-bubble:nth-child(8) { animation-delay: 1.05s; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyAhcfX0M5oqX7rZ6WdCZaHfxHKcxySxQl8",
            authDomain: "radar-social-5a61f.firebaseapp.com",
            projectId: "radar-social-5a61f",
            storageBucket: "radar-social-5a61f.firebasestorage.app",
            messagingSenderId: "1010787643000",
            appId: "1:1010787643000:web:e9dc6a1c175d875b90478d"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        function RadarSocialApp() {
            const [radius, setRadius] = useState(1000);
            const [thought, setThought] = useState('');
            const [currentUser, setCurrentUser] = useState(null);
            const [userLocation, setUserLocation] = useState(null);
            const [users, setUsers] = useState([]);
            const [markerRefreshTick, setMarkerRefreshTick] = useState(0);
            const [selectedUser, setSelectedUser] = useState(null);
            const [showInstagramModal, setShowInstagramModal] = useState(false);
            const [instagramModalUser, setInstagramModalUser] = useState(null);
            const [quickMessage, setQuickMessage] = useState('');
            const [messages, setMessages] = useState({});
            const [messageInput, setMessageInput] = useState('');
            const [showSidebar, setShowSidebar] = useState(false);
            const [showProfile, setShowProfile] = useState(false);
            const [showInbox, setShowInbox] = useState(false);
            const [showTechSettings, setShowTechSettings] = useState(false);
            const [showStoryUpload, setShowStoryUpload] = useState(false);
            const [storyImage, setStoryImage] = useState(null);
            const [uploadingStory, setUploadingStory] = useState(false);
            const [viewingStory, setViewingStory] = useState(null);
            const [emojiBurst, setEmojiBurst] = useState(null);
            const [viewedStories, setViewedStories] = useState({});
            const [socialNotifications, setSocialNotifications] = useState([]);
            const [googleMap, setGoogleMap] = useState(null);
            const [waitingForGPS, setWaitingForGPS] = useState(false);
            const [locationAccuracy, setLocationAccuracy] = useState(20);
            const [isDraggingDial, setIsDraggingDial] = useState(false);
            const [inboxTab, setInboxTab] = useState('messages');
            const [favoriteUsers, setFavoriteUsers] = useState([]);
            const [initialLoadComplete, setInitialLoadComplete] = useState(false);
            const [knownUserIds, setKnownUserIds] = useState(new Set());
            const [unreadMessages, setUnreadMessages] = useState({});
            const [totalUnread, setTotalUnread] = useState(0);
            const [showPreferences, setShowPreferences] = useState(false);
            const [showEmojiPicker, setShowEmojiPicker] = useState(false);
            const [currentEmoji, setCurrentEmoji] = useState(null);
            const [emojiTimestamp, setEmojiTimestamp] = useState(null);
            
            const [userPreferences, setUserPreferences] = useState({
                age: 25, gender: '', interests: [], lookingFor: [],
                ageRangeMin: 18, ageRangeMax: 50, genderPreference: 'all'
            });
            
            const availableInterests = [
                { id: 'gym', label: 'üèãÔ∏è Gym', emoji: 'üèãÔ∏è' },
                { id: 'coffee', label: '‚òï Caf√©', emoji: '‚òï' },
                { id: 'party', label: 'üéâ Fiesta', emoji: 'üéâ' },
                { id: 'reading', label: 'üìö Lectura', emoji: 'üìö' },
                { id: 'gaming', label: 'üéÆ Gaming', emoji: 'üéÆ' },
                { id: 'music', label: 'üéµ M√∫sica', emoji: 'üéµ' },
                { id: 'travel', label: '‚úàÔ∏è Viajes', emoji: '‚úàÔ∏è' },
                { id: 'food', label: 'üçï Comida', emoji: 'üçï' },
                { id: 'sports', label: '‚öΩ Deportes', emoji: '‚öΩ' },
                { id: 'art', label: 'üé® Arte', emoji: 'üé®' },
                { id: 'movies', label: 'üé¨ Cine', emoji: 'üé¨' },
                { id: 'nature', label: 'üåø Naturaleza', emoji: 'üåø' },
                { id: 'tech', label: 'üíª Tecnolog√≠a', emoji: 'üíª' },
                { id: 'pets', label: 'üêï Mascotas', emoji: 'üêï' },
                { id: 'yoga', label: 'üßò Yoga', emoji: 'üßò' },
                { id: 'dance', label: 'üíÉ Baile', emoji: 'üíÉ' }
            ];
            
            const lookingForOptions = [
                { id: 'friendship', label: 'üëã Amistad', emoji: 'üëã' },
                { id: 'casual', label: 'üòä Conexi√≥n casual', emoji: 'üòä' },
                { id: 'networking', label: 'üíº Networking', emoji: 'üíº' },
                { id: 'romance', label: '‚ù§Ô∏è Romance', emoji: '‚ù§Ô∏è' }
            ];
            
            const reactionEmojis = ['üî•', '‚ù§Ô∏è', 'üëã'];
            
            const userPositionHistory = useRef({});
            const notificationSound = useRef(null);
            
            const [techSettings, setTechSettings] = useState({
                mode: 'auto', gps: true, kalman: true, ble: true
            });
            const [activeTech, setActiveTech] = useState({ name: 'GPS', icon: 'üìç', precision: 5.0 });
            const [bleSupported, setBleSupported] = useState(false);
            
            const mapRef = useRef(null);
            const chatMessagesRef = useRef(null);
            const markersRef = useRef({});
            const lastMarkersDataRef = useRef('');
            const lastTickRef = useRef(0);
            const currentUserPositionRef = useRef({ lat: 0, lng: 0 });
            
            const kalmanState = useRef({
                lat: { x: 0, p: 1, q: 0.00001, r: 0.001 },
                lng: { x: 0, p: 1, q: 0.00001, r: 0.001 }
            });
            
            const calculateMovement = (userId, currentLat, currentLng) => {
                const history = userPositionHistory.current[userId] || [];
                const now = Date.now();
                history.push({ lat: currentLat, lng: currentLng, timestamp: now });
                if (history.length > 5) history.shift();
                userPositionHistory.current[userId] = history;
                if (history.length < 2) return { speed: 0, direction: 0, approaching: null };
                const oldest = history[0];
                const newest = history[history.length - 1];
                const timeDiff = (newest.timestamp - oldest.timestamp) / 1000;
                if (timeDiff < 1) return { speed: 0, direction: 0, approaching: null };
                const distance = calculateDistance(oldest.lat, oldest.lng, newest.lat, newest.lng);
                const speedKmh = (distance / timeDiff) * 3.6;
                return { speed: speedKmh, direction: 0, approaching: null };
            };
            
            const isApproaching = (userId, userLat, userLng, myLat, myLng) => {
                const history = userPositionHistory.current[userId] || [];
                if (history.length < 2) return null;
                const oldest = history[0];
                const newest = history[history.length - 1];
                const oldDistance = calculateDistance(oldest.lat, oldest.lng, myLat, myLng);
                const newDistance = calculateDistance(newest.lat, newest.lng, myLat, myLng);
                const diff = oldDistance - newDistance;
                if (Math.abs(diff) < 5) return null;
                return diff > 0;
            };
            
            useEffect(() => {
                // Habilitar AudioContext con interacci√≥n del usuario
                const enableAudio = () => {
                    try {
                        const ctx = new (window.AudioContext || window.webkitAudioContext)();
                        ctx.resume();
                        notificationSound.current = () => {
                            try {
                                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                                const osc = audioCtx.createOscillator();
                                const gain = audioCtx.createGain();
                                osc.connect(gain);
                                gain.connect(audioCtx.destination);
                                osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                                osc.frequency.setValueAtTime(660, audioCtx.currentTime + 0.1);
                                osc.type = 'sine';
                                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                                osc.start(audioCtx.currentTime);
                                osc.stop(audioCtx.currentTime + 0.4);
                            } catch(e) { console.log('Error playing sound:', e); }
                        };
                    } catch(e) {}
                };
                document.addEventListener('touchstart', enableAudio, { once: true });
                document.addEventListener('click', enableAudio, { once: true });
                enableAudio();
            }, []);
            
            useEffect(() => {
                setBleSupported('bluetooth' in navigator);
            }, []);
            
            const applyKalmanFilter = (measurement, state) => {
                const p_pred = state.p + state.q;
                const k = p_pred / (p_pred + state.r);
                return { x: state.x + k * (measurement - state.x), p: (1 - k) * p_pred, q: state.q, r: state.r };
            };
            
            const filterGPSWithKalman = (lat, lng, accuracy) => {
                if (kalmanState.current.lat.x === 0) {
                    kalmanState.current.lat.x = lat;
                    kalmanState.current.lng.x = lng;
                    return { lat, lng };
                }
                const r = Math.max(0.0001, accuracy / 100000);
                kalmanState.current.lat.r = r;
                kalmanState.current.lng.r = r;
                kalmanState.current.lat = applyKalmanFilter(lat, kalmanState.current.lat);
                kalmanState.current.lng = applyKalmanFilter(lng, kalmanState.current.lng);
                return { lat: kalmanState.current.lat.x, lng: kalmanState.current.lng.x };
            };

            const calculateDistance = (lat1, lon1, lat2, lon2) => {
                const R = 6371e3;
                const œÜ1 = lat1 * Math.PI / 180;
                const œÜ2 = lat2 * Math.PI / 180;
                const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
                const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(ŒîœÜ / 2) ** 2 + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) ** 2;
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            };

            const getInitialLocation = () => {
                return new Promise((resolve) => {
                    let attempts = 0;
                    const tryGetLocation = () => {
                        navigator.geolocation.getCurrentPosition(
                            (pos) => {
                                if (pos.coords.accuracy < 50 || attempts >= 5) {
                                    resolve({ latitude: pos.coords.latitude, longitude: pos.coords.longitude, accuracy: pos.coords.accuracy });
                                } else { attempts++; setTimeout(tryGetLocation, 1000); }
                            },
                            () => { attempts++; if (attempts < 5) setTimeout(tryGetLocation, 1000); else resolve(null); },
                            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                        );
                    };
                    tryGetLocation();
                });
            };

            const FIXED_ZOOM = 15;
            
            const initializeGoogleMap = (lat, lng) => {
                if (!mapRef.current || googleMap) return;
                currentUserPositionRef.current = { lat, lng };
                const darkStyle = [
                    { elementType: 'geometry', stylers: [{ color: '#1a1f26' }] },
                    { elementType: 'labels.text.stroke', stylers: [{ color: '#1a1f26' }] },
                    { elementType: 'labels.text.fill', stylers: [{ color: '#9ca3af' }] },
                    { featureType: 'poi', stylers: [{ visibility: 'off' }] },
                    { featureType: 'transit', stylers: [{ visibility: 'off' }] },
                    { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#2d3748' }] },
                    { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#6b7280' }] },
                    { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0f1820' }] }
                ];
                const map = new google.maps.Map(mapRef.current, {
                    center: { lat, lng }, zoom: FIXED_ZOOM, minZoom: FIXED_ZOOM, maxZoom: FIXED_ZOOM,
                    styles: darkStyle, disableDefaultUI: true, zoomControl: false,
                    gestureHandling: 'greedy', clickableIcons: false
                });
                map.addListener('zoom_changed', () => { if (map.getZoom() !== FIXED_ZOOM) map.setZoom(FIXED_ZOOM); });
                map.addListener('dragend', () => {
                    const center = map.getCenter();
                    const userPos = currentUserPositionRef.current;
                    const distance = calculateDistance(userPos.lat, userPos.lng, center.lat(), center.lng());
                    if (distance > 1000) {
                        const bearing = Math.atan2(center.lng() - userPos.lng, center.lat() - userPos.lat);
                        map.panTo({ lat: userPos.lat + (0.009 * Math.cos(bearing)), lng: userPos.lng + (0.009 * Math.sin(bearing)) });
                    }
                });
                setGoogleMap(map);
            };

            const createUserMarker = (user, map, size, isCurrentUser = false, isOrbital = true, orbitalIndex = -1) => {
                const markerDiv = document.createElement('div');
                markerDiv.style.cssText = 'display:flex;flex-direction:column;align-items:center;cursor:pointer;position:relative;';
                
                const isRightSide = orbitalIndex >= 0 && orbitalIndex <= 3;
                const isExplorer = !isOrbital && !isCurrentUser;
                
                if (user.thought && user.thought.trim()) {
                    const bubbleContainer = document.createElement('div');
                    if (isCurrentUser) {
                        bubbleContainer.style.cssText = 'position:absolute;top:-3px;left:-45px;display:flex;flex-direction:column;align-items:flex-end;z-index:10;';
                    } else if (isOrbital && isRightSide) {
                        bubbleContainer.style.cssText = `position:absolute;top:0px;left:${size-8}px;display:flex;flex-direction:column;align-items:flex-start;z-index:10;`;
                    } else {
                        bubbleContainer.style.cssText = `position:absolute;top:0px;right:${size-8}px;display:flex;flex-direction:column;align-items:flex-end;z-index:10;`;
                    }
                    const thoughtBubble = document.createElement('div');
                    thoughtBubble.style.cssText = `background:#3a3a3a;color:#e0e0e0;padding:${isExplorer?'2px 4px':'4px 6px'};border-radius:${isExplorer?'6px':'9px'};font-size:${isExplorer?'6px':'8px'};white-space:nowrap;`;
                    thoughtBubble.textContent = user.thought;
                    bubbleContainer.appendChild(thoughtBubble);
                    
                    const circlesContainer = document.createElement('div');
                    circlesContainer.style.cssText = isCurrentUser ? 'display:flex;flex-direction:column;align-items:flex-end;margin-top:1px;margin-right:-5px;' :
                        (isOrbital && isRightSide ? 'display:flex;flex-direction:column;align-items:flex-start;margin-top:1px;margin-left:-3px;' : 
                        'display:flex;flex-direction:column;align-items:flex-end;margin-top:1px;margin-right:-3px;');
                    const c1 = document.createElement('div');
                    c1.style.cssText = `width:${isExplorer?3:4}px;height:${isExplorer?3:4}px;background:#3a3a3a;border-radius:50%;margin-bottom:1px;`;
                    const c2 = document.createElement('div');
                    c2.style.cssText = 'width:2px;height:2px;background:#3a3a3a;border-radius:50%;';
                    circlesContainer.appendChild(c1);
                    circlesContainer.appendChild(c2);
                    bubbleContainer.appendChild(circlesContainer);
                    markerDiv.appendChild(bubbleContainer);
                }
                
                const avatarContainer = document.createElement('div');
                const userUnreadCount = !isCurrentUser ? (unreadMessages[user.id] || 0) : 0;
                const hasUnseenStory = user.hasStory && !viewedStories[user.id];
                
                let breatheAnimation = (userUnreadCount > 0 || hasUnseenStory) ? 
                    'animation:heartbeat 2s ease-in-out infinite;' : 'animation:breathe 3s ease-in-out infinite;';
                avatarContainer.style.cssText = `width:${size}px;height:${size}px;position:relative;${breatheAnimation}animation-delay:${(Math.random()*2).toFixed(1)}s;`;
                
                const ring = document.createElement('div');
                let ringStyle = userUnreadCount > 0 ? 'background:linear-gradient(45deg,#f7d046,#ffb347,#f7d046);' :
                    (hasUnseenStory ? 'background:linear-gradient(45deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);' : 'background:#404040;');
                ring.style.cssText = `position:absolute;width:100%;height:100%;border-radius:50%;${ringStyle}display:flex;align-items:center;justify-content:center;`;
                
                const innerContainer = document.createElement('div');
                const ringThickness = isExplorer ? 4 : 6;
                const innerSize = size - ringThickness;
                innerContainer.style.cssText = `width:${innerSize}px;height:${innerSize}px;border-radius:50%;background:#0d1117;display:flex;align-items:center;justify-content:center;`;
                
                const avatarImg = document.createElement('img');
                avatarImg.src = user.photo;
                const imgSize = innerSize - (isExplorer ? 2 : 4);
                avatarImg.style.cssText = `width:${imgSize}px;height:${imgSize}px;border-radius:50%;object-fit:cover;`;
                
                innerContainer.appendChild(avatarImg);
                ring.appendChild(innerContainer);
                avatarContainer.appendChild(ring);
                
                if (userUnreadCount > 0) {
                    const badge = document.createElement('div');
                    const badgeSize = isExplorer ? 12 : 18;
                    badge.style.cssText = `position:absolute;bottom:-2px;right:-2px;min-width:${badgeSize}px;height:${badgeSize}px;background:linear-gradient(135deg,#ff6b35,#f7931e);border-radius:${badgeSize/2}px;border:${isExplorer?1:2}px solid #0d1117;display:flex;align-items:center;justify-content:center;font-size:${isExplorer?7:10}px;font-weight:700;color:#fff;padding:0 ${isExplorer?2:4}px;`;
                    badge.textContent = userUnreadCount > 9 ? '9+' : userUnreadCount;
                    avatarContainer.appendChild(badge);
                }
                
                markerDiv.appendChild(avatarContainer);
                
                // Emoji bubbles animation
                const activeEmoji = isCurrentUser ? currentEmoji : user.currentEmoji;
                if (activeEmoji) {
                    const bubblesContainer = document.createElement('div');
                    bubblesContainer.style.cssText = 'position:absolute;top:0;left:50%;transform:translateX(-50%);pointer-events:none;';
                    const positions = [-12, -6, 0, 6, 12, -9, 3, 9];
                    for (let i = 0; i < 8; i++) {
                        const bubble = document.createElement('div');
                        bubble.className = 'emoji-bubble';
                        bubble.style.left = `${positions[i]}px`;
                        bubble.textContent = activeEmoji;
                        bubblesContainer.appendChild(bubble);
                    }
                    markerDiv.appendChild(bubblesContainer);
                }
                
                if (!isCurrentUser) {
                    const nameLabel = document.createElement('div');
                    nameLabel.style.cssText = `margin-top:${isExplorer?1:2}px;background:rgba(0,0,0,0.65);padding:${isExplorer?'1px 4px':'2px 5px'};border-radius:999px;font-size:${isExplorer?6:7}px;font-weight:500;color:#fff;white-space:nowrap;`;
                    nameLabel.textContent = user.distance ? `${user.name.split(' ')[0]} / ${user.distance}m` : user.name.split(' ')[0];
                    markerDiv.appendChild(nameLabel);
                }
                
                markerDiv.addEventListener('click', () => handleAvatarClick(user));
                markerDiv.style.opacity = '0';
                markerDiv.style.transition = 'opacity 0.15s ease';
                
                class CustomMarker extends google.maps.OverlayView {
                    constructor(position, content) {
                        super();
                        this.position = position;
                        this.content = content;
                        this.isFirstDraw = true;
                        this.isAnimating = false;
                    }
                    onAdd() { this.getPanes().overlayMouseTarget.appendChild(this.content); }
                    draw() {
                        const pos = this.getProjection().fromLatLngToDivPixel(this.position);
                        if (pos) {
                            this.content.style.position = 'absolute';
                            const width = this.content.offsetWidth || 70;
                            const height = this.content.offsetHeight || 100;
                            if (this.isFirstDraw) {
                                this.isFirstDraw = false;
                                this.content.style.transition = 'none';
                                requestAnimationFrame(() => {
                                    requestAnimationFrame(() => {
                                        this.content.style.left = (pos.x - width/2) + 'px';
                                        this.content.style.top = (pos.y - height) + 'px';
                                        this.content.style.opacity = '1';
                                    });
                                });
                            } else if (this.isAnimating) {
                                this.content.style.transition = 'left 1s ease-out, top 1s ease-out';
                                this.content.style.left = (pos.x - width/2) + 'px';
                                this.content.style.top = (pos.y - height) + 'px';
                                setTimeout(() => { this.isAnimating = false; this.content.style.transition = 'none'; }, 1000);
                            } else {
                                this.content.style.transition = 'none';
                                this.content.style.left = (pos.x - width/2) + 'px';
                                this.content.style.top = (pos.y - height) + 'px';
                            }
                        }
                    }
                    updatePosition(newLat, newLng) {
                        this.isAnimating = true;
                        this.position = new google.maps.LatLng(newLat, newLng);
                        this.draw();
                    }
                    onRemove() { if (this.content.parentElement) this.content.parentElement.removeChild(this.content); }
                }
                
                const lat = user.displayLat || user.latitude;
                const lng = user.displayLng || user.longitude;
                const marker = new CustomMarker(new google.maps.LatLng(lat, lng), markerDiv);
                marker.setMap(map);
                return marker;
            };
            
            const getOrbitalPosition = (centerLat, centerLng, index, totalSlots = 8) => {
                const orbitRadius = 0.00207;
                const angle = (index * (360 / totalSlots)) * (Math.PI / 180);
                const latCorrection = Math.cos(centerLat * Math.PI / 180);
                return { 
                    lat: centerLat + (orbitRadius * Math.cos(angle)), 
                    lng: centerLng + (orbitRadius * Math.sin(angle)) / latCorrection 
                };
            };
            
            const removeMarker = (userId) => {
                if (markersRef.current[userId]) {
                    if (markersRef.current[userId].marker?.setMap) markersRef.current[userId].marker.setMap(null);
                    delete markersRef.current[userId];
                }
            };

            // Auth effect
            useEffect(() => {
                console.log('üöÄ RADAR SOCIAL v7.7.6 - Color #1a1f26 aplicado');
                const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
                    if (firebaseUser) {
                        const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                        let thought = '', hasActiveStory = false, storyUrl = null, storyTimestamp = null;
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            if (userData.thought && userData.thoughtTimestamp) {
                                const ts = userData.thoughtTimestamp.toMillis ? userData.thoughtTimestamp.toMillis() : userData.thoughtTimestamp;
                                if ((Date.now() - ts) / 3600000 < 24) { thought = userData.thought; window.lastThoughtTimestamp = ts; }
                            }
                            if (userData.storyUrl && userData.storyTimestamp) {
                                const ts = userData.storyTimestamp.toMillis ? userData.storyTimestamp.toMillis() : userData.storyTimestamp;
                                if ((Date.now() - ts) / 3600000 < 12) { hasActiveStory = true; storyUrl = userData.storyUrl; storyTimestamp = ts; }
                            }
                            if (userData.preferences) setUserPreferences(userData.preferences);
                        }
                        const initialUser = {
                            id: firebaseUser.uid, name: firebaseUser.displayName || 'Usuario',
                            photo: firebaseUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(firebaseUser.displayName || 'User')}&background=38bd62&color=fff&size=150`,
                            thought, hasStory: hasActiveStory, storyUrl, storyTimestamp,
                            email: firebaseUser.email, latitude: 0, longitude: 0, isOnline: true
                        };
                        setCurrentUser(initialUser);
                        await db.collection('users').doc(firebaseUser.uid).set({
                            uid: firebaseUser.uid, displayName: firebaseUser.displayName, email: firebaseUser.email,
                            photoURL: firebaseUser.photoURL, isOnline: true,
                            lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                            location: new firebase.firestore.GeoPoint(0, 0), pendingGPS: true
                        }, { merge: true });
                        
                        if ('geolocation' in navigator) {
                            const location = await getInitialLocation();
                            if (location) {
                                setUserLocation({ latitude: location.latitude, longitude: location.longitude });
                                setCurrentUser(prev => ({ ...prev, latitude: location.latitude, longitude: location.longitude }));
                                setWaitingForGPS(false);
                                await db.collection('users').doc(firebaseUser.uid).update({
                                    location: new firebase.firestore.GeoPoint(location.latitude, location.longitude),
                                    pendingGPS: false, lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                            
                            let usersUnsubscribe = null;
                            let lastUpdateTime = 0;
                            
                            navigator.geolocation.watchPosition(async (position) => {
                                let { latitude, longitude, accuracy } = position.coords;
                                if (accuracy > 100) return;
                                const now = Date.now();
                                if (now - lastUpdateTime < 3000) return;
                                lastUpdateTime = now;
                                
                                if (techSettings.kalman) {
                                    const filtered = filterGPSWithKalman(latitude, longitude, accuracy);
                                    latitude = filtered.lat; longitude = filtered.lng;
                                    accuracy = Math.max(2, accuracy / 2);
                                }
                                
                                setUserLocation({ latitude, longitude });
                                setCurrentUser(prev => ({ ...prev, latitude, longitude }));
                                setLocationAccuracy(accuracy);
                                
                                if (!usersUnsubscribe) {
                                    usersUnsubscribe = db.collection('users').where('isOnline', '==', true).onSnapshot((snapshot) => {
                                        setCurrentUser(currentUserState => {
                                            if (!currentUserState?.latitude) return currentUserState;
                                            const otherUsers = [];
                                            snapshot.forEach((doc) => {
                                                const userData = doc.data();
                                                if (userData.uid === firebaseUser.uid) return;
                                                let isOnline = false;
                                                if (userData.lastSeen) {
                                                    const lastSeenTime = userData.lastSeen.toMillis ? userData.lastSeen.toMillis() : userData.lastSeen;
                                                    isOnline = (Date.now() - lastSeenTime) <= 90000;
                                                }
                                                if (userData.location && isOnline) {
                                                    const userLat = userData.location.latitude;
                                                    const userLon = userData.location.longitude;
                                                    if (userLat !== 0 && userLon !== 0) {
                                                        const distance = Math.round(calculateDistance(currentUserState.latitude, currentUserState.longitude, userLat, userLon));
                                                        let displayThought = '';
                                                        if (userData.thought && userData.thoughtTimestamp) {
                                                            const ts = userData.thoughtTimestamp.toMillis ? userData.thoughtTimestamp.toMillis() : userData.thoughtTimestamp;
                                                            if ((Date.now() - ts) / 3600000 < 24) displayThought = userData.thought;
                                                        }
                                                        let hasActiveStory = false, storyUrl = null, storyTimestamp = null;
                                                        if (userData.storyUrl && userData.storyTimestamp) {
                                                            const ts = userData.storyTimestamp.toMillis ? userData.storyTimestamp.toMillis() : userData.storyTimestamp;
                                                            if ((Date.now() - ts) / 3600000 < 12) { hasActiveStory = true; storyUrl = userData.storyUrl; storyTimestamp = ts; }
                                                        }
                                                        let activeEmoji = null;
                                                        if (userData.currentEmoji && userData.emojiTimestamp) {
                                                            const ets = userData.emojiTimestamp.toMillis ? userData.emojiTimestamp.toMillis() : userData.emojiTimestamp;
                                                            if ((Date.now() - ets) < 3000) activeEmoji = userData.currentEmoji;
                                                        }
                                                        otherUsers.push({
                                                            id: userData.uid, name: userData.displayName || 'Usuario',
                                                            photo: userData.photoURL || 'https://ui-avatars.com/api/?name=User&background=38bd62&color=fff',
                                                            thought: displayThought, hasStory: hasActiveStory, storyUrl, storyTimestamp,
                                                            distance, isOnline: true, latitude: userLat, longitude: userLon,
                                                            preferences: userData.preferences || null,
                                                            currentEmoji: activeEmoji,
                                                            movement: calculateMovement(userData.uid, userLat, userLon),
                                                            approaching: isApproaching(userData.uid, userLat, userLon, currentUserState.latitude, currentUserState.longitude)
                                                        });
                                                    }
                                                }
                                            });
                                            setUsers(otherUsers);
                                            return currentUserState;
                                        });
                                    });
                                }
                                await db.collection('users').doc(firebaseUser.uid).update({
                                    location: new firebase.firestore.GeoPoint(latitude, longitude),
                                    isOnline: true, lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                                    accuracy, pendingGPS: false
                                });
                            }, (error) => console.error('Location error:', error),
                            { enableHighAccuracy: true, timeout: 30000, maximumAge: 10000 });
                        }
                    } else { 
                        // User logged out - clean all states
                        setCurrentUser(null); 
                        setUserLocation(null);
                        setUsers([]);
                        setWaitingForGPS(false);
                        setGoogleMap(null);
                        setSelectedUser(null);
                        setMessages({});
                        setViewedStories({});
                        setUnreadMessages({});
                        setTotalUnread(0);
                        setInitialLoadComplete(false);
                        setKnownUserIds(new Set());
                        // Clear markers
                        Object.keys(markersRef.current).forEach(key => {
                            if (markersRef.current[key]?.marker?.setMap) {
                                markersRef.current[key].marker.setMap(null);
                            }
                        });
                        markersRef.current = {};
                        // Redirect to landing page
                        window.location.href = 'index.html';
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!currentUser?.latitude || currentUser.latitude === 0 || googleMap) return;
                initializeGoogleMap(currentUser.latitude, currentUser.longitude);
            }, [currentUser?.latitude, currentUser?.longitude, googleMap]);

            useEffect(() => {
                if (!currentUser?.id) return;
                console.log('Iniciando listener de mensajes no le√≠dos para:', currentUser.id);
                const unsubscribe = db.collection('chats').where('participants', 'array-contains', currentUser.id).onSnapshot((snapshot) => {
                    const unreadCounts = {};
                    let total = 0;
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const count = data[`unreadCount_${currentUser.id}`] || 0;
                        if (count > 0) {
                            const otherUserId = data.participants?.find(id => id !== currentUser.id);
                            if (otherUserId) {
                                const prev = unreadMessages[otherUserId] || 0;
                                if (count > prev && prev >= 0 && notificationSound.current && initialLoadComplete) {
                                    try { notificationSound.current(); } catch(e) {}
                                }
                                unreadCounts[otherUserId] = count;
                                total += count;
                            }
                        }
                    });
                    console.log('Mensajes no le√≠dos actualizados:', unreadCounts, 'Total:', total);
                    setUnreadMessages(unreadCounts);
                    setTotalUnread(total);
                });
                return () => unsubscribe();
            }, [currentUser?.id, initialLoadComplete]);

            useEffect(() => {
                if (!currentUser?.latitude || currentUser.latitude === 0 || users.length === 0) return;
                setUsers(prev => prev.map(user => ({
                    ...user, distance: Math.round(calculateDistance(currentUser.latitude, currentUser.longitude, user.latitude, user.longitude))
                })));
            }, [currentUser?.latitude, currentUser?.longitude]);

            // v7.5.0 FIX: Update markers - includes viewedStories in signature
            useEffect(() => {
                if (!googleMap || !currentUser?.latitude || currentUser.latitude === 0) return;
                
                const usersInRange = users.filter(u => {
                    if (u.distance > radius || !u.isOnline || u.latitude === 0) return false;
                    if (u.preferences?.age) {
                        if (u.preferences.age < userPreferences.ageRangeMin || u.preferences.age > userPreferences.ageRangeMax) return false;
                    }
                    if (userPreferences.genderPreference !== 'all' && u.preferences?.gender && u.preferences.gender !== userPreferences.genderPreference) return false;
                    const myLF = userPreferences.lookingFor.length > 0;
                    const theirLF = u.preferences?.lookingFor?.length > 0;
                    if (myLF && theirLF && !u.preferences.lookingFor.some(lf => userPreferences.lookingFor.includes(lf))) return false;
                    if ((myLF && !theirLF) || (!myLF && theirLF)) return false;
                    return true;
                }).sort((a, b) => a.distance - b.distance);
                
                // v7.5.0 FIX: Include viewedStories and unreadMessages in signature for instant updates
                const currentDataSignature = JSON.stringify({
                    usersCount: usersInRange.length,
                    userIds: usersInRange.map(u => u.id).join(','),
                    userPositions: usersInRange.map(u => `${u.latitude.toFixed(5)},${u.longitude.toFixed(5)}`).join('|'),
                    userThoughts: usersInRange.map(u => u.thought || '').join('|'),
                    userStories: usersInRange.map(u => u.hasStory ? '1' : '0').join(''),
                    userEmojis: usersInRange.map(u => u.currentEmoji || '').join(''),
                    viewedStoriesState: Object.keys(viewedStories).sort().join(','),
                    unreadMessagesState: Object.entries(unreadMessages).map(([k,v]) => `${k}:${v}`).join(','),
                    currentThought: currentUser.thought || '',
                    currentHasStory: currentUser.hasStory || false,
                    currentEmoji: currentEmoji || '',
                    currentLat: currentUser.latitude.toFixed(5),
                    currentLng: currentUser.longitude.toFixed(5)
                });
                
                const tickChanged = markerRefreshTick !== lastTickRef.current;
                lastTickRef.current = markerRefreshTick;
                if (!tickChanged && currentDataSignature === lastMarkersDataRef.current) return;
                lastMarkersDataRef.current = currentDataSignature;
                
                const activeMarkerIds = new Set();
                const closeUsers = usersInRange.filter(u => u.distance <= 50);
                const farFromOrbit = usersInRange.filter(u => u.distance > 50);
                const orbitUsers = closeUsers.slice(0, 8);
                const closeButNotOrbital = closeUsers.slice(8);
                
                const currentUserId = 'current_user';
                activeMarkerIds.add(currentUserId);
                const existingCurrent = markersRef.current[currentUserId];
                const currentChanged = existingCurrent && (existingCurrent.hasStory !== currentUser.hasStory || existingCurrent.thought !== (currentUser.thought || '') || existingCurrent.emoji !== (currentEmoji || ''));
                if (existingCurrent && !currentChanged) {
                    existingCurrent.marker.updatePosition(currentUser.latitude, currentUser.longitude);
                } else {
                    if (existingCurrent) removeMarker(currentUserId);
                    const marker = createUserMarker(currentUser, googleMap, 48, true, true, -1);
                    markersRef.current[currentUserId] = { marker, type: 'current', hasStory: currentUser.hasStory, thought: currentUser.thought || '', emoji: currentEmoji || '' };
                }
                
                orbitUsers.forEach((user, index) => {
                    const orbitalPos = getOrbitalPosition(currentUser.latitude, currentUser.longitude, index, 8);
                    activeMarkerIds.add(user.id);
                    const existing = markersRef.current[user.id];
                    const viewedChanged = existing && existing.viewed !== !!viewedStories[user.id];
                    const userChanged = existing && (existing.hasStory !== user.hasStory || existing.thought !== (user.thought || '') || viewedChanged || existing.emoji !== (user.currentEmoji || ''));
                    if (existing && existing.type === 'orbital' && !userChanged) {
                        existing.marker.updatePosition(orbitalPos.lat, orbitalPos.lng);
                    } else {
                        if (existing) removeMarker(user.id);
                        const marker = createUserMarker({ ...user, displayLat: orbitalPos.lat, displayLng: orbitalPos.lng }, googleMap, 38, false, true, index);
                        markersRef.current[user.id] = { marker, type: 'orbital', hasStory: user.hasStory, thought: user.thought || '', viewed: !!viewedStories[user.id], emoji: user.currentEmoji || '' };
                    }
                });
                
                [...farFromOrbit, ...closeButNotOrbital].forEach(user => {
                    activeMarkerIds.add(user.id);
                    const existing = markersRef.current[user.id];
                    const viewedChanged = existing && existing.viewed !== !!viewedStories[user.id];
                    const userChanged = existing && (existing.hasStory !== user.hasStory || existing.thought !== (user.thought || '') || viewedChanged || existing.emoji !== (user.currentEmoji || ''));
                    if (existing && existing.type === 'explorer' && !userChanged) {
                        existing.marker.updatePosition(user.latitude, user.longitude);
                    } else {
                        if (existing) removeMarker(user.id);
                        const marker = createUserMarker(user, googleMap, 22, false, false, -1);
                        markersRef.current[user.id] = { marker, type: 'explorer', hasStory: user.hasStory, thought: user.thought || '', viewed: !!viewedStories[user.id], emoji: user.currentEmoji || '' };
                    }
                });
                
                Object.keys(markersRef.current).forEach(userId => { if (!activeMarkerIds.has(userId)) removeMarker(userId); });
            }, [googleMap, currentUser?.latitude, currentUser?.longitude, currentUser?.thought, currentUser?.hasStory, users, radius, viewedStories, unreadMessages, userPreferences, markerRefreshTick, currentEmoji]);
            
            useEffect(() => {
                if (!googleMap || !currentUser?.latitude || currentUser.latitude === 0) return;
                const currentCenter = googleMap.getCenter();
                if (currentCenter && calculateDistance(currentCenter.lat(), currentCenter.lng(), currentUser.latitude, currentUser.longitude) < 20) return;
                googleMap.setCenter({ lat: currentUser.latitude, lng: currentUser.longitude });
            }, [googleMap, currentUser?.latitude, currentUser?.longitude]);

            useEffect(() => {
                if (!currentUser) return;
                const interval = setInterval(() => {
                    if (!document.hidden) db.collection('users').doc(currentUser.id).update({ isOnline: true, lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(() => {});
                }, 10000);
                return () => clearInterval(interval);
            }, [currentUser]);
            
            useEffect(() => { const interval = setInterval(() => setMarkerRefreshTick(t => t + 1), 30000); return () => clearInterval(interval); }, []);
            useEffect(() => { const h = () => { if (!document.hidden) setMarkerRefreshTick(t => t + 1); }; document.addEventListener('visibilitychange', h); return () => document.removeEventListener('visibilitychange', h); }, []);
            useEffect(() => { const h = () => setMarkerRefreshTick(t => t + 1); window.addEventListener('online', h); return () => window.removeEventListener('online', h); }, []);

            useEffect(() => {
                if (!currentUser?.latitude || users.length === 0) return;
                const closeUsers = users.filter(u => u.distance <= 100 && u.isOnline);
                const currentUserIds = new Set(closeUsers.map(u => u.id));
                if (!initialLoadComplete) { setKnownUserIds(currentUserIds); setInitialLoadComplete(true); return; }
                closeUsers.forEach(user => {
                    if (!knownUserIds.has(user.id)) {
                        setSocialNotifications(prev => prev.some(n => n.userId === user.id) ? prev : [...prev, { id: `${user.id}-${Date.now()}`, userId: user.id, user, timestamp: Date.now() }]);
                    }
                });
                setKnownUserIds(currentUserIds);
                const cleanup = setInterval(() => setSocialNotifications(prev => prev.filter(n => (Date.now() - n.timestamp) < 8000)), 1000);
                return () => clearInterval(cleanup);
            }, [users, currentUser?.latitude]);

            useEffect(() => {
                if (!viewingStory) return;
                const timer = setTimeout(() => { setViewedStories(prev => ({ ...prev, [viewingStory.id]: Date.now() })); setViewingStory(null); }, 5000);
                return () => clearTimeout(timer);
            }, [viewingStory]);

            // Handle Android back button
            const overlayOpenRef = React.useRef(false);
            
            useEffect(() => {
                const hasOverlay = showInbox || showSidebar || showProfile || selectedUser || showPreferences;
                
                if (hasOverlay && !overlayOpenRef.current) {
                    window.history.pushState({ overlay: true }, '');
                    overlayOpenRef.current = true;
                } else if (!hasOverlay && overlayOpenRef.current) {
                    overlayOpenRef.current = false;
                }
            }, [showInbox, showSidebar, showProfile, selectedUser, showPreferences]);

            useEffect(() => {
                const handleBackButton = () => {
                    const hasOverlay = selectedUser || showInbox || showProfile || showSidebar || showPreferences;
                    
                    if (hasOverlay) {
                        if (selectedUser) setSelectedUser(null);
                        else if (showInbox) setShowInbox(false);
                        else if (showProfile) setShowProfile(false);
                        else if (showSidebar) setShowSidebar(false);
                        else if (showPreferences) setShowPreferences(false);
                        overlayOpenRef.current = false;
                    } else if (currentUser) {
                        // En el mapa sin overlays: bloquear navegaci√≥n hacia atr√°s
                        window.history.pushState({ map: true }, '');
                    }
                };
                window.addEventListener('popstate', handleBackButton);
                return () => window.removeEventListener('popstate', handleBackButton);
            }, [showInbox, showSidebar, showProfile, selectedUser, showPreferences, currentUser]);

            const savePreferences = async () => {
                if (!currentUser?.id) return;
                await db.collection('users').doc(currentUser.id).update({ preferences: userPreferences, preferencesUpdated: firebase.firestore.FieldValue.serverTimestamp() });
                setShowPreferences(false);
            };
            const toggleInterest = (id) => setUserPreferences(prev => ({ ...prev, interests: prev.interests.includes(id) ? prev.interests.filter(i => i !== id) : [...prev.interests, id] }));
            const toggleLookingFor = (id) => setUserPreferences(prev => ({ ...prev, lookingFor: prev.lookingFor.includes(id) ? [] : [id] }));

            const handleGoogleSignIn = async () => { try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider().setCustomParameters({ prompt: 'select_account' })); } catch(e) { alert('Error: ' + e.message); } };
            const handleLogout = async () => { 
                if (currentUser) {
                    try {
                        await db.collection('users').doc(currentUser.id).update({ isOnline: false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
                    } catch(e) { console.log('Logout update error:', e); }
                }
                // Clear map markers before logout
                Object.keys(markersRef.current).forEach(key => {
                    if (markersRef.current[key]?.marker?.setMap) {
                        markersRef.current[key].marker.setMap(null);
                    }
                });
                markersRef.current = {};
                setGoogleMap(null);
                setShowSidebar(false);
                await auth.signOut();
            };

            const handleThoughtSubmit = async () => {
                if (!thought.trim() || !currentUser) return;
                if (window.lastThoughtTimestamp && (Date.now() - window.lastThoughtTimestamp) / 60000 < 15) {
                    alert(`Espera ${Math.ceil(15 - (Date.now() - window.lastThoughtTimestamp) / 60000)} minutos`);
                    return;
                }
                const newThought = thought.trim();
                await db.collection('users').doc(currentUser.id).update({ thought: newThought, thoughtTimestamp: firebase.firestore.FieldValue.serverTimestamp() });
                setCurrentUser(prev => ({ ...prev, thought: newThought }));
                window.lastThoughtTimestamp = Date.now();
                setThought('');
            };

            const handleAvatarClick = (user) => {
                if (user.id === currentUser?.id) {
                    if (currentUser.hasStory && currentUser.storyUrl) setViewingStory(currentUser);
                    else setShowStoryUpload(true);
                } else {
                    if (user.hasStory && user.storyUrl) { setViewedStories(prev => ({ ...prev, [user.id]: Date.now() })); setViewingStory(user); }
                    else { setInstagramModalUser(user); setShowInstagramModal(true); }
                }
            };

            const handleStoryImageSelect = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (ev) => setStoryImage(ev.target.result); reader.readAsDataURL(file); } };

            const handleStoryPublish = async () => {
                if (!storyImage || !currentUser) return;
                setUploadingStory(true);
                try {
                    const response = await fetch(storyImage);
                    const blob = await response.blob();
                    const ref = storage.ref().child(`stories/${currentUser.id}/${Date.now()}.jpg`);
                    await ref.put(blob);
                    const url = await ref.getDownloadURL();
                    await db.collection('users').doc(currentUser.id).update({ storyUrl: url, storyTimestamp: firebase.firestore.FieldValue.serverTimestamp() });
                    setCurrentUser(prev => ({ ...prev, hasStory: true, storyUrl: url, storyTimestamp: Date.now() }));
                    setStoryImage(null);
                    setShowStoryUpload(false);
                } catch(e) { alert('Error: ' + e.message); }
                setUploadingStory(false);
            };

            const openChat = (user) => {
                setSelectedUser(user);
                setShowInstagramModal(false);
                const chatId = [currentUser.id, user.id].sort().join('_');
                db.collection('chats').doc(chatId).update({ [`unreadCount_${currentUser.id}`]: 0 }).catch(() => {});
                setUnreadMessages(prev => { const u = { ...prev }; delete u[user.id]; return u; });
                db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp', 'asc').onSnapshot((snapshot) => {
                    const msgs = [];
                    snapshot.forEach((doc) => msgs.push({ id: doc.id, ...doc.data() }));
                    setMessages(prev => ({ ...prev, [chatId]: msgs }));
                    setTimeout(() => { if (chatMessagesRef.current) chatMessagesRef.current.scrollTop = chatMessagesRef.current.scrollHeight; }, 100);
                });
            };

            const sendMessage = async () => {
                if (!messageInput.trim() || !selectedUser || !currentUser) return;
                const chatId = [currentUser.id, selectedUser.id].sort().join('_');
                const text = messageInput.trim();
                setMessageInput('');
                try {
                    await db.collection('chats').doc(chatId).collection('messages').add({ text, senderId: currentUser.id, senderName: currentUser.name, senderPhoto: currentUser.photo, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                    await db.collection('chats').doc(chatId).set({ 
                        participants: [currentUser.id, selectedUser.id], 
                        lastMessage: text, 
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(), 
                        [`unreadCount_${selectedUser.id}`]: firebase.firestore.FieldValue.increment(1) 
                    }, { merge: true });
                    console.log('Mensaje enviado, incrementando unreadCount para:', selectedUser.id);
                } catch(e) {
                    console.error('Error enviando mensaje:', e);
                }
            };

            const sendQuickMessage = async () => {
                if (!quickMessage.trim() || !instagramModalUser || !currentUser) return;
                const chatId = [currentUser.id, instagramModalUser.id].sort().join('_');
                try {
                    await db.collection('chats').doc(chatId).collection('messages').add({ text: quickMessage.trim(), senderId: currentUser.id, senderName: currentUser.name, senderPhoto: currentUser.photo, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                    await db.collection('chats').doc(chatId).set({ 
                        participants: [currentUser.id, instagramModalUser.id], 
                        lastMessage: quickMessage.trim(), 
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(), 
                        [`unreadCount_${instagramModalUser.id}`]: firebase.firestore.FieldValue.increment(1) 
                    }, { merge: true });
                    console.log('Quick message enviado, incrementando unreadCount para:', instagramModalUser.id);
                } catch(e) {
                    console.error('Error enviando quick message:', e);
                }
                setQuickMessage('');
                setShowInstagramModal(false);
                openChat(instagramModalUser);
            };

            const sendLike = async () => {
                if (!instagramModalUser || !currentUser) return;
                const chatId = [currentUser.id, instagramModalUser.id].sort().join('_');
                try {
                    await db.collection('chats').doc(chatId).collection('messages').add({ text: '‚ù§Ô∏è', senderId: currentUser.id, senderName: currentUser.name, senderPhoto: currentUser.photo, timestamp: firebase.firestore.FieldValue.serverTimestamp(), type: 'like' });
                    await db.collection('chats').doc(chatId).set({ 
                        participants: [currentUser.id, instagramModalUser.id], 
                        lastMessage: '‚ù§Ô∏è', 
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(), 
                        [`unreadCount_${instagramModalUser.id}`]: firebase.firestore.FieldValue.increment(1) 
                    }, { merge: true });
                    console.log('Like enviado, incrementando unreadCount para:', instagramModalUser.id);
                } catch(e) {
                    console.error('Error enviando like:', e);
                }
                setShowInstagramModal(false);
            };

            const sendStoryReaction = async (emoji) => {
                if (!viewingStory || !currentUser || viewingStory.id === currentUser.id) return;
                
                // Mostrar animaci√≥n de burbujas de emoji
                setEmojiBurst(emoji);
                setTimeout(() => setEmojiBurst(null), 1500);
                
                const chatId = [currentUser.id, viewingStory.id].sort().join('_');
                try {
                    await db.collection('chats').doc(chatId).collection('messages').add({ text: `Reaccion√≥ ${emoji} a tu historia`, senderId: currentUser.id, senderName: currentUser.name, senderPhoto: currentUser.photo, timestamp: firebase.firestore.FieldValue.serverTimestamp(), type: 'story_reaction', emoji });
                    await db.collection('chats').doc(chatId).set({ 
                        participants: [currentUser.id, viewingStory.id], 
                        lastMessage: emoji, 
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(), 
                        [`unreadCount_${viewingStory.id}`]: firebase.firestore.FieldValue.increment(1) 
                    }, { merge: true });
                    console.log('Story reaction enviada, incrementando unreadCount para:', viewingStory.id);
                } catch(e) {
                    console.error('Error enviando story reaction:', e);
                }
                setViewedStories(prev => ({ ...prev, [viewingStory.id]: Date.now() }));
                setTimeout(() => setViewingStory(null), 800);
            };

            const sendEmoji = async (emoji) => {
                if (!currentUser) return;
                const now = Date.now();
                setCurrentEmoji(emoji);
                setEmojiTimestamp(now);
                setShowEmojiPicker(false);
                setCurrentUser(prev => ({ ...prev, currentEmoji: emoji, emojiTimestamp: now }));
                await db.collection('users').doc(currentUser.id).update({ 
                    currentEmoji: emoji, 
                    emojiTimestamp: firebase.firestore.FieldValue.serverTimestamp() 
                });
                setTimeout(() => {
                    setCurrentEmoji(null);
                    setEmojiTimestamp(null);
                    setCurrentUser(prev => ({ ...prev, currentEmoji: null, emojiTimestamp: null }));
                }, 3000);
            };

            const formatMessageTime = (ts) => { if (!ts) return ''; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }); };
            const formatTimeAgo = (ts) => { if (!ts) return 'Hace un momento'; const t = typeof ts === 'number' ? ts : (ts.toMillis ? ts.toMillis() : ts); const m = Math.floor((Date.now() - t) / 60000); const h = Math.floor((Date.now() - t) / 3600000); if (m < 1) return 'Hace un momento'; if (m < 60) return `Hace ${m}m`; if (h < 24) return `Hace ${h}h`; return 'Hace m√°s de 1 d√≠a'; };

            if (!currentUser) {
                return (
                    <div style={{ minHeight: '100vh', background: '#0d1117' }}></div>
                );
            }

            const usersInRange = users.filter(u => u.distance <= radius && u.isOnline && u.latitude !== 0);
            const chatId = selectedUser ? [currentUser?.id, selectedUser.id].sort().join('_') : null;
            const chatMessages = chatId ? (messages[chatId] || []) : [];

            return (
                <>
                    <div className="main-container">
                        <div className="radar-container">
                            <div id="google-map" ref={mapRef}></div>
                            <div className="map-header">
                                <svg className="header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" onClick={() => setShowSidebar(true)}><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                                <div className="map-people-counter" onClick={() => setMarkerRefreshTick(t => t + 1)} style={{ cursor: 'pointer' }}>
                                    <span className="map-people-counter-number">{usersInRange.length}</span>
                                    <span className="map-people-counter-text">cerca</span>
                                </div>
                                <div style={{ position: 'relative' }} onClick={() => setShowInbox(true)}>
                                    <svg className="header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                                    {totalUnread > 0 && <div style={{ position: 'absolute', top: '-6px', right: '-6px', minWidth: '18px', height: '18px', background: 'linear-gradient(135deg,#ff6b35,#f7931e)', borderRadius: '9px', border: '2px solid #0d1117', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '10px', fontWeight: '700', color: '#fff', padding: '0 4px' }}>{totalUnread > 9 ? '9+' : totalUnread}</div>}
                                </div>
                            </div>
                        </div>
                        
                        <div className="thought-input-container">
                            <div className="thought-input-wrapper">
                                <div className={`emoji-picker ${showEmojiPicker ? 'active' : ''}`}>
                                    {reactionEmojis.map(emoji => (
                                        <div key={emoji} className="emoji-picker-item" onClick={() => sendEmoji(emoji)}>{emoji}</div>
                                    ))}
                                </div>
                                <svg className="thought-input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" onClick={() => setShowEmojiPicker(!showEmojiPicker)} style={{ color: showEmojiPicker ? '#38bd62' : '#8696a0' }}><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                                <input type="text" className="thought-input" placeholder="Mensaje" value={thought} onChange={(e) => setThought(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleThoughtSubmit()} maxLength={15} onFocus={() => setShowEmojiPicker(false)}/>
                            </div>
                            <button className="send-button" onClick={handleThoughtSubmit}><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
                        </div>
                    </div>

                    {/* ... (resto del c√≥digo React - sidebars, inbox, chats, etc.) ... */}
                </>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<RadarSocialApp />);
    </script>
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered:', reg.scope))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>
</body>
</html>
