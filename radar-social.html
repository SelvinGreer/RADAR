<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NexMe - Conecta con personas cerca de ti</title>
    <!-- v7.8.4 Build: 2025-12-14 | Modal 250px + 3 puntos + hierba verde -->

    <!-- PWA Meta Tags -->
    <meta name="description" content="Encuentra y conecta con personas cerca de ti">
    <meta name="theme-color" content="transparent">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA2kFaHgj0LpeB3MJBUTG_piDyW_zJ1wzU&libraries=places,geometry"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100vh;
            height: 100dvh;
        }

        #root {
            width: 100%;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            padding: 0;
        }

        .radar-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #google-map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .map-header {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    z-index: 10;
    background: linear-gradient(180deg, rgba(26, 31, 38, 1) 0%, rgba(26, 31, 38, 0.7) 70%, transparent 100%);
    backdrop-filter: blur(12px);
    padding: max(env(safe-area-inset-top), 12px) 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
        .header-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            color: #c9d1d9;
        }

        .map-people-counter {
            background: rgba(13, 17, 23, 0.9);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 8px 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(56, 189, 98, 0.2);
        }

        .map-people-counter-number {
            font-size: 16px;
            font-weight: 700;
            color: #38bd62;
        }

        .map-people-counter-text {
            font-size: 12px;
            color: rgba(230, 237, 243, 0.8);
        }
        .meeting-points-filter-bar {
    position: absolute;
    top: 68px;
    left: 0;
    right: 0;
    z-index: 9;
    background: transparent;
    backdrop-filter: none;
    padding: 8px 0;
}

.meeting-filter-scroll {
    display: flex;
    gap: 8px;
    padding: 0 16px;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
}

.meeting-filter-scroll::-webkit-scrollbar {
    display: none;
}

.meeting-filter-chip {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    background: rgba(22, 27, 34, 0.8);
    border: 1px solid rgba(48, 54, 61, 0.5);
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    font-size: 13px;
    font-weight: 500;
    color: #c9d1d9;
}

.meeting-filter-chip:hover {
    background: rgba(34, 39, 46, 0.9);
    border-color: rgba(56, 189, 98, 0.3);
}

.meeting-filter-chip.active {
    background: rgba(56, 189, 98, 0.15);
    border-color: #38bd62;
    color: #38bd62;
}

.meeting-filter-emoji {
    font-size: 16px;
}
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Slider de radio - Dise√±o sutil para sidebar */
        .radius-slider-section {
            padding: 20px 20px 16px 20px;
            border-top: 1px solid rgba(48, 54, 61, 0.3);
            border-bottom: 1px solid rgba(48, 54, 61, 0.3);
            margin-top: 12px;
        }

        .radius-slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .radius-slider-title {
            font-size: 11px;
            font-weight: 500;
            color: #6e7681;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .radius-slider-value {
            font-size: 14px;
            font-weight: 600;
            color: #38bd62;
        }

        .radius-slider-track {
            position: relative;
            width: 100%;
            height: 6px;
            background: #161b22;
            border-radius: 3px;
            cursor: pointer;
            touch-action: none;
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        .radius-slider-progress {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, rgba(56, 189, 98, 0.5) 0%, #38bd62 100%);
            border-radius: 3px;
        }

        .radius-slider-thumb {
            position: absolute;
            top: 50%;
            width: 18px;
            height: 18px;
            background: linear-gradient(145deg, #3fcf6e 0%, #2ea556 100%);
            border: 2px solid #0d1117;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: grab;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            touch-action: none;
        }

        .radius-slider-marks {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
        }

        .radius-slider-mark {
            font-size: 9px;
            color: #6e7681;
            font-weight: 500;
        }

        .thought-input-container {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 90;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 50px 12px 16px 12px;
    background: linear-gradient(to bottom, 
        rgba(13, 17, 23, 0) 0%, 
        rgba(13, 17, 23, 0.8) 40%, 
        rgba(13, 17, 23, 1) 70%,
        rgba(13, 17, 23, 1) 100%
    );
}

        .thought-input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            background: #1f2c34;
            border-radius: 24px;
            padding: 6px 12px;
            gap: 8px;
            border: 1px solid rgba(134, 150, 160, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .thought-input-icon {
            width: 24px;
            height: 24px;
            color: #8696a0;
            cursor: pointer;
            flex-shrink: 0;
            transition: color 0.2s ease;
        }

        .thought-input-icon:hover {
            color: #aebac1;
        }

        .thought-input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 8px 4px;
            color: #e9edef;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            outline: none;
            min-width: 0;
        }

        .thought-input::placeholder {
            color: #8696a0;
        }

        .send-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #00a884;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: background 0.2s ease;
        }

        .send-button:hover {
            background: #06cf9c;
        }

        .send-button svg {
            width: 22px;
            height: 22px;
            color: #fff;
        }

        .location-permission {
            position: fixed;
            inset: 0;
            background: rgba(13, 17, 23, 0.97);
            backdrop-filter: blur(20px);
            z-index: 400;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
        }

        .permission-card {
            background: rgba(22, 27, 34, 0.95);
            border: 1px solid rgba(48, 54, 61, 0.6);
            border-radius: 18px;
            padding: 34px 26px;
            text-align: center;
            max-width: 350px;
        }

        .permission-icon {
            width: 68px;
            height: 68px;
            margin: 0 auto 22px;
            color: #58a6ff;
        }

        .permission-card h2 {
            font-size: 21px;
            color: #f0f6fc;
            margin-bottom: 11px;
        }

        .permission-card p {
            color: #8b949e;
            line-height: 1.6;
            font-size: 14px;
        }

        .gps-dots {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .gps-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #38bd62;
            animation: pulse 1s ease-in-out infinite;
        }

        .gps-dot:nth-child(2) { animation-delay: 0.2s; }
        .gps-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.04); }
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            15% { transform: scale(1.08); }
            30% { transform: scale(1); }
            45% { transform: scale(1.06); }
            60% { transform: scale(1); }
        }

        .sidebar, .profile-overlay, .tech-settings-overlay, .chat-overlay {
            position: fixed;
            inset: 0;
            background: #0d1117;
            z-index: 200;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .sidebar {
            width: 280px;
            transform: translateX(-100%);
            border-right: 1px solid rgba(48, 54, 61, 0.5);
        }

        .sidebar.active, .profile-overlay.active, 
        .tech-settings-overlay.active, .chat-overlay.active {
            transform: translateX(0);
        }

        .overlay-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 150;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .overlay-backdrop.active {
            opacity: 1;
            pointer-events: all;
        }

        .sidebar-header, .profile-header, .tech-settings-header, .chat-header {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 20px;
            background: rgba(22, 27, 34, 0.95);
            border-bottom: 1px solid rgba(48, 54, 61, 0.5);
        }

        .sidebar-header h2, .profile-header h2, .tech-settings-header h2 {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
            color: #f0f6fc;
            margin: 0;
        }

        .sidebar-content, .profile-content, .tech-settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px 0;
        }

        .sidebar-item {
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            color: #c9d1d9;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .sidebar-item:hover {
            background: rgba(48, 54, 61, 0.3);
        }

        .sidebar-item svg {
            width: 22px;
            height: 22px;
            color: #8b949e;
        }

        .profile-content { padding: 24px 20px; }

        .profile-avatar-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 28px;
        }

        .profile-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid rgba(88, 166, 255, 0.3);
            object-fit: cover;
            margin-bottom: 16px;
        }

        .profile-name {
            font-size: 24px;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 4px;
        }

        .profile-bio {
            color: #8b949e;
            text-align: center;
            font-size: 14px;
        }

        .profile-section { margin-bottom: 24px; }

        .profile-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #8b949e;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .profile-field {
            background: rgba(22, 27, 34, 0.6);
            border: 1px solid rgba(48, 54, 61, 0.4);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .profile-field-label { color: #8b949e; font-size: 14px; }
        .profile-field-value { color: #f0f6fc; font-size: 14px; font-weight: 500; }

        /* INBOX PANEL - Nueva estructura */
        .inbox-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0d1117;
            z-index: 200;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            padding-top: 10px;
        }
        
        .inbox-panel.active {
            transform: translateX(0);
        }

        .inbox-stories {
            display: flex;
            gap: 16px;
            padding: 12px 16px 16px 16px;
            overflow-x: auto;
            border-bottom: 1px solid rgba(48, 54, 61, 0.5);
            align-items: flex-end;
        }
        
        .inbox-stories::-webkit-scrollbar { display: none; }
        .inbox-stories { scrollbar-width: none; }

        .inbox-story-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 75px;
            cursor: pointer;
            position: relative;
        }

        .inbox-bubble {
            background: #3a3a3a;
            color: #e0e0e0;
            padding: 6px 10px;
            border-radius: 14px;
            font-size: 11px;
            white-space: nowrap;
            max-width: 90px;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: -12px;
            z-index: 2;
        }

        .inbox-story-ring {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            padding: 3px;
            background: #404040;
        }
        
        .inbox-story-ring.has-story {
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
        }
        
        .inbox-story-ring.has-unread {
            background: linear-gradient(45deg, #f7d046, #ffb347, #f7d046);
        }

        .inbox-story-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #0d1117;
        }

        .inbox-add-btn {
            position: absolute;
            bottom: 26px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: #38bd62;
            border-radius: 50%;
            border: 2px solid #0d1117;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 14px;
            font-weight: bold;
        }

        .inbox-story-name {
            font-size: 11px;
            color: #e6edf3;
            margin-top: 6px;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
        }

        .inbox-tabs-bar {
            display: flex;
            border-bottom: 1px solid rgba(48, 54, 61, 0.5);
        }

        .inbox-tab-btn {
            flex: 1;
            padding: 14px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #8b949e;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .inbox-tab-btn.active {
            color: #f0f6fc;
            border-bottom-color: #f0f6fc;
        }

        .inbox-conversations {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .inbox-no-chats {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
            color: #6e7681;
        }

        .inbox-conv-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
        }

        .inbox-conv-item:active {
            background: rgba(255,255,255,0.05);
        }

        .inbox-conv-avatar-wrap {
            position: relative;
        }

        .inbox-conv-avatar {
            width: 54px;
            height: 54px;
            border-radius: 50%;
            object-fit: cover;
        }

        .inbox-conv-online {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            background: #38bd62;
            border: 3px solid #0d1117;
            border-radius: 50%;
        }

        .inbox-conv-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .inbox-conv-name {
            font-size: 15px;
            font-weight: 600;
            color: #f0f6fc;
        }

        .inbox-conv-preview {
            font-size: 13px;
            color: #8b949e;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .inbox-conv-dist {
            font-size: 12px;
            color: #38bd62;
        }

        .tech-settings-content { padding: 20px; }

        .tech-mode-selector { margin-bottom: 30px; }

        .tech-mode-selector h3, .tech-list h3 {
            font-size: 14px;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 12px;
            text-transform: uppercase;
        }

        .tech-mode-options { display: flex; gap: 12px; }

        .tech-mode-option {
            flex: 1;
            padding: 12px;
            background: rgba(22, 27, 34, 0.5);
            border: 2px solid rgba(48, 54, 61, 0.5);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
        }

        .tech-mode-option.active {
            background: rgba(56, 189, 98, 0.15);
            border-color: rgba(56, 189, 98, 0.6);
        }

        .tech-mode-option .icon { font-size: 24px; margin-bottom: 6px; }
        .tech-mode-option .label { font-size: 12px; font-weight: 600; color: #c9d1d9; }
        .tech-mode-option.active .label { color: #38bd62; }
        .tech-mode-option .description { font-size: 10px; color: #8b949e; margin-top: 4px; }

        .tech-list { margin-top: 20px; }

        .tech-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: rgba(22, 27, 34, 0.5);
            border: 1px solid rgba(48, 54, 61, 0.5);
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .tech-item.disabled { opacity: 0.5; pointer-events: none; }
        .tech-item-info { flex: 1; }

        .tech-item-name {
            font-size: 15px;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tech-item-icon { font-size: 18px; }
        .tech-item-description { font-size: 12px; color: #8b949e; }

        .tech-toggle {
            position: relative;
            width: 50px;
            height: 28px;
            background: rgba(139, 148, 158, 0.3);
            border-radius: 14px;
            cursor: pointer;
        }

        .tech-toggle.active { background: rgba(56, 189, 98, 0.5); }

        .tech-toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: #8b949e;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .tech-toggle.active::after { left: 25px; background: #38bd62; }

        .preferences-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .preferences-overlay.active { opacity: 1; visibility: visible; }

        .preferences-container {
            background: #161b22;
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid rgba(48, 54, 61, 0.5);
        }

        .preferences-header {
            padding: 20px;
            border-bottom: 1px solid rgba(48, 54, 61, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: #161b22;
            z-index: 10;
        }

        .preferences-header h2 { margin: 0; font-size: 18px; color: #e6edf3; }

        .preferences-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(139, 148, 158, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .preferences-close svg { width: 18px; height: 18px; color: #8b949e; }

        .preferences-section {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(48, 54, 61, 0.3);
        }

        .preferences-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #8b949e;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .preferences-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .preferences-label { font-size: 14px; color: #e6edf3; }

        .preferences-select {
            background: #21262d;
            border: 1px solid rgba(48, 54, 61, 0.5);
            border-radius: 8px;
            padding: 8px 12px;
            color: #e6edf3;
            font-size: 14px;
            outline: none;
            min-width: 120px;
        }

        .preferences-input {
            background: #21262d;
            border: 1px solid rgba(48, 54, 61, 0.5);
            border-radius: 8px;
            padding: 8px 12px;
            color: #e6edf3;
            font-size: 14px;
            outline: none;
            width: 70px;
            text-align: center;
        }

        .age-range-container { display: flex; align-items: center; gap: 8px; }
        .age-range-separator { color: #8b949e; }

        .interests-grid { display: flex; flex-wrap: wrap; gap: 8px; }

        .interest-chip {
            padding: 8px 14px;
            background: #21262d;
            border: 1px solid rgba(48, 54, 61, 0.5);
            border-radius: 20px;
            font-size: 13px;
            color: #8b949e;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .interest-chip.selected {
            background: rgba(56, 189, 98, 0.2);
            border-color: #38bd62;
            color: #38bd62;
        }

        .looking-for-grid { display: flex; flex-direction: column; gap: 8px; }

        .looking-for-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #21262d;
            border: 1px solid rgba(48, 54, 61, 0.5);
            border-radius: 10px;
            cursor: pointer;
        }

        .looking-for-option.selected {
            background: rgba(56, 189, 98, 0.15);
            border-color: #38bd62;
        }

        .looking-for-checkbox {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid #8b949e;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .looking-for-option.selected .looking-for-checkbox {
            background: #38bd62;
            border-color: #38bd62;
        }

        .looking-for-checkbox svg { width: 14px; height: 14px; color: #fff; opacity: 0; }
        .looking-for-option.selected .looking-for-checkbox svg { opacity: 1; }
        .looking-for-label { font-size: 14px; color: #e6edf3; }

        .preferences-save-btn {
            width: 100%;
            padding: 14px;
            background: #38bd62;
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
        }

        .chat-header { 
            background: #1f2c33; 
            border: none; 
        }

        .chat-user-info { flex: 1; display: flex; align-items: center; gap: 12px; }

        .chat-user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }

        .chat-user-details h3 { font-size: 16px; font-weight: 400; color: #e9edef; margin: 0; }
        .chat-user-details p { font-size: 13px; color: #8696a0; margin: 0; }

        .chat-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: #0b141a;
        }

        .chat-info {
            background: rgba(22, 27, 34, 0.6);
            border: 1px solid rgba(48, 54, 61, 0.3);
            padding: 12px 16px;
            border-radius: 10px;
            color: #8b949e;
            font-size: 13px;
            text-align: center;
        }

        .message {
            max-width: 75%;
            padding: 6px 7px 8px 9px;
            border-radius: 8px;
            font-size: 14.2px;
            line-height: 19px;
            position: relative;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
            margin-bottom: 2px;
        }

        .message.sent {
            background: #005c4b;
            color: #e9edef;
            align-self: flex-end;
            border-radius: 8px 8px 0 8px;
        }

        .message.received {
            background: #1f2c33;
            color: #e9edef;
            align-self: flex-start;
            border-radius: 0 8px 8px 8px;
        }

        .message-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin-left: 8px;
            float: right;
            margin-top: 4px;
        }

        .chat-input-container {
            padding: 5px 8px;
            background: #1f2c33;
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            background: #2a3942;
            border: none;
            border-radius: 20px;
            padding: 10px 12px;
            color: #e9edef;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            outline: none;
        }

        .chat-input::placeholder { color: #8696a0; }

        .chat-send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #00a884;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .chat-send-btn:disabled { background: #182229; }
        .chat-send-btn svg { color: #0b141a; width: 24px; height: 24px; }
        .chat-send-btn:disabled svg { color: #8696a0; }

       .instagram-modal-backdrop {
    position: fixed;
    inset: 0;
    background: transparent;
    z-index: 9998;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.instagram-modal-backdrop.active {
    opacity: 1;
    pointer-events: all;
}

        .instagram-modal {
    position: fixed;
    bottom: 160px;
    left: 50%;
    transform: translateX(-50%) translateY(calc(100% + 200px));
    max-width: 250px;
    width: calc(100% - 60px);
    background: rgba(13, 17, 23, 0.98);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 14px;
    z-index: 9999;
    transition: transform 0.3s ease;
}

.instagram-modal.active { transform: translateX(-50%) translateY(0); }

.instagram-modal-header { 
    display: flex; 
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 12px;
    position: relative;
}
.instagram-modal-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid rgba(142, 142, 142, 0.3);
}

.instagram-modal-info { flex: 1; }
.instagram-modal-distance { 
    font-size: 13px; 
    color: #8b949e;
    width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.instagram-modal-actions { position: relative; }
        .instagram-modal-menu-btn {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #8b949e;
    transition: color 0.2s ease;
}

.instagram-modal-menu-btn:hover {
    color: #f0f6fc;
}

.instagram-modal-menu-btn svg {
    width: 20px;
    height: 20px;
}

.instagram-modal-input {
    width: 100%;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 25px;
    padding: 12px 50px 12px 20px;
    color: #e6edf3;
    font-size: 15px;
    font-family: 'Inter', sans-serif;
    outline: none;
}

.instagram-modal-input::placeholder { color: #6e7681; }

.instagram-modal-send {
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #38bd62 0%, #2ea556 100%);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.instagram-modal-send:disabled {
    background: rgba(48, 54, 61, 0.5);
    cursor: not-allowed;
}

.instagram-modal-send svg { width: 20px; height: 20px; color: #fff; }
.instagram-modal-send:disabled svg { color: #6e7681; }
        .instagram-modal-close-btn {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    width: 56px;
    height: 56px;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(10px);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10000;
    border: 2px solid rgba(255, 255, 255, 0.15);
}

.instagram-modal-close-btn svg {
    width: 24px;
    height: 24px;
    color: #fff;
}

        .story-viewer {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .story-viewer.active { opacity: 1; visibility: visible; }

        .story-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .story-progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            z-index: 10;
        }

        .story-progress-fill {
            height: 100%;
            background: #fff;
            animation: storyProgress 5s linear forwards;
        }

        @keyframes storyProgress {
            from { width: 0%; }
            to { width: 100%; }
        }

        .story-header {
            position: absolute;
            top: 16px;
            left: 16px;
            right: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }

        .story-user-info { display: flex; align-items: center; gap: 12px; }

        .story-user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #fff;
            object-fit: cover;
        }

        .story-user-name {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .story-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .story-close svg { width: 20px; height: 20px; color: #fff; }

        .story-image { max-width: 100%; max-height: 100%; object-fit: contain; }

        .story-reactions {
            position: absolute;
            bottom: 110px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 11;
        }

        .story-reaction-btn {
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
            transition: transform 0.15s ease;
        }

        .story-reaction-btn:hover { transform: scale(1.1); }

        /* Emoji burst animation */
        .emoji-burst-container {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 10000;
            overflow: hidden;
        }
        
        .emoji-bubble {
            position: absolute;
            font-size: 32px;
            animation: emojiBurst 1.5s ease-out forwards;
            opacity: 0;
        }
        
        @keyframes emojiBurst {
            0% {
                opacity: 1;
                transform: translateY(0) scale(0.5) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: translateY(-200px) scale(1.2) rotate(15deg);
            }
            100% {
                opacity: 0;
                transform: translateY(-400px) scale(0.8) rotate(-10deg);
            }
        }

        .story-message-btn {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            padding: 14px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50px;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            z-index: 11;
        }

        .story-upload-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 300;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .story-upload-overlay.active { display: flex; }

        .story-upload-container {
            width: 100%;
            max-width: 500px;
            background: #161b22;
            border-radius: 16px;
            padding: 24px;
        }

        .story-upload-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .story-upload-header h2 { font-size: 20px; font-weight: 600; color: #f0f6fc; margin: 0; }

        .story-upload-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
        }

        .story-upload-close svg { width: 20px; height: 20px; color: #8b949e; }

        .story-preview-area {
            width: 100%;
            aspect-ratio: 9/16;
            max-height: 60vh;
            background: #0d1117;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
        }

        .story-preview-area img { width: 100%; height: 100%; object-fit: cover; }

        .story-preview-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            color: #6e7681;
        }

        .story-preview-placeholder svg { width: 64px; height: 64px; }

        .story-upload-actions { display: flex; gap: 12px; }

        .story-select-btn, .story-publish-btn {
            flex: 1;
            height: 48px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .story-select-btn {
            background: rgba(56, 189, 98, 0.15);
            color: #38bd62;
            border: 1px solid rgba(56, 189, 98, 0.3);
        }

        .story-publish-btn {
            background: linear-gradient(135deg, #38bd62 0%, #2d9d51 100%);
            color: #fff;
        }

        .story-publish-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .story-remove-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .story-remove-btn svg { width: 20px; height: 20px; color: #fff; }

        .social-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(22, 27, 34, 0.98);
            border: 1px solid rgba(56, 189, 98, 0.3);
            border-radius: 16px;
            padding: 16px 20px;
            max-width: 340px;
            width: calc(100% - 40px);
            z-index: 9998;
            backdrop-filter: blur(10px);
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-50%) translateY(-30px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .social-notification-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }

        .social-notification-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 2px solid rgba(56, 189, 98, 0.5);
            object-fit: cover;
        }

        .social-notification-info { flex: 1; }
        .social-notification-name { font-size: 15px; font-weight: 600; color: #f0f6fc; margin-bottom: 2px; }
        .social-notification-distance { font-size: 13px; color: #8b949e; }
        .social-notification-message { font-size: 14px; color: #c9d1d9; line-height: 1.5; margin-bottom: 12px; }
        .social-notification-actions { display: flex; gap: 8px; }

        .social-notification-btn {
            flex: 1;
            height: 38px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .social-notification-btn-primary {
            background: linear-gradient(135deg, #38bd62 0%, #2d9d51 100%);
            color: #fff;
        }

        .social-notification-btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: #8b949e;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .social-notification-close {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .social-notification-close svg { width: 14px; height: 14px; color: #8b949e; }

        @keyframes magnetPull {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.15); opacity: 1; }
            80% { transform: scale(0.95); }
            100% { transform: scale(1); opacity: 1; }
        }

        .avatar-entering {
            animation: magnetPull 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        html { overscroll-behavior: none; }

        .emoji-picker {
            position: absolute;
            bottom: 60px;
            left: 0px;
            background: rgba(30, 35, 42, 0.98);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            padding: 8px 12px;
            display: flex;
            gap: 8px;
            border: 1px solid rgba(56, 189, 98, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            transform: scale(0) translateY(10px);
            opacity: 0;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: bottom left;
            z-index: 9999;
            pointer-events: none;
        }

        .emoji-picker.active {
            transform: scale(1) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .emoji-picker-item {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.15s ease;
            background: transparent;
        }

        .emoji-picker-item:hover {
            background: rgba(56, 189, 98, 0.2);
            transform: scale(1.15);
        }

        .emoji-picker-item:active {
            transform: scale(0.95);
        }

        @keyframes emojiBubbleFloat {
            0% {
                transform: translateY(0) scale(0);
                opacity: 0;
            }
            15% {
                transform: translateY(-5px) scale(1.2);
                opacity: 1;
            }
            30% {
                transform: translateY(-15px) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-60px) scale(0.6);
                opacity: 0;
            }
        }

        .emoji-bubble {
            position: absolute;
            font-size: 16px;
            pointer-events: none;
            animation: emojiBubbleFloat 3s ease-out forwards;
            z-index: 100;
        }

        .emoji-bubble:nth-child(1) { animation-delay: 0s; }
        .emoji-bubble:nth-child(2) { animation-delay: 0.15s; }
        .emoji-bubble:nth-child(3) { animation-delay: 0.3s; }
        .emoji-bubble:nth-child(4) { animation-delay: 0.45s; }
        .emoji-bubble:nth-child(5) { animation-delay: 0.6s; }
        .emoji-bubble:nth-child(6) { animation-delay: 0.75s; }
        .emoji-bubble:nth-child(7) { animation-delay: 0.9s; }
        .emoji-bubble:nth-child(8) { animation-delay: 1.05s; }
        .nearby-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: #0d1117;
    z-index: 250;
    transform: translateY(-100%);
    transition: transform 0.3s ease;
    display: flex;
    flex-direction: column;
}

.nearby-modal.active {
    transform: translateY(0);
}

.nearby-modal-header {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 16px 20px;
    background: rgba(22, 27, 34, 0.95);
    border-bottom: 1px solid rgba(48, 54, 61, 0.5);
}

.nearby-modal-header h2 {
    flex: 1;
    font-size: 18px;
    font-weight: 600;
    color: #f0f6fc;
    margin: 0;
}

.nearby-modal-content {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
}

.nearby-user-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid rgba(48, 54, 61, 0.2);
}

.nearby-user-item:active {
    background: rgba(255, 255, 255, 0.05);
}

.nearby-user-avatar-wrap {
    position: relative;
}

.nearby-user-avatar {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    object-fit: cover;
}

.nearby-user-story-ring {
    position: absolute;
    inset: -3px;
    border-radius: 50%;
    background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
    padding: 3px;
}

.nearby-user-story-ring.no-story {
    background: #404040;
}

.nearby-user-story-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #0d1117;
}

.nearby-user-info {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.nearby-user-name {
    font-size: 15px;
    font-weight: 600;
    color: #f0f6fc;
    display: flex;
    align-items: center;
    gap: 6px;
}

.nearby-user-looking {
    font-size: 12px;
    color: #38bd62;
    display: flex;
    align-items: center;
    gap: 4px;
}

.nearby-user-thought {
    font-size: 13px;
    color: #8b949e;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.nearby-user-distance {
    font-size: 14px;
    font-weight: 600;
    color: #58a6ff;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 2px;
}

.nearby-user-meters {
    font-size: 16px;
}

.nearby-user-story-badge {
    font-size: 10px;
    color: #f09433;
}
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const urlParams = new URLSearchParams(window.location.search);
const isGuestMode = urlParams.get('mode') === 'guest';
        const getGuestUID = () => {
    let guestUID = localStorage.getItem('guestUID');
    if (!guestUID) {
        guestUID = 'guest_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        localStorage.setItem('guestUID', guestUID);
    }
    return guestUID;
};

        const firebaseConfig = {
            apiKey: "AIzaSyAhcfX0M5oqX7rZ6WdCZaHfxHKcxySxQl8",
            authDomain: "radar-social-5a61f.firebaseapp.com",
            projectId: "radar-social-5a61f",
            storageBucket: "radar-social-5a61f.firebasestorage.app",
            messagingSenderId: "1010787643000",
            appId: "1:1010787643000:web:e9dc6a1c175d875b90478d"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        function RadarSocialApp() {
            const [radius, setRadius] = useState(1000);
            const [thought, setThought] = useState('');
            const [currentUser, setCurrentUser] = useState(null);
            const [userLocation, setUserLocation] = useState(null);
            const [users, setUsers] = useState([]);
            const [markerRefreshTick, setMarkerRefreshTick] = useState(0);
            const [selectedUser, setSelectedUser] = useState(null);
            const [showInstagramModal, setShowInstagramModal] = useState(false);
            const [instagramModalUser, setInstagramModalUser] = useState(null);
            const [quickMessage, setQuickMessage] = useState('');
            const [messages, setMessages] = useState({});
            const [messageInput, setMessageInput] = useState('');
            const [showSidebar, setShowSidebar] = useState(false);
            const [showProfile, setShowProfile] = useState(false);
            const [showInbox, setShowInbox] = useState(false);
            const [showTechSettings, setShowTechSettings] = useState(false);
            const [showStoryUpload, setShowStoryUpload] = useState(false);
            const [storyImage, setStoryImage] = useState(null);
            const [uploadingStory, setUploadingStory] = useState(false);
            const [viewingStory, setViewingStory] = useState(null);
            const [emojiBurst, setEmojiBurst] = useState(null);
            const [viewedStories, setViewedStories] = useState({});
            const [socialNotifications, setSocialNotifications] = useState([]);
            const [googleMap, setGoogleMap] = useState(null);
            const [waitingForGPS, setWaitingForGPS] = useState(false);
            const [locationAccuracy, setLocationAccuracy] = useState(20);
            const [isDraggingDial, setIsDraggingDial] = useState(false);
            const [inboxTab, setInboxTab] = useState('messages');
            const [favoriteUsers, setFavoriteUsers] = useState([]);
            const [initialLoadComplete, setInitialLoadComplete] = useState(false);
            const [knownUserIds, setKnownUserIds] = useState(new Set());
            const [unreadMessages, setUnreadMessages] = useState({});
            const [totalUnread, setTotalUnread] = useState(0);
            const [showPreferences, setShowPreferences] = useState(false);
            const [showNearbyModal, setShowNearbyModal] = useState(false);
            const [showEmojiPicker, setShowEmojiPicker] = useState(false);
            const [currentEmoji, setCurrentEmoji] = useState(null);
            const [emojiTimestamp, setEmojiTimestamp] = useState(null);
            // === ESTADOS PARA NOTIFICACIONES PUSH ===
const [notifiedUsers, setNotifiedUsers] = useState(new Set());
const hasNotificationPermission = useRef(false);
            // === NUEVOS ESTADOS PARA PUNTOS DE ENCUENTRO ===
const [selectedMeetingCategory, setSelectedMeetingCategory] = useState('all');
const [meetingPoints, setMeetingPoints] = useState([]);
const [selectedMeetingPoint, setSelectedMeetingPoint] = useState(null);
            
            const [userPreferences, setUserPreferences] = useState({
                age: 25, gender: '', interests: [], lookingFor: [],
                ageRangeMin: 18, ageRangeMax: 50, genderPreference: 'all'
            });
            
            const availableInterests = [
                { id: 'gym', label: 'üèãÔ∏è Gym', emoji: 'üèãÔ∏è' },
                { id: 'coffee', label: '‚òï Caf√©', emoji: '‚òï' },
                { id: 'party', label: 'üéâ Fiesta', emoji: 'üéâ' },
                { id: 'reading', label: 'üìö Lectura', emoji: 'üìö' },
                { id: 'gaming', label: 'üéÆ Gaming', emoji: 'üéÆ' },
                { id: 'music', label: 'üéµ M√∫sica', emoji: 'üéµ' },
                { id: 'travel', label: '‚úàÔ∏è Viajes', emoji: '‚úàÔ∏è' },
                { id: 'food', label: 'üçï Comida', emoji: 'üçï' },
                { id: 'sports', label: '‚öΩ Deportes', emoji: '‚öΩ' },
                { id: 'art', label: 'üé® Arte', emoji: 'üé®' },
                { id: 'movies', label: 'üé¨ Cine', emoji: 'üé¨' },
                { id: 'nature', label: 'üåø Naturaleza', emoji: 'üåø' },
                { id: 'tech', label: 'üíª Tecnolog√≠a', emoji: 'üíª' },
                { id: 'pets', label: 'üêï Mascotas', emoji: 'üêï' },
                { id: 'yoga', label: 'üßò Yoga', emoji: 'üßò' },
                { id: 'dance', label: 'üíÉ Baile', emoji: 'üíÉ' }
            ];
            
            const lookingForOptions = [
                { id: 'friendship', label: 'üëã Amistad', emoji: 'üëã' },
                { id: 'casual', label: 'üòä Conexi√≥n casual', emoji: 'üòä' },
                { id: 'networking', label: 'üíº Networking', emoji: 'üíº' },
                { id: 'romance', label: '‚ù§Ô∏è Romance', emoji: '‚ù§Ô∏è' }
            ];
            
            const reactionEmojis = ['üî•', '‚ù§Ô∏è', 'üëã'];
            // === CATEGOR√çAS DE PUNTOS DE ENCUENTRO ===
const meetingCategories = [
    { id: 'all', label: 'Todo', emoji: 'üè†' },
    { id: 'cafes', label: 'Caf√©s', emoji: '‚òï' },
    { id: 'restaurants', label: 'Restaurantes', emoji: 'üçî' },
    { id: 'bars', label: 'Bares', emoji: 'üç∫' },
    { id: 'entertainment', label: 'Ocio', emoji: 'üé¨' },
    { id: 'sports', label: 'Deportes', emoji: 'üèãÔ∏è' }
];

// === DATOS DUMMY DE PUNTOS DE ENCUENTRO (testing) ===
// IMPORTANTE: Cambiar estas coordenadas a lugares reales cerca de ti
// === DATOS DUMMY DE PUNTOS DE ENCUENTRO (testing) ===
const dummyMeetingPoints = [
    {
        id: 'starbucks_albrook',
        name: 'Starbucks Albrook',
        category: 'cafes',
        location: { latitude: 8.9824, longitude: -79.5199 },
        icon: 'https://upload.wikimedia.org/wikipedia/en/thumb/d/d3/Starbucks_Corporation_Logo_2011.svg/1200px-Starbucks_Corporation_Logo_2011.svg.png',
        captureRadius: 30,
        isActive: true
    },
    {
        id: 'mcdonalds_centro',
        name: "McDonald's Centro",
        category: 'restaurants',
        location: { latitude: 8.9830, longitude: -79.5205 },
        icon: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/McDonald%27s_Golden_Arches.svg/1200px-McDonald%27s_Golden_Arches.svg.png',
        captureRadius: 30,
        isActive: true
    },
    {
        id: 'cinepolis_multiplaza',
        name: 'Cin√©polis Multiplaza',
        category: 'entertainment',
        location: { latitude: 8.9836, longitude: -79.5211 },
        icon: 'https://seeklogo.com/images/C/cinepolis-logo-B9DC17D7A6-seeklogo.com.png',
        captureRadius: 50,
        isActive: true
    }
];

// === MAPEO DE CATEGOR√çAS NEXME ‚Üí GOOGLE PLACES ===
const categoryToPlaceType = {
    'cafes': ['cafe', 'coffee_shop'],
    'restaurants': ['restaurant', 'meal_takeaway', 'meal_delivery'],
    'bars': ['bar', 'night_club'],
    'entertainment': ['movie_theater', 'bowling_alley', 'amusement_park', 'museum'],
    'sports': ['gym', 'stadium', 'sports_complex']
};

// === FUNCI√ìN PARA BUSCAR LUGARES CON GOOGLE PLACES API ===
const fetchNearbyPlaces = async (lat, lng, category) => {
    const cacheKey = `places_${category}_${lat.toFixed(3)}_${lng.toFixed(3)}`;
    const cached = localStorage.getItem(cacheKey);
    if (cached) {
        const { data, timestamp } = JSON.parse(cached);
        if (Date.now() - timestamp < 24 * 60 * 60 * 1000) {
            console.log(`üì¶ Usando cache para ${category}`);
            return data;
        }
    }

    console.log(`üîç Buscando ${category} en Google Places...`);
// === NUEVO C√ìDIGO - AGREGAR AQU√ç ===
if (!window.google || !window.google.maps || !window.google.maps.places) {
    console.error('‚ùå Google Maps API no disponible a√∫n');
    return [];
}
// === FIN NUEVO C√ìDIGO ===
    const service = new google.maps.places.PlacesService(document.createElement('div'));
    const types = categoryToPlaceType[category] || [];
    const allPlaces = [];
    for (const type of types) {
        try {
            const results = await new Promise((resolve, reject) => {
                service.nearbySearch({
                    location: { lat, lng },
                    radius: 500,
                    type: type
                }, (results, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        resolve(results || []);
                    } else {
                        console.warn(`Places API status: ${status} for type: ${type}`);
                        resolve([]);
                    }
                });
            });

            allPlaces.push(...results);
        } catch (error) {
            console.error(`Error buscando ${type}:`, error);
        }
    }

    const nexmePlaces = allPlaces.map(place => ({
        id: place.place_id,
        name: place.name,
        category: category,
        location: {
            latitude: place.geometry.location.lat(),
            longitude: place.geometry.location.lng()
        },
        icon: place.icon || place.photos?.[0]?.getUrl({ maxWidth: 100 }) || 
              'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/geocode-71.png',
        captureRadius: 30,
        isActive: true,
        rating: place.rating || null,
        vicinity: place.vicinity || ''
    }));

    localStorage.setItem(cacheKey, JSON.stringify({
        data: nexmePlaces,
        timestamp: Date.now()
    }));

    console.log(`‚úÖ ${nexmePlaces.length} lugares encontrados para ${category}`);
    return nexmePlaces;
};

// === CARGAR TODOS LOS LUGARES DE UNA CATEGOR√çA ===
const loadPlacesForCategory = async (lat, lng, category) => {
    if (category === 'all') {
        const allCategories = ['cafes', 'restaurants', 'bars', 'entertainment', 'sports'];
        const allPlaces = [];
        
        for (const cat of allCategories) {
            const places = await fetchNearbyPlaces(lat, lng, cat);
            allPlaces.push(...places);
        }
        
        return allPlaces;
    } else {
        return await fetchNearbyPlaces(lat, lng, category);
    }
};
            const userPositionHistory = useRef({});
            const notificationSound = useRef(null);
            
            const [techSettings, setTechSettings] = useState({
                mode: 'auto', gps: true, kalman: true, ble: true
            });
            const [activeTech, setActiveTech] = useState({ name: 'GPS', icon: 'üìç', precision: 5.0 });
            const [bleSupported, setBleSupported] = useState(false);
            
            const mapRef = useRef(null);
            const chatMessagesRef = useRef(null);
            const markersRef = useRef({});
            const lastMarkersDataRef = useRef('');
            const lastTickRef = useRef(0);
            const currentUserPositionRef = useRef({ lat: 0, lng: 0 });
            
            const kalmanState = useRef({
                lat: { x: 0, p: 1, q: 0.00001, r: 0.001 },
                lng: { x: 0, p: 1, q: 0.00001, r: 0.001 }
            });
            
            const calculateMovement = (userId, currentLat, currentLng) => {
                const history = userPositionHistory.current[userId] || [];
                const now = Date.now();
                history.push({ lat: currentLat, lng: currentLng, timestamp: now });
                if (history.length > 5) history.shift();
                userPositionHistory.current[userId] = history;
                if (history.length < 2) return { speed: 0, direction: 0, approaching: null };
                const oldest = history[0];
                const newest = history[history.length - 1];
                const timeDiff = (newest.timestamp - oldest.timestamp) / 1000;
                if (timeDiff < 1) return { speed: 0, direction: 0, approaching: null };
                const distance = calculateDistance(oldest.lat, oldest.lng, newest.lat, newest.lng);
                const speedKmh = (distance / timeDiff) * 3.6;
                return { speed: speedKmh, direction: 0, approaching: null };
            };
            
            const isApproaching = (userId, userLat, userLng, myLat, myLng) => {
                const history = userPositionHistory.current[userId] || [];
                if (history.length < 2) return null;
                const oldest = history[0];
                const newest = history[history.length - 1];
                const oldDistance = calculateDistance(oldest.lat, oldest.lng, myLat, myLng);
                const newDistance = calculateDistance(newest.lat, newest.lng, myLat, myLng);
                const diff = oldDistance - newDistance;
                if (Math.abs(diff) < 5) return null;
                return diff > 0;
            };
            
            useEffect(() => {
                // Habilitar AudioContext con interacci√≥n del usuario
                const enableAudio = () => {
                    try {
                        const ctx = new (window.AudioContext || window.webkitAudioContext)();
                        ctx.resume();
                        notificationSound.current = () => {
                            try {
                                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                                const osc = audioCtx.createOscillator();
                                const gain = audioCtx.createGain();
                                osc.connect(gain);
                                gain.connect(audioCtx.destination);
                                osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                                osc.frequency.setValueAtTime(660, audioCtx.currentTime + 0.1);
                                osc.type = 'sine';
                                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                                osc.start(audioCtx.currentTime);
                                osc.stop(audioCtx.currentTime + 0.4);
                            } catch(e) { console.log('Error playing sound:', e); }
                        };
                    } catch(e) {}
                };
                document.addEventListener('touchstart', enableAudio, { once: true });
                document.addEventListener('click', enableAudio, { once: true });
                enableAudio();
            }, []);
            
            useEffect(() => {
                setBleSupported('bluetooth' in navigator);
            }, []);
            // === CARGAR PUNTOS DE ENCUENTRO (dummy para testing) ===
// === CARGAR PUNTOS DE ENCUENTRO (Google Places API) ===
useEffect(() => {
    const loadPlaces = async () => {
        if (!currentUser?.latitude || currentUser.latitude === 0 || !googleMap) {
            console.log('‚è≥ Esperando GPS y mapa...');
            return;
        }
        
        console.log('üìç Cargando puntos de encuentro desde Google Places...');
        console.log('üìç Tu ubicaci√≥n:', currentUser.latitude, currentUser.longitude);
        
        try {
            const places = await loadPlacesForCategory(
                currentUser.latitude,
                currentUser.longitude,
                selectedMeetingCategory
            );
            
            // FIX: Si la API devuelve 0 resultados, usar lugares reales de Panam√°
if (places.length === 0) {
    console.warn('‚ö†Ô∏è API Places devolvi√≥ 0 resultados - Usando lugares reales de Panam√°');
    
    // === LUGARES REALES DE PANAM√Å ===
    const realPanamaMeetingPoints = [
        // === CAF√âS ===
        { id: 'starbucks_albrook', name: 'Starbucks Albrook Mall', category: 'cafes', location: { latitude: 8.9824, longitude: -79.5499 }, icon: 'https://upload.wikimedia.org/wikipedia/en/thumb/d/d3/Starbucks_Corporation_Logo_2011.svg/1200px-Starbucks_Corporation_Logo_2011.svg.png', captureRadius: 30 },
        { id: 'starbucks_multiplaza', name: 'Starbucks Multiplaza', category: 'cafes', location: { latitude: 9.0065, longitude: -79.5023 }, icon: 'https://upload.wikimedia.org/wikipedia/en/thumb/d/d3/Starbucks_Corporation_Logo_2011.svg/1200px-Starbucks_Corporation_Logo_2011.svg.png', captureRadius: 30 },
        { id: 'starbucks_soho', name: 'Starbucks Soho Mall', category: 'cafes', location: { latitude: 8.9867, longitude: -79.5204 }, icon: 'https://upload.wikimedia.org/wikipedia/en/thumb/d/d3/Starbucks_Corporation_Logo_2011.svg/1200px-Starbucks_Corporation_Logo_2011.svg.png', captureRadius: 30 },
        { id: 'starbucks_via_espana', name: 'Starbucks V√≠a Espa√±a', category: 'cafes', location: { latitude: 8.9936, longitude: -79.5197 }, icon: 'https://upload.wikimedia.org/wikipedia/en/thumb/d/d3/Starbucks_Corporation_Logo_2011.svg/1200px-Starbucks_Corporation_Logo_2011.svg.png', captureRadius: 30 },
        { id: 'starbucks_casco_viejo', name: 'Starbucks Casco Viejo', category: 'cafes', location: { latitude: 8.9530, longitude: -79.5353 }, icon: 'https://upload.wikimedia.org/wikipedia/en/thumb/d/d3/Starbucks_Corporation_Logo_2011.svg/1200px-Starbucks_Corporation_Logo_2011.svg.png', captureRadius: 30 },
        { id: 'starbucks_costa_este', name: 'Starbucks Costa del Este', category: 'cafes', location: { latitude: 9.0245, longitude: -79.4785 }, icon: 'https://upload.wikimedia.org/wikipedia/en/thumb/d/d3/Starbucks_Corporation_Logo_2011.svg/1200px-Starbucks_Corporation_Logo_2011.svg.png', captureRadius: 30 },
        { id: 'starbucks_metromall', name: 'Starbucks Metromall', category: 'cafes', location: { latitude: 9.0372, longitude: -79.5063 }, icon: 'https://upload.wikimedia.org/wikipedia/en/thumb/d/d3/Starbucks_Corporation_Logo_2011.svg/1200px-Starbucks_Corporation_Logo_2011.svg.png', captureRadius: 30 },
        { id: 'cafe_unido_casco', name: 'Caf√© Unido Casco Viejo', category: 'cafes', location: { latitude: 8.9514, longitude: -79.5341 }, icon: 'https://static.wixstatic.com/media/f0d8e6_c3a8de6dbfc94f4cb7a8b4d0c2c8c9e7~mv2.png', captureRadius: 30 },
        { id: 'cafe_unido_obarrio', name: 'Caf√© Unido Obarrio', category: 'cafes', location: { latitude: 8.9952, longitude: -79.5253 }, icon: 'https://static.wixstatic.com/media/f0d8e6_c3a8de6dbfc94f4cb7a8b4d0c2c8c9e7~mv2.png', captureRadius: 30 },
        { id: 'cafe_coca_cola', name: 'Caf√© Coca Cola', category: 'cafes', location: { latitude: 8.9530, longitude: -79.5350 }, icon: 'https://www.cocacola.com.pa/content/dam/journey/pa/es/hidden/coca-cola-logo-vector-1.png', captureRadius: 30 },
        { id: 'bajareque_coffee', name: 'Bajareque Coffee House', category: 'cafes', location: { latitude: 8.9520, longitude: -79.5345 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/cafe-71.png', captureRadius: 30 },
        { id: 'kotowa_coffee', name: 'Kotowa Coffee', category: 'cafes', location: { latitude: 8.9535, longitude: -79.5338 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/cafe-71.png', captureRadius: 30 },
        { id: 'cafe_duran', name: 'Caf√© Dur√°n', category: 'cafes', location: { latitude: 8.9540, longitude: -79.5332 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/cafe-71.png', captureRadius: 30 },
        { id: 'cafe_balear', name: 'Caf√© Balear', category: 'cafes', location: { latitude: 8.9890, longitude: -79.5245 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/cafe-71.png', captureRadius: 30 },
        { id: 'granclement', name: 'Granclement Caf√©', category: 'cafes', location: { latitude: 8.9925, longitude: -79.5231 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/cafe-71.png', captureRadius: 30 },
        { id: 'the_coffee_room', name: 'The Coffee Room', category: 'cafes', location: { latitude: 8.9875, longitude: -79.5255 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/cafe-71.png', captureRadius: 30 },
        { id: 'casa_del_cafe', name: 'Casa del Caf√©', category: 'cafes', location: { latitude: 8.9860, longitude: -79.5268 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/cafe-71.png', captureRadius: 30 },
        { id: 'americano_coffee', name: 'Americano Coffee', category: 'cafes', location: { latitude: 8.9845, longitude: -79.5275 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/cafe-71.png', captureRadius: 30 },
        
        // === RESTAURANTES ===
        { id: 'mcdonalds_albrook', name: "McDonald's Albrook", category: 'restaurants', location: { latitude: 8.9820, longitude: -79.5495 }, icon: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/McDonald%27s_Golden_Arches.svg/1200px-McDonald%27s_Golden_Arches.svg.png', captureRadius: 30 },
        { id: 'mcdonalds_via_espana', name: "McDonald's V√≠a Espa√±a", category: 'restaurants', location: { latitude: 8.9940, longitude: -79.5190 }, icon: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/McDonald%27s_Golden_Arches.svg/1200px-McDonald%27s_Golden_Arches.svg.png', captureRadius: 30 },
        { id: 'mcdonalds_multiplaza', name: "McDonald's Multiplaza", category: 'restaurants', location: { latitude: 9.0070, longitude: -79.5020 }, icon: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/McDonald%27s_Golden_Arches.svg/1200px-McDonald%27s_Golden_Arches.svg.png', captureRadius: 30 },
        { id: 'mcdonalds_soho', name: "McDonald's Soho", category: 'restaurants', location: { latitude: 8.9870, longitude: -79.5200 }, icon: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/McDonald%27s_Golden_Arches.svg/1200px-McDonald%27s_Golden_Arches.svg.png', captureRadius: 30 },
        { id: 'mcdonalds_costa_este', name: "McDonald's Costa del Este", category: 'restaurants', location: { latitude: 9.0250, longitude: -79.4780 }, icon: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/McDonald%27s_Golden_Arches.svg/1200px-McDonald%27s_Golden_Arches.svg.png', captureRadius: 30 },
        { id: 'mcdonalds_metromall', name: "McDonald's Metromall", category: 'restaurants', location: { latitude: 9.0375, longitude: -79.5060 }, icon: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/McDonald%27s_Golden_Arches.svg/1200px-McDonald%27s_Golden_Arches.svg.png', captureRadius: 30 },
        { id: 'kfc_albrook', name: 'KFC Albrook', category: 'restaurants', location: { latitude: 8.9818, longitude: -79.5492 }, icon: 'https://upload.wikimedia.org/wikipedia/en/thumb/b/bf/KFC_logo.svg/1200px-KFC_logo.svg.png', captureRadius: 30 },
        { id: 'kfc_via_espana', name: 'KFC V√≠a Espa√±a', category: 'restaurants', location: { latitude: 8.9945, longitude: -79.5185 }, icon: 'https://upload.wikimedia.org/wikipedia/en/thumb/b/bf/KFC_logo.svg/1200px-KFC_logo.svg.png', captureRadius: 30 },
        { id: 'kfc_multiplaza', name: 'KFC Multiplaza', category: 'restaurants', location: { latitude: 9.0068, longitude: -79.5018 }, icon: 'https://upload.wikimedia.org/wikipedia/en/thumb/b/bf/KFC_logo.svg/1200px-KFC_logo.svg.png', captureRadius: 30 },
        { id: 'kfc_obarrio', name: 'KFC Obarrio', category: 'restaurants', location: { latitude: 8.9955, longitude: -79.5250 }, icon: 'https://upload.wikimedia.org/wikipedia/en/thumb/b/bf/KFC_logo.svg/1200px-KFC_logo.svg.png', captureRadius: 30 },
        { id: 'burger_king_albrook', name: 'Burger King Albrook', category: 'restaurants', location: { latitude: 8.9822, longitude: -79.5497 }, icon: 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/85/Burger_King_logo_%281999%29.svg/1200px-Burger_King_logo_%281999%29.svg.png', captureRadius: 30 },
        { id: 'burger_king_multiplaza', name: 'Burger King Multiplaza', category: 'restaurants', location: { latitude: 9.0072, longitude: -79.5022 }, icon: 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/85/Burger_King_logo_%281999%29.svg/1200px-Burger_King_logo_%281999%29.svg.png', captureRadius: 30 },
        { id: 'burger_king_costa_este', name: 'Burger King Costa del Este', category: 'restaurants', location: { latitude: 9.0248, longitude: -79.4778 }, icon: 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/85/Burger_King_logo_%281999%29.svg/1200px-Burger_King_logo_%281999%29.svg.png', captureRadius: 30 },
        { id: 'hard_rock_cafe', name: 'Hard Rock Cafe Panama', category: 'restaurants', location: { latitude: 9.0063, longitude: -79.5025 }, icon: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/59/Hard_Rock_Cafe_Logo.svg/1200px-Hard_Rock_Cafe_Logo.svg.png', captureRadius: 30 },
        { id: 'tgi_fridays_multiplaza', name: "TGI Friday's Multiplaza", category: 'restaurants', location: { latitude: 9.0060, longitude: -79.5028 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/restaurant-71.png', captureRadius: 30 },
        { id: 'nandos_multiplaza', name: "Nando's Multiplaza", category: 'restaurants', location: { latitude: 9.0058, longitude: -79.5030 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/restaurant-71.png', captureRadius: 30 },
        { id: 'subway_albrook', name: 'Subway Albrook', category: 'restaurants', location: { latitude: 8.9816, longitude: -79.5490 }, icon: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Subway_2016_logo.svg/1200px-Subway_2016_logo.svg.png', captureRadius: 30 },
        { id: 'subway_multiplaza', name: 'Subway Multiplaza', category: 'restaurants', location: { latitude: 9.0066, longitude: -79.5024 }, icon: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Subway_2016_logo.svg/1200px-Subway_2016_logo.svg.png', captureRadius: 30 },
        { id: 'dominos_via_espana', name: "Domino's Pizza V√≠a Espa√±a", category: 'restaurants', location: { latitude: 8.9938, longitude: -79.5195 }, icon: 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/74/Dominos_pizza_logo.svg/1200px-Dominos_pizza_logo.svg.png', captureRadius: 30 },
        { id: 'dominos_obarrio', name: "Domino's Pizza Obarrio", category: 'restaurants', location: { latitude: 8.9960, longitude: -79.5248 }, icon: 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/74/Dominos_pizza_logo.svg/1200px-Dominos_pizza_logo.svg.png', captureRadius: 30 },
        { id: 'pizza_hut_albrook', name: 'Pizza Hut Albrook', category: 'restaurants', location: { latitude: 8.9814, longitude: -79.5488 }, icon: 'https://upload.wikimedia.org/wikipedia/en/thumb/d/d2/Pizza_Hut_logo.svg/1200px-Pizza_Hut_logo.svg.png', captureRadius: 30 },
        { id: 'pizza_hut_multiplaza', name: 'Pizza Hut Multiplaza', category: 'restaurants', location: { latitude: 9.0064, longitude: -79.5026 }, icon: 'https://upload.wikimedia.org/wikipedia/en/thumb/d/d2/Pizza_Hut_logo.svg/1200px-Pizza_Hut_logo.svg.png', captureRadius: 30 },
        { id: 'wendys_albrook', name: "Wendy's Albrook", category: 'restaurants', location: { latitude: 8.9812, longitude: -79.5486 }, icon: 'https://upload.wikimedia.org/wikipedia/en/thumb/6/6d/Wendy%27s_logo_2012.svg/1200px-Wendy%27s_logo_2012.svg.png', captureRadius: 30 },
        { id: 'wendys_via_espana', name: "Wendy's V√≠a Espa√±a", category: 'restaurants', location: { latitude: 8.9942, longitude: -79.5188 }, icon: 'https://upload.wikimedia.org/wikipedia/en/thumb/6/6d/Wendy%27s_logo_2012.svg/1200px-Wendy%27s_logo_2012.svg.png', captureRadius: 30 },
        { id: 'arbys_multiplaza', name: "Arby's Multiplaza", category: 'restaurants', location: { latitude: 9.0062, longitude: -79.5027 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/restaurant-71.png', captureRadius: 30 },
        { id: 'popeyes_albrook', name: 'Popeyes Albrook', category: 'restaurants', location: { latitude: 8.9810, longitude: -79.5484 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/restaurant-71.png', captureRadius: 30 },
        { id: 'chilis_multiplaza', name: "Chili's Multiplaza", category: 'restaurants', location: { latitude: 9.0056, longitude: -79.5032 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/restaurant-71.png', captureRadius: 30 },
        { id: 'applebees_metromall', name: "Applebee's Metromall", category: 'restaurants', location: { latitude: 9.0370, longitude: -79.5058 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/restaurant-71.png', captureRadius: 30 },
        { id: 'olive_garden', name: 'Olive Garden', category: 'restaurants', location: { latitude: 9.0054, longitude: -79.5034 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/restaurant-71.png', captureRadius: 30 },
        { id: 'hooters_costa_este', name: 'Hooters Costa del Este', category: 'restaurants', location: { latitude: 9.0246, longitude: -79.4776 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/restaurant-71.png', captureRadius: 30 },
        { id: 'la_vespa', name: 'La Vespa', category: 'restaurants', location: { latitude: 8.9880, longitude: -79.5240 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/restaurant-71.png', captureRadius: 30 },
        
        // === BARES ===
        { id: 'la_rana_dorada', name: 'La Rana Dorada', category: 'bars', location: { latitude: 8.9525, longitude: -79.5348 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/bar-71.png', captureRadius: 30 },
        { id: 'casa_jaguar', name: 'Casa Jaguar', category: 'bars', location: { latitude: 8.9528, longitude: -79.5346 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/bar-71.png', captureRadius: 30 },
        { id: 'tantalo', name: 'Tantalo Rooftop Bar', category: 'bars', location: { latitude: 8.9532, longitude: -79.5344 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/bar-71.png', captureRadius: 30 },
        { id: 'the_wallace', name: 'The Wallace', category: 'bars', location: { latitude: 8.9870, longitude: -79.5238 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/bar-71.png', captureRadius: 30 },
        { id: 'pedro_mandinga', name: 'Pedro Mandinga Rum Bar', category: 'bars', location: { latitude: 8.9526, longitude: -79.5347 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/bar-71.png', captureRadius: 30 },
        { id: 'casablanca', name: 'Casablanca', category: 'bars', location: { latitude: 8.9524, longitude: -79.5349 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/bar-71.png', captureRadius: 30 },
        { id: 'la_concordia', name: 'La Concordia Boutique Hotel Bar', category: 'bars', location: { latitude: 8.9522, longitude: -79.5351 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/bar-71.png', captureRadius: 30 },
        { id: 'rana_dorada_el_cangrejo', name: 'La Rana Dorada El Cangrejo', category: 'bars', location: { latitude: 8.9895, longitude: -79.5232 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/bar-71.png', captureRadius: 30 },
        { id: 'brew_stop', name: 'Brew Stop', category: 'bars', location: { latitude: 8.9900, longitude: -79.5228 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/bar-71.png', captureRadius: 30 },
        { id: 'el_apartamento', name: 'El Apartamento', category: 'bars', location: { latitude: 8.9892, longitude: -79.5234 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/bar-71.png', captureRadius: 30 },
        { id: 'unplugged', name: 'Unplugged', category: 'bars', location: { latitude: 8.9888, longitude: -79.5236 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/bar-71.png', captureRadius: 30 },
        { id: 'hibiscus', name: 'Hibiscus Bar', category: 'bars', location: { latitude: 8.9885, longitude: -79.5238 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/bar-71.png', captureRadius: 30 },
        { id: 'barlovento', name: 'Barlovento', category: 'bars', location: { latitude: 8.9882, longitude: -79.5240 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/bar-71.png', captureRadius: 30 },
        { id: 'mojitos', name: 'Mojitos Sin Mojitos', category: 'bars', location: { latitude: 8.9878, longitude: -79.5242 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/bar-71.png', captureRadius: 30 },
        { id: 'loa_bar', name: 'LOA Bar', category: 'bars', location: { latitude: 8.9875, longitude: -79.5244 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/bar-71.png', captureRadius: 30 },
        
        // === ENTRETENIMIENTO ===
        { id: 'cinepolis_albrook', name: 'Cin√©polis Albrook', category: 'entertainment', location: { latitude: 8.9826, longitude: -79.5501 }, icon: 'https://seeklogo.com/images/C/cinepolis-logo-B9DC17D7A6-seeklogo.com.png', captureRadius: 50 },
        { id: 'cinepolis_multiplaza', name: 'Cin√©polis Multiplaza', category: 'entertainment', location: { latitude: 9.0074, longitude: -79.5019 }, icon: 'https://seeklogo.com/images/C/cinepolis-logo-B9DC17D7A6-seeklogo.com.png', captureRadius: 50 },
        { id: 'cinepolis_metromall', name: 'Cin√©polis Metromall', category: 'entertainment', location: { latitude: 9.0378, longitude: -79.5056 }, icon: 'https://seeklogo.com/images/C/cinepolis-logo-B9DC17D7A6-seeklogo.com.png', captureRadius: 50 },
        { id: 'cinemark_costa_este', name: 'Cinemark Costa del Este', category: 'entertainment', location: { latitude: 9.0252, longitude: -79.4774 }, icon: 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/Cinemark_logo.svg/1200px-Cinemark_logo.svg.png', captureRadius: 50 },
        { id: 'ateneo', name: 'Ateneo', category: 'entertainment', location: { latitude: 8.9858, longitude: -79.5262 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_business-71.png', captureRadius: 50 },
        { id: 'teatro_nacional', name: 'Teatro Nacional', category: 'entertainment', location: { latitude: 8.9538, longitude: -79.5330 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_business-71.png', captureRadius: 50 },
        { id: 'teatro_anayansi', name: 'Teatro Anayansi', category: 'entertainment', location: { latitude: 8.9828, longitude: -79.5503 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_business-71.png', captureRadius: 50 },
        { id: 'bowling_albrook', name: 'Bowling Albrook', category: 'entertainment', location: { latitude: 8.9824, longitude: -79.5498 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_recreational-71.png', captureRadius: 50 },
        { id: 'bowling_multiplaza', name: 'Bowling Multiplaza', category: 'entertainment', location: { latitude: 9.0072, longitude: -79.5021 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_recreational-71.png', captureRadius: 50 },
        { id: 'biomuseo', name: 'Biomuseo', category: 'entertainment', location: { latitude: 8.9365, longitude: -79.5449 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/museum-71.png', captureRadius: 50 },
        { id: 'museo_panama_viejo', name: 'Museo Panam√° Viejo', category: 'entertainment', location: { latitude: 9.0337, longitude: -79.4830 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/museum-71.png', captureRadius: 50 },
        { id: 'museo_canal', name: 'Museo del Canal Interoce√°nico', category: 'entertainment', location: { latitude: 8.9520, longitude: -79.5342 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/museum-71.png', captureRadius: 50 },
        { id: 'parque_omar', name: 'Parque Omar', category: 'entertainment', location: { latitude: 8.9790, longitude: -79.5320 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/park-71.png', captureRadius: 100 },
        { id: 'cinta_costera', name: 'Cinta Costera', category: 'entertainment', location: { latitude: 8.9650, longitude: -79.5280 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/park-71.png', captureRadius: 100 },
        { id: 'parque_metropolitano', name: 'Parque Metropolitano', category: 'entertainment', location: { latitude: 9.0105, longitude: -79.5425 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/park-71.png', captureRadius: 100 },
        
        // === DEPORTES ===
        { id: 'powerclub_via_espana', name: 'PowerClub V√≠a Espa√±a', category: 'sports', location: { latitude: 8.9948, longitude: -79.5182 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_business-71.png', captureRadius: 50 },
        { id: 'powerclub_costa_este', name: 'PowerClub Costa del Este', category: 'sports', location: { latitude: 9.0254, longitude: -79.4772 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_business-71.png', captureRadius: 50 },
        { id: 'powerclub_albrook', name: 'PowerClub Albrook', category: 'sports', location: { latitude: 8.9830, longitude: -79.5505 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_business-71.png', captureRadius: 50 },
        { id: 'smartfit_via_espana', name: 'SmartFit V√≠a Espa√±a', category: 'sports', location: { latitude: 8.9950, longitude: -79.5180 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_business-71.png', captureRadius: 50 },
        { id: 'smartfit_obarrio', name: 'SmartFit Obarrio', category: 'sports', location: { latitude: 8.9965, longitude: -79.5245 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_business-71.png', captureRadius: 50 },
        { id: 'smartfit_costa_este', name: 'SmartFit Costa del Este', category: 'sports', location: { latitude: 9.0256, longitude: -79.4770 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_business-71.png', captureRadius: 50 },
        { id: 'estadio_rommel', name: 'Estadio Rommel Fern√°ndez', category: 'sports', location: { latitude: 8.9992, longitude: -79.5495 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/stadium-71.png', captureRadius: 100 },
        { id: 'estadio_rod_carew', name: 'Estadio Rod Carew', category: 'sports', location: { latitude: 9.0025, longitude: -79.5478 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/stadium-71.png', captureRadius: 100 },
        { id: 'crossfit_507', name: 'CrossFit 507', category: 'sports', location: { latitude: 8.9885, longitude: -79.5230 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_business-71.png', captureRadius: 50 },
        { id: 'orangetheory', name: 'Orangetheory Fitness', category: 'sports', location: { latitude: 9.0258, longitude: -79.4768 }, icon: 'https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_business-71.png', captureRadius: 50 }
    ];
            
            setMeetingPoints(realPanamaMeetingPoints);
            console.log(`‚úÖ ${realPanamaMeetingPoints.length} puntos reales de Panam√° cargados`);
            } else {
    setMeetingPoints(places);
    console.log(`‚úÖ ${places.length} lugares encontrados para ${selectedMeetingCategory}`);
}
        } catch (error) {
            console.error('‚ùå Error cargando lugares:', error);
            console.log('üìç Usando puntos dummy como fallback');
            setMeetingPoints(dummyMeetingPoints);
        }
    };

    loadPlaces();
}, [currentUser?.latitude, currentUser?.longitude, selectedMeetingCategory, googleMap]);

            const applyKalmanFilter = (measurement, state) => {
                const p_pred = state.p + state.q;
                const k = p_pred / (p_pred + state.r);
                return { x: state.x + k * (measurement - state.x), p: (1 - k) * p_pred, q: state.q, r: state.r };
            };
            
            const filterGPSWithKalman = (lat, lng, accuracy) => {
                if (kalmanState.current.lat.x === 0) {
                    kalmanState.current.lat.x = lat;
                    kalmanState.current.lng.x = lng;
                    return { lat, lng };
                }
                const r = Math.max(0.0001, accuracy / 100000);
                kalmanState.current.lat.r = r;
                kalmanState.current.lng.r = r;
                kalmanState.current.lat = applyKalmanFilter(lat, kalmanState.current.lat);
                kalmanState.current.lng = applyKalmanFilter(lng, kalmanState.current.lng);
                return { lat: kalmanState.current.lat.x, lng: kalmanState.current.lng.x };
            };

            const calculateDistance = (lat1, lon1, lat2, lon2) => {
                const R = 6371e3;
                const œÜ1 = lat1 * Math.PI / 180;
                const œÜ2 = lat2 * Math.PI / 180;
                const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
                const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(ŒîœÜ / 2) ** 2 + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) ** 2;
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            };

            const getInitialLocation = () => {
                return new Promise((resolve) => {
                    let attempts = 0;
                    const tryGetLocation = () => {
                        navigator.geolocation.getCurrentPosition(
                            (pos) => {
                                if (pos.coords.accuracy < 50 || attempts >= 5) {
                                    resolve({ latitude: pos.coords.latitude, longitude: pos.coords.longitude, accuracy: pos.coords.accuracy });
                                } else { attempts++; setTimeout(tryGetLocation, 1000); }
                            },
                            () => { attempts++; if (attempts < 5) setTimeout(tryGetLocation, 1000); else resolve(null); },
                            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                        );
                    };
                    tryGetLocation();
                });
            };

            const FIXED_ZOOM = 16;
            // === CREAR MARKER DE PUNTO DE ENCUENTRO ===
const createMeetingPointMarker = (point, map, usersAtPoint) => {
    const markerDiv = document.createElement('div');
    markerDiv.style.cssText = 'display:flex;flex-direction:column;align-items:center;cursor:pointer;position:relative;';
    
    // Contenedor del emoji (32px)
const logoContainer = document.createElement('div');
logoContainer.style.cssText = 'width:32px;height:32px;position:relative;';

// C√≠rculo negro blur con borde blanco
const circle = document.createElement('div');
circle.style.cssText = 'position:absolute;width:100%;height:100%;border-radius:50%;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);border:1.5px solid rgba(255,255,255,0.15);box-shadow:0 2px 8px rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;font-size:20px;';

// Mapeo de categor√≠as a emojis
const categoryEmojis = {
    'cafes': '‚òï',
    'restaurants': 'üçî',
    'bars': 'üç∫',
    'entertainment': 'üé¨',
    'sports': 'üèãÔ∏è'
};

// Emoji de la categor√≠a
circle.textContent = categoryEmojis[point.category] || 'üìç';

logoContainer.appendChild(circle);
    
    // Badge de contador
    if (usersAtPoint > 0) {
        const badge = document.createElement('div');
badge.style.cssText = 'position:absolute;top:-2px;right:-2px;min-width:14px;height:14px;background:linear-gradient(135deg,#ff6b35,#f7931e);border-radius:7px;border:1.5px solid #0d1117;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:#fff;padding:0 3px;';
        badge.textContent = usersAtPoint > 9 ? '9+' : usersAtPoint;
        logoContainer.appendChild(badge);
    }
    
    markerDiv.appendChild(logoContainer);
    
    // Label del nombre
    const nameLabel = document.createElement('div');
    nameLabel.style.cssText = 'margin-top:1px;background:rgba(0,0,0,0.75);padding:1px 4px;border-radius:999px;font-size:6px;font-weight:600;color:#38bd62;white-space:nowrap;max-width:80px;overflow:hidden;text-overflow:ellipsis;';
    nameLabel.textContent = point.name;
    markerDiv.appendChild(nameLabel);
    
    markerDiv.style.opacity = '0';
    markerDiv.style.transition = 'opacity 0.15s ease';
    
    class CustomMarker extends google.maps.OverlayView {
        constructor(position, content) {
            super();
            this.position = position;
            this.content = content;
            this.isFirstDraw = true;
        }
        onAdd() { this.getPanes().overlayMouseTarget.appendChild(this.content); }
        draw() {
            const pos = this.getProjection().fromLatLngToDivPixel(this.position);
            if (pos) {
                this.content.style.position = 'absolute';
                const width = this.content.offsetWidth || 60;
                const height = this.content.offsetHeight || 80;
                if (this.isFirstDraw) {
                    this.isFirstDraw = false;
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            this.content.style.left = (pos.x - width/2) + 'px';
                            this.content.style.top = (pos.y - height) + 'px';
                            this.content.style.opacity = '1';
                        });
                    });
                } else {
                    this.content.style.left = (pos.x - width/2) + 'px';
                    this.content.style.top = (pos.y - height) + 'px';
                }
            }
        }
        onRemove() { if (this.content.parentElement) this.content.parentElement.removeChild(this.content); }
    }
    
    const marker = new CustomMarker(
        new google.maps.LatLng(point.location.latitude, point.location.longitude),
        markerDiv
    );
    marker.setMap(map);
    return marker;
};
            const initializeGoogleMap = (lat, lng) => {
                if (!mapRef.current || googleMap) return;
                currentUserPositionRef.current = { lat, lng };
                const darkStyle = [
                    { elementType: 'geometry', stylers: [{ color: '#2c3e50' }] },
                    { elementType: 'labels.text.stroke', stylers: [{ color: '#1a2332' }] },
                    { elementType: 'labels.text.fill', stylers: [{ color: '#8b9eb5' }] },
                    { featureType: 'poi', stylers: [{ visibility: 'off' }] },
                    { featureType: 'transit', stylers: [{ visibility: 'off' }] },
                    { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#3d5467' }] },
                    { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#7a8fa3' }] },
                    { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#1a4d6b' }] },
                    { featureType: 'landscape', elementType: 'geometry', stylers: [{ color: '#2a3f52' }] },
                    { featureType: 'landscape.natural', elementType: 'geometry', stylers: [{ color: '#2d5a3f' }] },
                    { featureType: 'poi.park', elementType: 'geometry', stylers: [{ color: '#2d5a3f' }] }
                ];
                const map = new google.maps.Map(mapRef.current, {
                    center: { lat, lng }, zoom: FIXED_ZOOM, minZoom: FIXED_ZOOM, maxZoom: FIXED_ZOOM,
                    styles: darkStyle, disableDefaultUI: true, zoomControl: false,
                    gestureHandling: 'greedy', clickableIcons: false
                });
                map.addListener('zoom_changed', () => { if (map.getZoom() !== FIXED_ZOOM) map.setZoom(FIXED_ZOOM); });
                map.addListener('dragend', () => {
                    const center = map.getCenter();
                    const userPos = currentUserPositionRef.current;
                    const distance = calculateDistance(userPos.lat, userPos.lng, center.lat(), center.lng());
                    if (distance > 1000) {
                        const bearing = Math.atan2(center.lng() - userPos.lng, center.lat() - userPos.lat);
                        map.panTo({ lat: userPos.lat + (0.009 * Math.cos(bearing)), lng: userPos.lng + (0.009 * Math.sin(bearing)) });
                    }
                });
                setGoogleMap(map);
                
            };
            
            const createUserMarker = (user, map, size, isCurrentUser = false, isOrbital = true, orbitalIndex = -1) => {
                const markerDiv = document.createElement('div');
                markerDiv.style.cssText = 'display:flex;flex-direction:column;align-items:center;cursor:pointer;position:relative;';
                
                const isRightSide = orbitalIndex >= 0 && orbitalIndex <= 3;
                const isExplorer = !isOrbital && !isCurrentUser;
                
                if (user.thought && user.thought.trim()) {
                    const bubbleContainer = document.createElement('div');
                    if (isCurrentUser) {
    bubbleContainer.style.cssText = `position:absolute;top:0px;right:${size-8}px;display:flex;flex-direction:column;align-items:flex-end;z-index:10;`;
                    } else if (isOrbital && isRightSide) {
                        bubbleContainer.style.cssText = `position:absolute;top:0px;left:${size-8}px;display:flex;flex-direction:column;align-items:flex-start;z-index:10;`;
                    } else {
                        bubbleContainer.style.cssText = `position:absolute;top:0px;right:${size-8}px;display:flex;flex-direction:column;align-items:flex-end;z-index:10;`;
                    }
                    const thoughtBubble = document.createElement('div');
                    thoughtBubble.style.cssText = `background:#3a3a3a;color:#e0e0e0;padding:${isExplorer?'2px 4px':'4px 6px'};border-radius:${isExplorer?'6px':'9px'};font-size:${isExplorer?'6px':'8px'};white-space:nowrap;`;
                    thoughtBubble.textContent = user.thought;
                    bubbleContainer.appendChild(thoughtBubble);
                    
                    const circlesContainer = document.createElement('div');
                    circlesContainer.style.cssText = isCurrentUser ? 'display:flex;flex-direction:column;align-items:flex-end;margin-top:1px;margin-right:-5px;' :
                        (isOrbital && isRightSide ? 'display:flex;flex-direction:column;align-items:flex-start;margin-top:1px;margin-left:-3px;' : 
                        'display:flex;flex-direction:column;align-items:flex-end;margin-top:1px;margin-right:-3px;');
                    const c1 = document.createElement('div');
                    c1.style.cssText = `width:${isExplorer?3:4}px;height:${isExplorer?3:4}px;background:#3a3a3a;border-radius:50%;margin-bottom:1px;`;
                    const c2 = document.createElement('div');
                    c2.style.cssText = 'width:2px;height:2px;background:#3a3a3a;border-radius:50%;';
                    circlesContainer.appendChild(c1);
                    circlesContainer.appendChild(c2);
                    bubbleContainer.appendChild(circlesContainer);
                    markerDiv.appendChild(bubbleContainer);
                }
                
                const avatarContainer = document.createElement('div');
                const userUnreadCount = !isCurrentUser ? (unreadMessages[user.id] || 0) : 0;
                const hasUnseenStory = user.hasStory && !viewedStories[user.id];
                
                let breatheAnimation = (userUnreadCount > 0 || hasUnseenStory) ? 
                    'animation:heartbeat 2s ease-in-out infinite;' : 'animation:breathe 3s ease-in-out infinite;';
                avatarContainer.style.cssText = `width:${size}px;height:${size}px;position:relative;${breatheAnimation}animation-delay:${(Math.random()*2).toFixed(1)}s;`;
                
                const ring = document.createElement('div');
                let ringStyle = userUnreadCount > 0 ? 'background:linear-gradient(45deg,#f7d046,#ffb347,#f7d046);' :
                    (hasUnseenStory ? 'background:linear-gradient(45deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);' : 'background:#404040;');
                ring.style.cssText = `position:absolute;width:100%;height:100%;border-radius:50%;${ringStyle}display:flex;align-items:center;justify-content:center;`;
                
                const innerContainer = document.createElement('div');
                const ringThickness = isExplorer ? 2 : 3;
                const innerSize = size - ringThickness;
                innerContainer.style.cssText = `width:${innerSize}px;height:${innerSize}px;border-radius:50%;background:#2a2a2a;display:flex;align-items:center;justify-content:center;`;
                
                const avatarImg = document.createElement('img');
                avatarImg.src = user.photo;
                const imgSize = innerSize - (isExplorer ? 2 : 4);
                avatarImg.style.cssText = `width:${imgSize}px;height:${imgSize}px;border-radius:50%;object-fit:cover;`;
                
                innerContainer.appendChild(avatarImg);
                ring.appendChild(innerContainer);
                avatarContainer.appendChild(ring);
                
                if (userUnreadCount > 0) {
                    const badge = document.createElement('div');
                    const badgeSize = isExplorer ? 12 : 18;
                    badge.style.cssText = `position:absolute;bottom:-2px;right:-2px;min-width:${badgeSize}px;height:${badgeSize}px;background:linear-gradient(135deg,#ff6b35,#f7931e);border-radius:${badgeSize/2}px;border:${isExplorer?1:2}px solid #0d1117;display:flex;align-items:center;justify-content:center;font-size:${isExplorer?7:10}px;font-weight:700;color:#fff;padding:0 ${isExplorer?2:4}px;`;
                    badge.textContent = userUnreadCount > 9 ? '9+' : userUnreadCount;
                    avatarContainer.appendChild(badge);
                }
                
                markerDiv.appendChild(avatarContainer);
                
                // Emoji bubbles animation
                const activeEmoji = isCurrentUser ? currentEmoji : user.currentEmoji;
                if (activeEmoji) {
                    const bubblesContainer = document.createElement('div');
                    bubblesContainer.style.cssText = 'position:absolute;top:0;left:50%;transform:translateX(-50%);pointer-events:none;';
                    const positions = [-12, -6, 0, 6, 12, -9, 3, 9];
                    for (let i = 0; i < 8; i++) {
                        const bubble = document.createElement('div');
                        bubble.className = 'emoji-bubble';
                        bubble.style.left = `${positions[i]}px`;
                        bubble.textContent = activeEmoji;
                        bubblesContainer.appendChild(bubble);
                    }
                    markerDiv.appendChild(bubblesContainer);
                }
                
                if (!isCurrentUser) {
                    const nameLabel = document.createElement('div');
                    nameLabel.style.cssText = `margin-top:${isExplorer?1:2}px;background:rgba(0,0,0,0.65);padding:${isExplorer?'1px 4px':'2px 5px'};border-radius:999px;font-size:${isExplorer?6:7}px;font-weight:500;color:#fff;white-space:nowrap;`;
                    nameLabel.textContent = user.distance ? `${user.name.split(' ')[0]} / ${user.distance}m` : user.name.split(' ')[0];
                    markerDiv.appendChild(nameLabel);
                }
                
                markerDiv.addEventListener('click', () => handleAvatarClick(user));
                markerDiv.style.opacity = '0';
                markerDiv.style.transition = 'opacity 0.15s ease';
                
                class CustomMarker extends google.maps.OverlayView {
                    constructor(position, content) {
                        super();
                        this.position = position;
                        this.content = content;
                        this.isFirstDraw = true;
                        this.isAnimating = false;
                    }
                    onAdd() { this.getPanes().overlayMouseTarget.appendChild(this.content); }
                    draw() {
                        const pos = this.getProjection().fromLatLngToDivPixel(this.position);
                        if (pos) {
                            this.content.style.position = 'absolute';
                            const width = this.content.offsetWidth || 70;
                            const height = this.content.offsetHeight || 100;
                            if (this.isFirstDraw) {
                                this.isFirstDraw = false;
                                this.content.style.transition = 'none';
                                requestAnimationFrame(() => {
                                    requestAnimationFrame(() => {
                                        this.content.style.left = (pos.x - width/2) + 'px';
                                        this.content.style.top = (pos.y - height) + 'px';
                                        this.content.style.opacity = '1';
                                    });
                                });
                            } else if (this.isAnimating) {
                                this.content.style.transition = 'left 1s ease-out, top 1s ease-out';
                                this.content.style.left = (pos.x - width/2) + 'px';
                                this.content.style.top = (pos.y - height) + 'px';
                                setTimeout(() => { this.isAnimating = false; this.content.style.transition = 'none'; }, 1000);
                            } else {
                                this.content.style.transition = 'none';
                                this.content.style.left = (pos.x - width/2) + 'px';
                                this.content.style.top = (pos.y - height) + 'px';
                            }
                        }
                    }
                    updatePosition(newLat, newLng) {
                        this.isAnimating = true;
                        this.position = new google.maps.LatLng(newLat, newLng);
                        this.draw();
                    }
                    onRemove() { if (this.content.parentElement) this.content.parentElement.removeChild(this.content); }
                }
                
                const lat = user.displayLat || user.latitude;
                const lng = user.displayLng || user.longitude;
                const marker = new CustomMarker(new google.maps.LatLng(lat, lng), markerDiv);
                marker.setMap(map);
                return marker;
            };
            
            const getOrbitalPosition = (centerLat, centerLng, index, totalSlots = 8) => {
                const orbitRadius = 0.00207;
                const angle = (index * (360 / totalSlots)) * (Math.PI / 180);
                const latCorrection = Math.cos(centerLat * Math.PI / 180);
                return { 
                    lat: centerLat + (orbitRadius * Math.cos(angle)), 
                    lng: centerLng + (orbitRadius * Math.sin(angle)) / latCorrection 
                };
            };
            
            const removeMarker = (userId) => {
                if (markersRef.current[userId]) {
                    if (markersRef.current[userId].marker?.setMap) markersRef.current[userId].marker.setMap(null);
                    delete markersRef.current[userId];
                }
            };

            // v7.7.8 FIX: Handle redirect result on mount
            useEffect(() => {
                const checkRedirectResult = async () => {
                    try {
                        const result = await auth.getRedirectResult();
                        if (result.user) {
                            console.log('‚úÖ Login redirect exitoso:', result.user.email);
                        }
                    } catch (error) {
                        console.error('‚ùå Error en redirect result:', error);
                        if (error.code !== 'auth/popup-closed-by-user') {
                            alert('Error al iniciar sesi√≥n: ' + error.message);
                        }
                    }
                };
                checkRedirectResult();
            }, []);
            // Auth effect
            useEffect(() => {
                console.log('üöÄ NEXME v7.8.2 - Modal Instagram optimizado');
                const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
                    if (firebaseUser) {
                        const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                        let thought = '', hasActiveStory = false, storyUrl = null, storyTimestamp = null;
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            if (userData.thought && userData.thoughtTimestamp) {
                                const ts = userData.thoughtTimestamp.toMillis ? userData.thoughtTimestamp.toMillis() : userData.thoughtTimestamp;
                                if ((Date.now() - ts) / 3600000 < 24) { thought = userData.thought; window.lastThoughtTimestamp = ts; }
                            }
                            if (userData.storyUrl && userData.storyTimestamp) {
                                const ts = userData.storyTimestamp.toMillis ? userData.storyTimestamp.toMillis() : userData.storyTimestamp;
                                if ((Date.now() - ts) / 3600000 < 12) { hasActiveStory = true; storyUrl = userData.storyUrl; storyTimestamp = ts; }
                            }
                            if (userData.preferences) setUserPreferences(userData.preferences);
                        }
                        const initialUser = {
                            id: firebaseUser.uid, name: firebaseUser.displayName || 'Usuario',
                            photo: firebaseUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(firebaseUser.displayName || 'User')}&background=38bd62&color=fff&size=150`,
                            thought, hasStory: hasActiveStory, storyUrl, storyTimestamp,
                            email: firebaseUser.email, latitude: 0, longitude: 0, isOnline: true
                        };
                        setCurrentUser(initialUser);
                        await db.collection('users').doc(firebaseUser.uid).set({
                            uid: firebaseUser.uid, displayName: firebaseUser.displayName, email: firebaseUser.email,
                            photoURL: firebaseUser.photoURL, isOnline: true,
                            lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                            location: new firebase.firestore.GeoPoint(0, 0), pendingGPS: true
                        }, { merge: true });
                        
                        if ('geolocation' in navigator) {
                            const location = await getInitialLocation();
                            if (location) {
                                setUserLocation({ latitude: location.latitude, longitude: location.longitude });
                                setCurrentUser(prev => ({ ...prev, latitude: location.latitude, longitude: location.longitude }));
                                setWaitingForGPS(false);
                                await db.collection('users').doc(firebaseUser.uid).update({
                                    location: new firebase.firestore.GeoPoint(location.latitude, location.longitude),
                                    pendingGPS: false, lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                            
                            let usersUnsubscribe = null;
                            let lastUpdateTime = 0;
                            
                            navigator.geolocation.watchPosition(async (position) => {
                                let { latitude, longitude, accuracy } = position.coords;
                                if (accuracy > 100) return;
                                const now = Date.now();
                                if (now - lastUpdateTime < 3000) return;
                                lastUpdateTime = now;
                                
                                if (techSettings.kalman) {
                                    const filtered = filterGPSWithKalman(latitude, longitude, accuracy);
                                    latitude = filtered.lat; longitude = filtered.lng;
                                    accuracy = Math.max(2, accuracy / 2);
                                }
                                
                                setUserLocation({ latitude, longitude });
                                setCurrentUser(prev => ({ ...prev, latitude, longitude }));
                                setLocationAccuracy(accuracy);
                                
                                if (!usersUnsubscribe) {
                                    usersUnsubscribe = db.collection('users').where('isOnline', '==', true).onSnapshot((snapshot) => {
                                        setCurrentUser(currentUserState => {
                                            if (!currentUserState?.latitude) return currentUserState;
                                            const otherUsers = [];
                                            snapshot.forEach((doc) => {
                                                const userData = doc.data();
                                                if (userData.uid === firebaseUser.uid) return;
                                                let isOnline = false;
                                                if (userData.lastSeen) {
                                                    const lastSeenTime = userData.lastSeen.toMillis ? userData.lastSeen.toMillis() : userData.lastSeen;
                                                    isOnline = (Date.now() - lastSeenTime) <= 90000;
                                                }
                                                if (userData.location && isOnline) {
                                                    const userLat = userData.location.latitude;
                                                    const userLon = userData.location.longitude;
                                                    if (userLat !== 0 && userLon !== 0) {
                                                        const distance = Math.round(calculateDistance(currentUserState.latitude, currentUserState.longitude, userLat, userLon));
                                                        let displayThought = '';
                                                        if (userData.thought && userData.thoughtTimestamp) {
                                                            const ts = userData.thoughtTimestamp.toMillis ? userData.thoughtTimestamp.toMillis() : userData.thoughtTimestamp;
                                                            if ((Date.now() - ts) / 3600000 < 24) displayThought = userData.thought;
                                                        }
                                                        let hasActiveStory = false, storyUrl = null, storyTimestamp = null;
                                                        if (userData.storyUrl && userData.storyTimestamp) {
                                                            const ts = userData.storyTimestamp.toMillis ? userData.storyTimestamp.toMillis() : userData.storyTimestamp;
                                                            if ((Date.now() - ts) / 3600000 < 12) { hasActiveStory = true; storyUrl = userData.storyUrl; storyTimestamp = ts; }
                                                        }
                                                        let activeEmoji = null;
                                                        if (userData.currentEmoji && userData.emojiTimestamp) {
                                                            const ets = userData.emojiTimestamp.toMillis ? userData.emojiTimestamp.toMillis() : userData.emojiTimestamp;
                                                            if ((Date.now() - ets) < 3000) activeEmoji = userData.currentEmoji;
                                                        }
                                                        otherUsers.push({
                                                            id: userData.uid, name: userData.displayName || 'Usuario',
                                                            photo: userData.photoURL || 'https://ui-avatars.com/api/?name=User&background=38bd62&color=fff',
                                                            thought: displayThought, hasStory: hasActiveStory, storyUrl, storyTimestamp,
                                                            distance, isOnline: true, latitude: userLat, longitude: userLon,
                                                            preferences: userData.preferences || null,
                                                            currentEmoji: activeEmoji,
                                                            movement: calculateMovement(userData.uid, userLat, userLon),
                                                            approaching: isApproaching(userData.uid, userLat, userLon, currentUserState.latitude, currentUserState.longitude)
                                                        });
                                                    }
                                                }
                                            });
                                            setUsers(otherUsers);
                                            return currentUserState;
                                        });
                                    });
                                }
                                await db.collection('users').doc(firebaseUser.uid).update({
                                    location: new firebase.firestore.GeoPoint(latitude, longitude),
                                    isOnline: true, lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                                    accuracy, pendingGPS: false
                                });
                            }, (error) => console.error('Location error:', error),
                            { enableHighAccuracy: true, timeout: 30000, maximumAge: 10000 });
                        }
                    } else {
            // MODO INVITADO
            if (isGuestMode) {
                const guestUID = getGuestUID();
                
                // Crear usuario invitado
                const guestUser = {
                    id: guestUID,
                    name: 'üëª Invitado',
                    photo: 'https://em-content.zobj.net/thumbs/240/apple/354/ghost_1f47b.png',
                    thought: '',
                    hasStory: false,
                    storyUrl: null,
                    storyTimestamp: null,
                    email: 'invitado@nexme.app',
                    latitude: 0,
                    longitude: 0,
                    isOnline: true,
                    isGuest: true
                };
                
                setCurrentUser(guestUser);
                
                // Guardar invitado en Firestore
                await db.collection('users').doc(guestUID).set({
                    uid: guestUID,
                    displayName: 'üëª Invitado',
                    email: 'invitado@nexme.app',
                    photoURL: 'https://em-content.zobj.net/thumbs/240/apple/354/ghost_1f47b.png',
                    isOnline: true,
                    isGuest: true,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                    location: new firebase.firestore.GeoPoint(0, 0),
                    pendingGPS: true
                }, { merge: true });
                
                // Obtener ubicaci√≥n del invitado
                if ('geolocation' in navigator) {
                    const location = await getInitialLocation();
                    if (location) {
                        setUserLocation({ latitude: location.latitude, longitude: location.longitude });
                        setCurrentUser(prev => ({ ...prev, latitude: location.latitude, longitude: location.longitude }));
                        setWaitingForGPS(false);
                        
                        await db.collection('users').doc(guestUID).update({
                            location: new firebase.firestore.GeoPoint(location.latitude, location.longitude),
                            pendingGPS: false,
                            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    // Watch position para invitado (igual que usuario normal)
                    let usersUnsubscribe = null;
                    let lastUpdateTime = 0;
                    
                    navigator.geolocation.watchPosition(async (position) => {
                        let { latitude, longitude, accuracy } = position.coords;
                        if (accuracy > 100) return;
                        const now = Date.now();
                        if (now - lastUpdateTime < 3000) return;
                        lastUpdateTime = now;
                        
                        if (techSettings.kalman) {
                            const filtered = filterGPSWithKalman(latitude, longitude, accuracy);
                            latitude = filtered.lat;
                            longitude = filtered.lng;
                            accuracy = Math.max(2, accuracy / 2);
                        }
                        
                        setUserLocation({ latitude, longitude });
                        setCurrentUser(prev => ({ ...prev, latitude, longitude }));
                        setLocationAccuracy(accuracy);
                        
                        // Listener de otros usuarios
                        if (!usersUnsubscribe) {
                            usersUnsubscribe = db.collection('users')
                                .where('isOnline', '==', true)
                                .onSnapshot((snapshot) => {
                                    setCurrentUser(currentUserState => {
                                        if (!currentUserState?.latitude) return currentUserState;
                                        const otherUsers = [];
                                        
                                        snapshot.forEach((doc) => {
                                            const userData = doc.data();
                                            if (userData.uid === guestUID) return;
                                            
                                            let isOnline = false;
                                            if (userData.lastSeen) {
                                                const lastSeenTime = userData.lastSeen.toMillis ? userData.lastSeen.toMillis() : userData.lastSeen;
                                                isOnline = (Date.now() - lastSeenTime) <= 90000;
                                            }
                                            
                                            if (userData.location && isOnline) {
                                                const userLat = userData.location.latitude;
                                                const userLon = userData.location.longitude;
                                                
                                                if (userLat !== 0 && userLon !== 0) {
                                                    const distance = Math.round(calculateDistance(
                                                        currentUserState.latitude,
                                                        currentUserState.longitude,
                                                        userLat,
                                                        userLon
                                                    ));
                                                    
                                                    let displayThought = '';
                                                    if (userData.thought && userData.thoughtTimestamp) {
                                                        const ts = userData.thoughtTimestamp.toMillis ? userData.thoughtTimestamp.toMillis() : userData.thoughtTimestamp;
                                                        if ((Date.now() - ts) / 3600000 < 24) displayThought = userData.thought;
                                                    }
                                                    
                                                    let hasActiveStory = false, storyUrl = null, storyTimestamp = null;
                                                    if (userData.storyUrl && userData.storyTimestamp) {
                                                        const ts = userData.storyTimestamp.toMillis ? userData.storyTimestamp.toMillis() : userData.storyTimestamp;
                                                        if ((Date.now() - ts) / 3600000 < 12) {
                                                            hasActiveStory = true;
                                                            storyUrl = userData.storyUrl;
                                                            storyTimestamp = ts;
                                                        }
                                                    }
                                                    
                                                    let activeEmoji = null;
                                                    if (userData.currentEmoji && userData.emojiTimestamp) {
                                                        const ets = userData.emojiTimestamp.toMillis ? userData.emojiTimestamp.toMillis() : userData.emojiTimestamp;
                                                        if ((Date.now() - ets) < 3000) activeEmoji = userData.currentEmoji;
                                                    }
                                                    
                                                    otherUsers.push({
                                                        id: userData.uid,
                                                        name: userData.displayName || 'Usuario',
                                                        photo: userData.photoURL || 'https://ui-avatars.com/api/?name=User&background=38bd62&color=fff',
                                                        thought: displayThought,
                                                        hasStory: hasActiveStory,
                                                        storyUrl,
                                                        storyTimestamp,
                                                        distance,
                                                        isOnline: true,
                                                        latitude: userLat,
                                                        longitude: userLon,
                                                        preferences: userData.preferences || null,
                                                        currentEmoji: activeEmoji,
                                                        movement: calculateMovement(userData.uid, userLat, userLon),
                                                        approaching: isApproaching(userData.uid, userLat, userLon, currentUserState.latitude, currentUserState.longitude)
                                                    });
                                                }
                                            }
                                        });
                                        
                                        setUsers(otherUsers);
                                        return currentUserState;
                                    });
                                });
                        }
                        
                        // Actualizar ubicaci√≥n en Firestore
                        await db.collection('users').doc(guestUID).update({
                            location: new firebase.firestore.GeoPoint(latitude, longitude),
                            isOnline: true,
                            lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                            accuracy,
                            pendingGPS: false
                        });
                    }, (error) => console.error('Location error:', error), {
                        enableHighAccuracy: true,
                        timeout: 30000,
                        maximumAge: 10000
                    });
                }
            } else {
                // Usuario no autenticado y NO es invitado ‚Üí redirigir
                window.location.href = 'index.html';
            }
        }
    });
    return () => unsubscribe();
}, []);

            useEffect(() => {
                if (!currentUser?.latitude || currentUser.latitude === 0 || googleMap) return;
                initializeGoogleMap(currentUser.latitude, currentUser.longitude);
            }, [currentUser?.latitude, currentUser?.longitude, googleMap]);

            useEffect(() => {
                if (!currentUser?.id) return;
                console.log('Iniciando listener de mensajes no le√≠dos para:', currentUser.id);
                const unsubscribe = db.collection('chats').where('participants', 'array-contains', currentUser.id).onSnapshot((snapshot) => {
                    const unreadCounts = {};
                    let total = 0;
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const count = data[`unreadCount_${currentUser.id}`] || 0;
                        if (count > 0) {
                            const otherUserId = data.participants?.find(id => id !== currentUser.id);
                            if (otherUserId) {
                                const prev = unreadMessages[otherUserId] || 0;
                                if (count > prev && prev >= 0 && notificationSound.current && initialLoadComplete) {
                                    try { notificationSound.current(); } catch(e) {}
                                }
                                unreadCounts[otherUserId] = count;
                                total += count;
                            }
                        }
                    });
                    console.log('Mensajes no le√≠dos actualizados:', unreadCounts, 'Total:', total);
                    setUnreadMessages(unreadCounts);
                    setTotalUnread(total);
                });
                return () => unsubscribe();
            }, [currentUser?.id, initialLoadComplete]);

            useEffect(() => {
                if (!currentUser?.latitude || currentUser.latitude === 0 || users.length === 0) return;
                setUsers(prev => prev.map(user => ({
                    ...user, distance: Math.round(calculateDistance(currentUser.latitude, currentUser.longitude, user.latitude, user.longitude))
                })));
            }, [currentUser?.latitude, currentUser?.longitude]);

            // v7.5.0 FIX: Update markers - includes viewedStories in signature
            useEffect(() => {
                if (!googleMap || !currentUser?.latitude || currentUser.latitude === 0) return;
                
                const usersInRange = users.filter(u => {
                    if (u.distance > radius || !u.isOnline || u.latitude === 0) return false;
                    if (u.preferences?.age) {
                        if (u.preferences.age < userPreferences.ageRangeMin || u.preferences.age > userPreferences.ageRangeMax) return false;
                    }
                    if (userPreferences.genderPreference !== 'all' && u.preferences?.gender && u.preferences.gender !== userPreferences.genderPreference) return false;
                    const myLF = userPreferences.lookingFor.length > 0;
                    const theirLF = u.preferences?.lookingFor?.length > 0;
                    if (myLF && theirLF && !u.preferences.lookingFor.some(lf => userPreferences.lookingFor.includes(lf))) return false;
                    if ((myLF && !theirLF) || (!myLF && theirLF)) return false;
                    return true;
                }).sort((a, b) => a.distance - b.distance);
                
                // v7.5.0 FIX: Include viewedStories and unreadMessages in signature for instant updates
                const currentDataSignature = JSON.stringify({
                    usersCount: usersInRange.length,
                    userIds: usersInRange.map(u => u.id).join(','),
                    userPositions: usersInRange.map(u => `${u.latitude.toFixed(5)},${u.longitude.toFixed(5)}`).join('|'),
                    userThoughts: usersInRange.map(u => u.thought || '').join('|'),
                    userStories: usersInRange.map(u => u.hasStory ? '1' : '0').join(''),
                    userEmojis: usersInRange.map(u => u.currentEmoji || '').join(''),
                    viewedStoriesState: Object.keys(viewedStories).sort().join(','),
                    unreadMessagesState: Object.entries(unreadMessages).map(([k,v]) => `${k}:${v}`).join(','),
                    currentThought: currentUser.thought || '',
                    currentHasStory: currentUser.hasStory || false,
                    currentEmoji: currentEmoji || '',
                    currentLat: currentUser.latitude.toFixed(5),
                    currentLng: currentUser.longitude.toFixed(5)
                });
                
                const tickChanged = markerRefreshTick !== lastTickRef.current;
                lastTickRef.current = markerRefreshTick;
                if (!tickChanged && currentDataSignature === lastMarkersDataRef.current) return;
                lastMarkersDataRef.current = currentDataSignature;
                
                const activeMarkerIds = new Set();
                const closeUsers = usersInRange.filter(u => u.distance <= 50);
                const farFromOrbit = usersInRange.filter(u => u.distance > 50);
                const orbitUsers = closeUsers.slice(0, 8);
                const closeButNotOrbital = closeUsers.slice(8);
                
                const currentUserId = 'current_user';
                activeMarkerIds.add(currentUserId);
                const existingCurrent = markersRef.current[currentUserId];
                const currentChanged = existingCurrent && (existingCurrent.hasStory !== currentUser.hasStory || existingCurrent.thought !== (currentUser.thought || '') || existingCurrent.emoji !== (currentEmoji || ''));
                if (existingCurrent && !currentChanged) {
                    existingCurrent.marker.updatePosition(currentUser.latitude, currentUser.longitude);
                } else {
                    if (existingCurrent) removeMarker(currentUserId);
                    const marker = createUserMarker(currentUser, googleMap, 48, true, true, -1);
                    markersRef.current[currentUserId] = { marker, type: 'current', hasStory: currentUser.hasStory, thought: currentUser.thought || '', emoji: currentEmoji || '' };
                }
                
                orbitUsers.forEach((user, index) => {
                    const orbitalPos = getOrbitalPosition(currentUser.latitude, currentUser.longitude, index, 8);
                    activeMarkerIds.add(user.id);
                    const existing = markersRef.current[user.id];
                    const viewedChanged = existing && existing.viewed !== !!viewedStories[user.id];
                    const userChanged = existing && (existing.hasStory !== user.hasStory || existing.thought !== (user.thought || '') || viewedChanged || existing.emoji !== (user.currentEmoji || ''));
                    if (existing && existing.type === 'orbital' && !userChanged) {
                        existing.marker.updatePosition(orbitalPos.lat, orbitalPos.lng);
                    } else {
                        if (existing) removeMarker(user.id);
                        const marker = createUserMarker({ ...user, displayLat: orbitalPos.lat, displayLng: orbitalPos.lng }, googleMap, 38, false, true, index);
                        markersRef.current[user.id] = { marker, type: 'orbital', hasStory: user.hasStory, thought: user.thought || '', viewed: !!viewedStories[user.id], emoji: user.currentEmoji || '' };
                    }
                });
                
                [...farFromOrbit, ...closeButNotOrbital].forEach(user => {
                    activeMarkerIds.add(user.id);
                    const existing = markersRef.current[user.id];
                    const viewedChanged = existing && existing.viewed !== !!viewedStories[user.id];
                    const userChanged = existing && (existing.hasStory !== user.hasStory || existing.thought !== (user.thought || '') || viewedChanged || existing.emoji !== (user.currentEmoji || ''));
                    if (existing && existing.type === 'explorer' && !userChanged) {
                        existing.marker.updatePosition(user.latitude, user.longitude);
                    } else {
                        if (existing) removeMarker(user.id);
                        const marker = createUserMarker(user, googleMap, 22, false, false, -1);
                        markersRef.current[user.id] = { marker, type: 'explorer', hasStory: user.hasStory, thought: user.thought || '', viewed: !!viewedStories[user.id], emoji: user.currentEmoji || '' };
                    }
                });
                
                Object.keys(markersRef.current).forEach(userId => { if (!activeMarkerIds.has(userId)) removeMarker(userId); });
                // === RENDERIZAR PUNTOS DE ENCUENTRO ===
                const filteredPoints = selectedMeetingCategory === 'all' 
                    ? meetingPoints 
                    : meetingPoints.filter(p => p.category === selectedMeetingCategory);
                
                filteredPoints.forEach(point => {
                    const distanceToPoint = Math.round(calculateDistance(
                        currentUser.latitude, 
                        currentUser.longitude, 
                        point.location.latitude, 
                        point.location.longitude
                    ));
                    
                    // Solo mostrar puntos dentro de 500m
                    if (distanceToPoint > 500) return;
                    
                    // Contar usuarios en este punto (dentro de 30m del punto)
                    const usersAtPoint = users.filter(u => {
                        if (!u.isOnline || u.latitude === 0) return false;
                        const distanceToPointFromUser = Math.round(calculateDistance(
                            u.latitude,
                            u.longitude,
                            point.location.latitude,
                            point.location.longitude
                        ));
                        return distanceToPointFromUser <= point.captureRadius;
                    }).length;
                    
                    // Solo mostrar puntos con usuarios activos
// TEMP: Comentado para testing visual
// if (usersAtPoint === 0) return;
                    
                    const pointMarkerId = `point_${point.id}`;
                    activeMarkerIds.add(pointMarkerId);
                    
                    const existing = markersRef.current[pointMarkerId];
                    const pointChanged = existing && (existing.userCount !== usersAtPoint);
                    
                    if (existing && existing.type === 'meetingPoint' && !pointChanged) {
                        // Punto ya existe y no cambi√≥, no hacer nada
                    } else {
                        // Crear/recrear marker del punto
                        if (existing) removeMarker(pointMarkerId);
                        const marker = createMeetingPointMarker(point, googleMap, usersAtPoint);
                        markersRef.current[pointMarkerId] = { 
                            marker, 
                            type: 'meetingPoint', 
                            userCount: usersAtPoint 
                        };
                    }
                });
            }, [googleMap, currentUser?.latitude, currentUser?.longitude, currentUser?.thought, currentUser?.hasStory, users, radius, viewedStories, unreadMessages, userPreferences, markerRefreshTick, currentEmoji, selectedMeetingCategory, meetingPoints]);
            
            useEffect(() => {
                if (!googleMap || !currentUser?.latitude || currentUser.latitude === 0) return;
                const currentCenter = googleMap.getCenter();
                if (currentCenter && calculateDistance(currentCenter.lat(), currentCenter.lng(), currentUser.latitude, currentUser.longitude) < 20) return;
                googleMap.setCenter({ lat: currentUser.latitude, lng: currentUser.longitude });
            }, [googleMap, currentUser?.latitude, currentUser?.longitude]);

            useEffect(() => {
                if (!currentUser) return;
                const interval = setInterval(() => {
                    if (!document.hidden) db.collection('users').doc(currentUser.id).update({ isOnline: true, lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(() => {});
                }, 10000);
                return () => clearInterval(interval);
            }, [currentUser]);
            
            useEffect(() => { const interval = setInterval(() => setMarkerRefreshTick(t => t + 1), 30000); return () => clearInterval(interval); }, []);
            useEffect(() => { const h = () => { if (!document.hidden) setMarkerRefreshTick(t => t + 1); }; document.addEventListener('visibilitychange', h); return () => document.removeEventListener('visibilitychange', h); }, []);
            useEffect(() => { const h = () => setMarkerRefreshTick(t => t + 1); window.addEventListener('online', h); return () => window.removeEventListener('online', h); }, []);

            useEffect(() => {
                if (!currentUser?.latitude || users.length === 0) return;
                
                const closeUsers = users.filter(u => u.distance <= 100 && u.isOnline);
                const currentUserIds = new Set(closeUsers.map(u => u.id));
                
                if (!initialLoadComplete) { 
                    setKnownUserIds(currentUserIds); 
                    setInitialLoadComplete(true); 
                    return; 
                }
                
                closeUsers.forEach(user => {
                    if (!knownUserIds.has(user.id)) {
                        setSocialNotifications(prev => 
                            prev.some(n => n.userId === user.id) ? prev : 
                            [...prev, { id: `${user.id}-${Date.now()}`, userId: user.id, user, timestamp: Date.now() }]
                        );
                    }
                });
                
                setKnownUserIds(currentUserIds);
                
                const cleanup = setInterval(() => 
                    setSocialNotifications(prev => prev.filter(n => (Date.now() - n.timestamp) < 8000)), 
                    1000
                );
                
                return () => clearInterval(cleanup);
            }, [users, currentUser?.latitude]);

            // Story viewer auto-close
            useEffect(() => {
                if (!viewingStory) return;
                const timer = setTimeout(() => { 
                    setViewedStories(prev => ({ ...prev, [viewingStory.id]: Date.now() })); 
                    setViewingStory(null); 
                    setMarkerRefreshTick(t => t + 1);
                }, 5000);
                return () => clearTimeout(timer);
            }, [viewingStory]);

            // === NOTIFICACIONES PUSH - Verificar permisos ===
            useEffect(() => {
                const checkPermission = async () => {
                    if ('Notification' in window) {
                        hasNotificationPermission.current = Notification.permission === 'granted';
                    }
                };
                checkPermission();
            }, []);

            // === NOTIFICACIONES PUSH - Detectar usuarios cercanos ===
            useEffect(() => {
                if (!currentUser?.latitude || !hasNotificationPermission.current || !initialLoadComplete) return;
                
                users.forEach(user => {
                    if (!notifiedUsers.has(user.id) && 
                        user.distance <= 50 && 
                        document.hidden) {
                        
                        if (window.showProximityNotification) {
                            window.showProximityNotification(user);
                        }
                        setNotifiedUsers(prev => new Set([...prev, user.id]));
                    }
                });
                
                const currentUserIds = new Set(users.map(u => u.id));
                setNotifiedUsers(prev => {
                    const filtered = new Set([...prev].filter(id => currentUserIds.has(id)));
                    return filtered;
                });
                
            }, [users, currentUser?.latitude, notifiedUsers, initialLoadComplete]);

            // === NOTIFICACIONES PUSH - Verificar permisos ===

            // Handle Android back button
            const overlayOpenRef = React.useRef(false);
            
            useEffect(() => {
                const hasOverlay = showInbox || showSidebar || showProfile || selectedUser || showPreferences || showNearbyModal;
                
                if (hasOverlay && !overlayOpenRef.current) {
                    window.history.pushState({ overlay: true }, '');
                    overlayOpenRef.current = true;
                } else if (!hasOverlay && overlayOpenRef.current) {
                    overlayOpenRef.current = false;
                }
            }, [showInbox, showSidebar, showProfile, selectedUser, showPreferences, showNearbyModal]);

            useEffect(() => {
                const handleBackButton = () => {
                    const hasOverlay = selectedUser || showInbox || showProfile || showSidebar || showPreferences || showNearbyModal;
                    
                    if (hasOverlay) {
                        if (selectedUser) setSelectedUser(null);
                        else if (showInbox) setShowInbox(false);
                        else if (showProfile) setShowProfile(false);
                        else if (showSidebar) setShowSidebar(false);
                        else if (showPreferences) setShowPreferences(false);
else if (showNearbyModal) setShowNearbyModal(false);
overlayOpenRef.current = false;
                    } else if (currentUser) {
                        // En el mapa sin overlays: bloquear navegaci√≥n hacia atr√°s
                        window.history.pushState({ map: true }, '');
                    }
                };
                window.addEventListener('popstate', handleBackButton);
                return () => window.removeEventListener('popstate', handleBackButton);
            }, [showInbox, showSidebar, showProfile, selectedUser, showPreferences, showNearbyModal, currentUser]);
            const savePreferences = async () => {
                if (!currentUser?.id) return;
                await db.collection('users').doc(currentUser.id).update({ preferences: userPreferences, preferencesUpdated: firebase.firestore.FieldValue.serverTimestamp() });
                setShowPreferences(false);
            };
            const toggleInterest = (id) => setUserPreferences(prev => ({ ...prev, interests: prev.interests.includes(id) ? prev.interests.filter(i => i !== id) : [...prev.interests, id] }));
            const toggleLookingFor = (id) => setUserPreferences(prev => ({ ...prev, lookingFor: prev.lookingFor.includes(id) ? [] : [id] }));

            const handleGoogleSignIn = async () => { 
                try { 
                    const provider = new firebase.auth.GoogleAuthProvider();
                    provider.setCustomParameters({ prompt: 'select_account' });
                    await auth.signInWithRedirect(provider);
                } catch(e) { 
                    console.error('Error al iniciar sesi√≥n:', e);
                    alert('Error: ' + e.message); 
                } 
            };
            const handleLogout = async () => { 
                if (currentUser) {
                    try {
                        await db.collection('users').doc(currentUser.id).update({ isOnline: false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
                    } catch(e) { console.log('Logout update error:', e); }
                }
                // Clear map markers before logout
                Object.keys(markersRef.current).forEach(key => {
                    if (markersRef.current[key]?.marker?.setMap) {
                        markersRef.current[key].marker.setMap(null);
                    }
                });
                markersRef.current = {};
                setGoogleMap(null);
                setShowSidebar(false);
                await auth.signOut();
            };

            const handleThoughtSubmit = async () => {
                if (!thought.trim() || !currentUser) return;
                if (window.lastThoughtTimestamp && (Date.now() - window.lastThoughtTimestamp) / 60000 < 15) {
                    alert(`Espera ${Math.ceil(15 - (Date.now() - window.lastThoughtTimestamp) / 60000)} minutos`);
                    return;
                }
                const newThought = thought.trim();
                await db.collection('users').doc(currentUser.id).update({ thought: newThought, thoughtTimestamp: firebase.firestore.FieldValue.serverTimestamp() });
                setCurrentUser(prev => ({ ...prev, thought: newThought }));
                window.lastThoughtTimestamp = Date.now();
                setThought('');
            };

            const handleAvatarClick = (user) => {
    // Bloquear si es invitado haciendo click en otros
    if (currentUser?.isGuest && user.id !== currentUser.id) {
        alert('üëª Los invitados no pueden ver historias ni chatear. ¬°Reg√≠strate para interactuar!');
        return;
    }
    
    if (user.id === currentUser?.id) {
        if (currentUser.hasStory && currentUser.storyUrl) setViewingStory(currentUser);
        else {
            // Bloquear subir historia si es invitado
            if (currentUser.isGuest) {
                alert('üëª Los invitados no pueden subir historias. ¬°Reg√≠strate gratis!');
                return;
            }
            setShowStoryUpload(true);
        }
    } else {
        if (user.hasStory && user.storyUrl && !viewedStories[user.id]) { 
            setViewedStories(prev => ({ ...prev, [user.id]: Date.now() })); 
            setViewingStory(user); 
        }
        else { 
            setInstagramModalUser(user); 
            setShowInstagramModal(true); 
        }
    }
};

            const handleStoryImageSelect = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (ev) => setStoryImage(ev.target.result); reader.readAsDataURL(file); } };

            const handleStoryPublish = async () => {
                if (!storyImage || !currentUser) return;
                setUploadingStory(true);
                try {
                    const response = await fetch(storyImage);
                    const blob = await response.blob();
                    const ref = storage.ref().child(`stories/${currentUser.id}/${Date.now()}.jpg`);
                    await ref.put(blob);
                    const url = await ref.getDownloadURL();
                    await db.collection('users').doc(currentUser.id).update({ storyUrl: url, storyTimestamp: firebase.firestore.FieldValue.serverTimestamp() });
                    setCurrentUser(prev => ({ ...prev, hasStory: true, storyUrl: url, storyTimestamp: Date.now() }));
                    setStoryImage(null);
                    setShowStoryUpload(false);
                } catch(e) { alert('Error: ' + e.message); }
                setUploadingStory(false);
            };

            const openChat = (user) => {
                setSelectedUser(user);
                setShowInstagramModal(false);
                const chatId = [currentUser.id, user.id].sort().join('_');
                db.collection('chats').doc(chatId).update({ [`unreadCount_${currentUser.id}`]: 0 }).catch(() => {});
                setUnreadMessages(prev => { const u = { ...prev }; delete u[user.id]; return u; });
                db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp', 'asc').onSnapshot((snapshot) => {
                    const msgs = [];
                    snapshot.forEach((doc) => msgs.push({ id: doc.id, ...doc.data() }));
                    setMessages(prev => ({ ...prev, [chatId]: msgs }));
                    setTimeout(() => { if (chatMessagesRef.current) chatMessagesRef.current.scrollTop = chatMessagesRef.current.scrollHeight; }, 100);
                });
            };

            const sendMessage = async () => {
                if (!messageInput.trim() || !selectedUser || !currentUser) return;
                const chatId = [currentUser.id, selectedUser.id].sort().join('_');
                const text = messageInput.trim();
                setMessageInput('');
                try {
                    await db.collection('chats').doc(chatId).collection('messages').add({ text, senderId: currentUser.id, senderName: currentUser.name, senderPhoto: currentUser.photo, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                    await db.collection('chats').doc(chatId).set({ 
                        participants: [currentUser.id, selectedUser.id], 
                        lastMessage: text, 
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(), 
                        [`unreadCount_${selectedUser.id}`]: firebase.firestore.FieldValue.increment(1) 
                    }, { merge: true });
                    console.log('Mensaje enviado, incrementando unreadCount para:', selectedUser.id);
                } catch(e) {
                    console.error('Error enviando mensaje:', e);
                }
            };

            const sendQuickMessage = async () => {
                if (!quickMessage.trim() || !instagramModalUser || !currentUser) return;
                const chatId = [currentUser.id, instagramModalUser.id].sort().join('_');
                try {
                    await db.collection('chats').doc(chatId).collection('messages').add({ text: quickMessage.trim(), senderId: currentUser.id, senderName: currentUser.name, senderPhoto: currentUser.photo, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                    await db.collection('chats').doc(chatId).set({ 
                        participants: [currentUser.id, instagramModalUser.id], 
                        lastMessage: quickMessage.trim(), 
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(), 
                        [`unreadCount_${instagramModalUser.id}`]: firebase.firestore.FieldValue.increment(1) 
                    }, { merge: true });
                    console.log('Quick message enviado, incrementando unreadCount para:', instagramModalUser.id);
                } catch(e) {
                    console.error('Error enviando quick message:', e);
                }
                setQuickMessage('');
                setShowInstagramModal(false);
                openChat(instagramModalUser);
            };

            const sendLike = async () => {
                if (!instagramModalUser || !currentUser) return;
                const chatId = [currentUser.id, instagramModalUser.id].sort().join('_');
                try {
                    await db.collection('chats').doc(chatId).collection('messages').add({ text: '‚ù§Ô∏è', senderId: currentUser.id, senderName: currentUser.name, senderPhoto: currentUser.photo, timestamp: firebase.firestore.FieldValue.serverTimestamp(), type: 'like' });
                    await db.collection('chats').doc(chatId).set({ 
                        participants: [currentUser.id, instagramModalUser.id], 
                        lastMessage: '‚ù§Ô∏è', 
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(), 
                        [`unreadCount_${instagramModalUser.id}`]: firebase.firestore.FieldValue.increment(1) 
                    }, { merge: true });
                    console.log('Like enviado, incrementando unreadCount para:', instagramModalUser.id);
                } catch(e) {
                    console.error('Error enviando like:', e);
                }
                setShowInstagramModal(false);
            };

            const sendStoryReaction = async (emoji) => {
    if (!viewingStory || !currentUser || viewingStory.id === currentUser.id) return;
    
    setEmojiBurst(emoji);
    setTimeout(() => setEmojiBurst(null), 1500);
    
    const chatId = [currentUser.id, viewingStory.id].sort().join('_');
    try {
        await db.collection('chats').doc(chatId).collection('messages').add({ text: `Reaccion√≥ ${emoji} a tu historia`, senderId: currentUser.id, senderName: currentUser.name, senderPhoto: currentUser.photo, timestamp: firebase.firestore.FieldValue.serverTimestamp(), type: 'story_reaction', emoji });
        await db.collection('chats').doc(chatId).set({ 
            participants: [currentUser.id, viewingStory.id], 
            lastMessage: emoji, 
            lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(), 
            [`unreadCount_${viewingStory.id}`]: firebase.firestore.FieldValue.increment(1) 
        }, { merge: true });
        console.log('Story reaction enviada, incrementando unreadCount para:', viewingStory.id);
    } catch(e) {
        console.error('Error enviando story reaction:', e);
    }
    setViewedStories(prev => ({ ...prev, [viewingStory.id]: Date.now() }));
};

            const sendEmoji = async (emoji) => {
                if (!currentUser) return;
                const now = Date.now();
                setCurrentEmoji(emoji);
                setEmojiTimestamp(now);
                setShowEmojiPicker(false);
                setCurrentUser(prev => ({ ...prev, currentEmoji: emoji, emojiTimestamp: now }));
                await db.collection('users').doc(currentUser.id).update({ 
                    currentEmoji: emoji, 
                    emojiTimestamp: firebase.firestore.FieldValue.serverTimestamp() 
                });
                setTimeout(() => {
                    setCurrentEmoji(null);
                    setEmojiTimestamp(null);
                    setCurrentUser(prev => ({ ...prev, currentEmoji: null, emojiTimestamp: null }));
                }, 3000);
            };

            const formatMessageTime = (ts) => { if (!ts) return ''; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }); };
            const formatTimeAgo = (ts) => { if (!ts) return 'Hace un momento'; const t = typeof ts === 'number' ? ts : (ts.toMillis ? ts.toMillis() : ts); const m = Math.floor((Date.now() - t) / 60000); const h = Math.floor((Date.now() - t) / 3600000); if (m < 1) return 'Hace un momento'; if (m < 60) return `Hace ${m}m`; if (h < 24) return `Hace ${h}h`; return 'Hace m√°s de 1 d√≠a'; };

            if (!currentUser) {
    return (
        <div style={{ minHeight: '100vh', background: '#0d1117', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#fff', fontSize: '18px', flexDirection: 'column', gap: '20px' }}>
            <div>‚è≥ Cargando modo invitado...</div>
            <div style={{ fontSize: '14px', color: '#8b949e' }}>Esperando GPS y configuraci√≥n</div>
        </div>
    );
}

            const usersInRange = users.filter(u => u.distance <= radius && u.isOnline && u.latitude !== 0);
            const chatId = selectedUser ? [currentUser?.id, selectedUser.id].sort().join('_') : null;
            const chatMessages = chatId ? (messages[chatId] || []) : [];

            return (
                <>
                    <div className="main-container">
                        <div className="radar-container">
                            <div id="google-map" ref={mapRef}></div>
                            <div className="map-header">
    <svg className="header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" onClick={() => setShowSidebar(true)}><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    <div className="map-people-counter" onClick={() => setShowNearbyModal(true)} style={{ cursor: 'pointer' }}>
        <span className="map-people-counter-number">{usersInRange.length}</span>
        <span className="map-people-counter-text">cerca</span>
    </div>
    <div style={{ position: 'relative' }} onClick={() => setShowInbox(true)}>
        <svg className="header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
        {totalUnread > 0 && <div style={{ position: 'absolute', top: '-6px', right: '-6px', minWidth: '18px', height: '18px', background: 'linear-gradient(135deg,#ff6b35,#f7931e)', borderRadius: '9px', border: '2px solid #0d1117', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '10px', fontWeight: '700', color: '#fff', padding: '0 4px' }}>{totalUnread > 9 ? '9+' : totalUnread}</div>}
    </div>
    </div>

{/* === BARRA DE FILTROS DE PUNTOS === */}
<div className="meeting-points-filter-bar">
    <div className="meeting-filter-scroll">
        {meetingCategories.map(category => (
            <div 
                key={category.id}
                className={`meeting-filter-chip ${selectedMeetingCategory === category.id ? 'active' : ''}`}
                onClick={() => setSelectedMeetingCategory(category.id)}
            >
                <span className="meeting-filter-emoji">{category.emoji}</span>
                <span>{category.label}</span>
            </div>
        ))}
    </div>
</div>

{currentUser?.isGuest && (
    <div style={{
        position: 'absolute',
        bottom: '90px',
        left: '50%',
        transform: 'translateX(-50%)',
        background: 'rgba(22, 27, 34, 0.95)',
        backdropFilter: 'blur(12px)',
        border: '1px solid rgba(56, 189, 98, 0.3)',
        borderRadius: '16px',
        padding: '12px 20px',
        zIndex: 100,
        display: 'flex',
        alignItems: 'center',
        gap: '12px',
        maxWidth: '90%'
    }}>
        <span style={{ fontSize: '20px' }}>üëª</span>
        <div style={{ flex: 1 }}>
            <div style={{ fontSize: '13px', fontWeight: '600', color: '#f0f6fc' }}>Modo Invitado</div>
            <div style={{ fontSize: '11px', color: '#8b949e' }}>Reg√≠strate para chatear</div>
        </div>
        <button 
            onClick={() => window.location.href = 'index.html'}
            style={{
                padding: '8px 16px',
                background: '#38bd62',
                border: 'none',
                borderRadius: '8px',
                color: '#fff',
                fontSize: '12px',
                fontWeight: '600',
                cursor: 'pointer'
            }}
        >
            Registrarme
        </button>
    </div>
)}
                        </div>
                    
                        <div className="thought-input-container">
                            <div className="thought-input-wrapper">
                                <div className={`emoji-picker ${showEmojiPicker ? 'active' : ''}`}>
                                    {reactionEmojis.map(emoji => (
                                        <div key={emoji} className="emoji-picker-item" onClick={() => sendEmoji(emoji)}>{emoji}</div>
                                    ))}
                                </div>
                                <svg className="thought-input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" onClick={() => setShowEmojiPicker(!showEmojiPicker)} style={{ color: showEmojiPicker ? '#38bd62' : '#8696a0' }}><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                                <input type="text" className="thought-input" placeholder="Mensaje" value={thought} onChange={(e) => setThought(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleThoughtSubmit()} maxLength={15} onFocus={() => setShowEmojiPicker(false)}/>
                            </div>
                            <button className="send-button" onClick={handleThoughtSubmit}><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
                        </div>
                    </div>

                    <div className={`overlay-backdrop ${showSidebar ? 'active' : ''}`} onClick={() => setShowSidebar(false)}/>
                    <div className={`sidebar ${showSidebar ? 'active' : ''}`}>
                        <div className="sidebar-header"><h2>Men√∫</h2><svg style={{ width: 24, height: 24, cursor: 'pointer', color: '#8b949e' }} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" onClick={() => setShowSidebar(false)}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></div>
                        <div className="sidebar-content">
                            <div className="sidebar-item" onClick={() => { setShowProfile(true); setShowSidebar(false); }}><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><span>Mi Perfil</span></div>
                            <div className="sidebar-item" onClick={() => { setShowInbox(true); setShowSidebar(false); }}><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg><span>Mensajes</span></div>
                            <div className="sidebar-item" onClick={() => { setShowTechSettings(true); setShowSidebar(false); }}><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg><span>Tecnolog√≠as</span></div>
                            <div className="sidebar-item" onClick={() => { setShowStoryUpload(true); setShowSidebar(false); }}><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg><span>Subir Historia</span></div>
                            <div className="sidebar-item" onClick={() => { setShowPreferences(true); setShowSidebar(false); }}><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg><span>Mis Preferencias</span></div>
                            
                            <div className="radius-slider-section">
                                <div className="radius-slider-label">
                                    <span className="radius-slider-title">Radio de b√∫squeda</span>
                                    <span className="radius-slider-value">{radius}m</span>
                                </div>
                                <div className="radius-slider-track" 
                                    onMouseDown={(e) => { const rect = e.currentTarget.getBoundingClientRect(); setRadius(Math.round(Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width)) * 1000)); setIsDraggingDial(true); }} 
                                    onMouseMove={(e) => { if (!isDraggingDial) return; const rect = e.currentTarget.getBoundingClientRect(); setRadius(Math.round(Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width)) * 1000)); }} 
                                    onMouseUp={() => setIsDraggingDial(false)} 
                                    onMouseLeave={() => setIsDraggingDial(false)} 
                                    onTouchStart={(e) => { const rect = e.currentTarget.getBoundingClientRect(); setRadius(Math.round(Math.max(0, Math.min(1, (e.touches[0].clientX - rect.left) / rect.width)) * 1000)); setIsDraggingDial(true); }} 
                                    onTouchMove={(e) => { if (!isDraggingDial) return; const rect = e.currentTarget.getBoundingClientRect(); setRadius(Math.round(Math.max(0, Math.min(1, (e.touches[0].clientX - rect.left) / rect.width)) * 1000)); }} 
                                    onTouchEnd={() => setIsDraggingDial(false)}>
                                    <div className="radius-slider-progress" style={{ width: `${(radius/1000)*100}%` }}/>
                                    <div className="radius-slider-thumb" style={{ left: `${(radius/1000)*100}%` }}/>
                                </div>
                                <div className="radius-slider-marks">
                                    <span className="radius-slider-mark">0m</span>
                                    <span className="radius-slider-mark">500m</span>
                                    <span className="radius-slider-mark">1km</span>
                                </div>
                            </div>
                            
                            <div className="sidebar-item" style={{ marginTop: 'auto', color: '#f87171' }} onClick={handleLogout}><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg><span>Cerrar Sesi√≥n</span></div>
                        </div>
                    </div>

                    <div className={`profile-overlay ${showProfile ? 'active' : ''}`}>
                        <div className="profile-header"><svg style={{ width: 24, height: 24, cursor: 'pointer', color: '#8b949e' }} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" onClick={() => setShowProfile(false)}><polyline points="15 18 9 12 15 6"/></svg><h2>Mi Perfil</h2></div>
                        <div className="profile-content">
                            <div className="profile-avatar-section"><img src={currentUser?.photo} alt={currentUser?.name} className="profile-avatar-large"/><h2 className="profile-name">{currentUser?.name}</h2><p className="profile-bio">{currentUser?.thought || 'Sin pensamiento actual'}</p></div>
                            <div className="profile-section"><h3 className="profile-section-title">Informaci√≥n</h3><div className="profile-field"><span className="profile-field-label">Email</span><span className="profile-field-value">{currentUser?.email}</span></div><div className="profile-field"><span className="profile-field-label">Estado</span><span className="profile-field-value" style={{ color: '#38bd62' }}>‚óè En l√≠nea</span></div><div className="profile-field"><span className="profile-field-label">Historia</span><span className="profile-field-value">{currentUser?.hasStory ? 'üì∏ Activa' : 'Sin historia'}</span></div></div>
                            <div className="profile-section"><h3 className="profile-section-title">Ubicaci√≥n</h3><div className="profile-field"><span className="profile-field-label">Precisi√≥n GPS</span><span className="profile-field-value">¬±{locationAccuracy.toFixed(1)}m</span></div><div className="profile-field"><span className="profile-field-label">Tecnolog√≠a</span><span className="profile-field-value">{activeTech.icon} {activeTech.name}</span></div></div>
                        </div>
                    </div>

                    <div className={`inbox-panel ${showInbox ? 'active' : ''}`}>
                        <div className="inbox-stories">
                            <div className="inbox-story-item" onClick={() => setShowInbox(false)}>
                                {currentUser?.thought && <div className="inbox-bubble">{currentUser.thought}</div>}
                                <div className={`inbox-story-ring ${currentUser?.hasStory ? 'has-story' : ''}`}>
                                    <img src={currentUser?.photo} alt="Tu nota" className="inbox-story-img"/>
                                </div>
                                {!currentUser?.thought && <div className="inbox-add-btn">+</div>}
                                <span className="inbox-story-name">Tu nota</span>
                            </div>
                            {users.filter(u => u.isOnline && u.latitude !== 0).sort((a,b) => {
                                const aViewed = viewedStories[a.id];
                                const bViewed = viewedStories[b.id];
                                const aHasUnviewed = a.hasStory && !aViewed;
                                const bHasUnviewed = b.hasStory && !bViewed;
                                if (aHasUnviewed && !bHasUnviewed) return -1;
                                if (!aHasUnviewed && bHasUnviewed) return 1;
                                return a.distance - b.distance;
                            }).slice(0,10).map(user => (
                               <div key={user.id} className="inbox-story-item" onClick={() => { 
    if (user.hasStory && !viewedStories[user.id]) { 
        setViewedStories(prev => ({ ...prev, [user.id]: Date.now() })); 
        setViewingStory(user);
        // Marcar mensajes como le√≠dos tambi√©n
        if (unreadMessages[user.id]) {
            const chatId = [currentUser.id, user.id].sort().join('_');
            db.collection('chats').doc(chatId).update({ [`unreadCount_${currentUser.id}`]: 0 }).catch(() => {});
            setUnreadMessages(prev => { const u = { ...prev }; delete u[user.id]; return u; });
        }
    } else { 
        openChat(user); 
        setShowInbox(false); 
    }
}}>
                                    {user.thought && <div className="inbox-bubble">{user.thought}</div>}
                                    <div className={`inbox-story-ring ${user.hasStory && !viewedStories[user.id] ? 'has-story' : unreadMessages[user.id] ? 'has-unread' : ''}`}>
                                        <img src={user.photo} alt={user.name} className="inbox-story-img"/>
                                    </div>
                                    <span className="inbox-story-name">{user.name.split(' ')[0]} / {user.distance}m</span>
                                </div>
                            ))}
                        </div>
                        <div className="inbox-tabs-bar">
                            <div className={`inbox-tab-btn ${inboxTab === 'messages' ? 'active' : ''}`} onClick={() => setInboxTab('messages')}>Mensajes</div>
                            <div className={`inbox-tab-btn ${inboxTab === 'requests' ? 'active' : ''}`} onClick={() => setInboxTab('requests')}>Solicitudes</div>
                        </div>
                        <div className="inbox-conversations">
                            {users.length === 0 ? <div className="inbox-no-chats"><p>No hay conversaciones</p></div> :
                            users.filter(u => u.isOnline).sort((a,b) => a.distance - b.distance).map(user => (
                                <div key={user.id} className="inbox-conv-item" onClick={() => { openChat(user); setShowInbox(false); }}>
                                    <div className="inbox-conv-avatar-wrap">
                                        <img src={user.photo} alt={user.name} className="inbox-conv-avatar" style={unreadMessages[user.id] ? { border: '3px solid #f7d046' } : {}}/>
                                        {user.isOnline && <div className="inbox-conv-online"/>}
                                    </div>
                                    <div className="inbox-conv-info">
                                        <span className="inbox-conv-name" style={unreadMessages[user.id] ? { fontWeight: '700' } : {}}>{user.name}</span>
                                        <span className="inbox-conv-preview">{user.thought ? `"${user.thought}"` : 'Toca para chatear'}</span>
                                    </div>
                                    <span className="inbox-conv-dist">{user.distance}m</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className={`preferences-overlay ${showPreferences ? 'active' : ''}`}>
                        <div className="preferences-container">
                            <div className="preferences-header"><h2>‚öôÔ∏è Mis Preferencias</h2><div className="preferences-close" onClick={() => setShowPreferences(false)}><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></div></div>
                            <div className="preferences-section"><div className="preferences-section-title">üë§ Mi informaci√≥n</div><div className="preferences-row"><span className="preferences-label">Mi edad</span><input type="number" className="preferences-input" value={userPreferences.age} onChange={(e) => setUserPreferences(prev => ({ ...prev, age: parseInt(e.target.value) || 18 }))} min="18" max="99"/></div><div className="preferences-row"><span className="preferences-label">Mi g√©nero</span><select className="preferences-select" value={userPreferences.gender} onChange={(e) => setUserPreferences(prev => ({ ...prev, gender: e.target.value }))}><option value="">Prefiero no decir</option><option value="male">Hombre</option><option value="female">Mujer</option><option value="other">Otro</option></select></div></div>
                            <div className="preferences-section"><div className="preferences-section-title">üîç Busco personas</div><div className="preferences-row"><span className="preferences-label">Rango de edad</span><div className="age-range-container"><input type="number" className="preferences-input" value={userPreferences.ageRangeMin} onChange={(e) => setUserPreferences(prev => ({ ...prev, ageRangeMin: parseInt(e.target.value) || 18 }))} min="18" max="99"/><span className="age-range-separator">-</span><input type="number" className="preferences-input" value={userPreferences.ageRangeMax} onChange={(e) => setUserPreferences(prev => ({ ...prev, ageRangeMax: parseInt(e.target.value) || 99 }))} min="18" max="99"/></div></div><div className="preferences-row"><span className="preferences-label">G√©nero</span><select className="preferences-select" value={userPreferences.genderPreference} onChange={(e) => setUserPreferences(prev => ({ ...prev, genderPreference: e.target.value }))}><option value="all">Todos</option><option value="male">Hombres</option><option value="female">Mujeres</option><option value="other">Otro</option></select></div></div>
                            <div className="preferences-section"><div className="preferences-section-title">üí´ Mis intereses</div><div className="interests-grid">{availableInterests.map(interest => (<div key={interest.id} className={`interest-chip ${userPreferences.interests.includes(interest.id) ? 'selected' : ''}`} onClick={() => toggleInterest(interest.id)}>{interest.label}</div>))}</div></div>
                            <div className="preferences-section"><div className="preferences-section-title">üéØ ¬øQu√© busco ahora?</div><div className="looking-for-grid">{lookingForOptions.map(option => (<div key={option.id} className={`looking-for-option ${userPreferences.lookingFor.includes(option.id) ? 'selected' : ''}`} onClick={() => toggleLookingFor(option.id)}><div className="looking-for-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg></div><span className="looking-for-label">{option.label}</span></div>))}</div></div>
                            <div className="preferences-section" style={{ borderBottom: 'none' }}><button className="preferences-save-btn" onClick={savePreferences}>üíæ Guardar Preferencias</button></div>
                        </div>
                    </div>

                    <div className={`tech-settings-overlay ${showTechSettings ? 'active' : ''}`}>
                        <div className="tech-settings-header"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ width: 24, height: 24, cursor: 'pointer', color: '#8b949e' }} onClick={() => setShowTechSettings(false)}><polyline points="15 18 9 12 15 6"/></svg><h2>Tecnolog√≠as de Precisi√≥n</h2></div>
                        <div className="tech-settings-content">
                            <div className="tech-mode-selector"><h3>Modo de Operaci√≥n</h3><div className="tech-mode-options"><div className={`tech-mode-option ${techSettings.mode === 'auto' ? 'active' : ''}`} onClick={() => setTechSettings(prev => ({ ...prev, mode: 'auto' }))}><div className="icon">ü§ñ</div><div className="label">Auto</div><div className="description">Selecci√≥n inteligente</div></div><div className={`tech-mode-option ${techSettings.mode === 'manual' ? 'active' : ''}`} onClick={() => setTechSettings(prev => ({ ...prev, mode: 'manual' }))}><div className="icon">‚öôÔ∏è</div><div className="label">Manual</div><div className="description">Control total</div></div></div></div>
                            <div className="tech-list"><h3>Tecnolog√≠as Disponibles</h3><div className={`tech-item ${techSettings.mode === 'auto' ? 'disabled' : ''}`}><div className="tech-item-info"><div className="tech-item-name"><span className="tech-item-icon">üìç</span>GPS Est√°ndar</div><div className="tech-item-description">Ubicaci√≥n satelital. Precisi√≥n: 5-15m</div></div><div className={`tech-toggle ${techSettings.gps ? 'active' : ''}`} onClick={() => techSettings.mode !== 'auto' && setTechSettings(prev => ({ ...prev, gps: !prev.gps }))}/></div><div className={`tech-item ${techSettings.mode === 'auto' ? 'disabled' : ''}`}><div className="tech-item-info"><div className="tech-item-name"><span className="tech-item-icon">üéØ</span>Filtro Kalman</div><div className="tech-item-description">Suaviza GPS. Precisi√≥n: 2-5m</div></div><div className={`tech-toggle ${techSettings.kalman ? 'active' : ''}`} onClick={() => techSettings.mode !== 'auto' && setTechSettings(prev => ({ ...prev, kalman: !prev.kalman }))}/></div><div className={`tech-item ${techSettings.mode === 'auto' ? 'disabled' : ''}`}><div className="tech-item-info"><div className="tech-item-name"><span className="tech-item-icon">üì∂</span>Bluetooth BLE</div><div className="tech-item-description">{bleSupported ? 'Detecta cercanos. Precisi√≥n: 1-10m' : 'No disponible'}</div></div><div className={`tech-toggle ${techSettings.ble && bleSupported ? 'active' : ''}`} onClick={() => techSettings.mode !== 'auto' && bleSupported && setTechSettings(prev => ({ ...prev, ble: !prev.ble }))}/></div></div>
                        </div>
                    </div>

                    <div className={`story-upload-overlay ${showStoryUpload ? 'active' : ''}`}>
                        <div className="story-upload-container">
                            <div className="story-upload-header"><h2>Nueva Historia</h2><div className="story-upload-close" onClick={() => { setShowStoryUpload(false); setStoryImage(null); }}><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></div></div>
                            <div className="story-preview-area">{storyImage ? <><img src={storyImage} alt="Preview"/><div className="story-remove-btn" onClick={() => setStoryImage(null)}><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></div></> : <div className="story-preview-placeholder"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg><span>Selecciona una imagen</span></div>}</div>
                            <div className="story-upload-actions"><label className="story-select-btn"><svg style={{ width: 20, height: 20 }} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>Galer√≠a<input type="file" accept="image/*" style={{ display: 'none' }} onChange={handleStoryImageSelect}/></label><button className="story-publish-btn" disabled={!storyImage || uploadingStory} onClick={handleStoryPublish}>{uploadingStory ? 'Subiendo...' : <><svg style={{ width: 20, height: 20 }} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>Publicar</>}</button></div>
                        </div>
                    </div>

                    <div className={`story-viewer ${viewingStory ? 'active' : ''}`}>
                        {viewingStory && (
                            <div className="story-container">
                                <div className="story-progress-bar"><div className="story-progress-fill" key={viewingStory.id}></div></div>
                                <div className="story-header"><div className="story-user-info"><img src={viewingStory.photo} alt={viewingStory.name} className="story-user-avatar"/><div style={{ display: 'flex', flexDirection: 'column' }}><span className="story-user-name">{viewingStory.name}</span><span style={{ fontSize: '11px', color: 'rgba(255,255,255,0.6)' }}>{formatTimeAgo(viewingStory.storyTimestamp)}</span></div></div><div className="story-close" onClick={() => { setViewedStories(prev => ({ ...prev, [viewingStory.id]: Date.now() })); setViewingStory(null); }}><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></div></div>
                                <img src={viewingStory.storyUrl} alt="Story" className="story-image"/>
                                {viewingStory.id !== currentUser?.id && (<><div className="story-reactions">{['‚ù§Ô∏è', 'üî•', 'üòç', 'üòÇ', 'üëè'].map(emoji => (<button key={emoji} className="story-reaction-btn" onClick={() => sendStoryReaction(emoji)}>{emoji}</button>))}</div><button className="story-message-btn" onClick={() => { setViewingStory(null); openChat(viewingStory); }}><svg style={{ width: 20, height: 20 }} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Enviar mensaje</button></>)}
                            </div>
                        )}
                    </div>

                    <>
<>
<div className={`instagram-modal-backdrop ${showInstagramModal ? 'active' : ''}`} onClick={() => setShowInstagramModal(false)}/>
<div className={`instagram-modal ${showInstagramModal ? 'active' : ''}`}>
{instagramModalUser && (<><div className="instagram-modal-header"><img src={instagramModalUser.photo} alt={instagramModalUser.name} className="instagram-modal-avatar"/><div className="instagram-modal-info"><div className="instagram-modal-name">{instagramModalUser.name}</div><div className="instagram-modal-distance"> A {instagramModalUser.distance}m {instagramModalUser.thought && `‚Ä¢ "${instagramModalUser.thought}"`}</div></div><div className="instagram-modal-menu-btn"><svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="5" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="19" r="1.5"/></svg></div></div><div className="instagram-modal-actions"><input type="text" className="instagram-modal-input" placeholder="Enviar mensaje..." value={quickMessage} onChange={(e) => setQuickMessage(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && sendQuickMessage()}/><button className="instagram-modal-send" onClick={sendQuickMessage} disabled={!quickMessage.trim()}><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button></div></>)}
</div>
{showInstagramModal && (
  <div className="instagram-modal-close-btn" onClick={() => setShowInstagramModal(false)}>
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
      <line x1="18" y1="6" x2="6" y2="18"/>
      <line x1="6" y1="6" x2="18" y2="18"/>
    </svg>
  </div>
)}
</>
)}
</>

                    <div className={`nearby-modal ${showNearbyModal ? 'active' : ''}`}>
    <div className="nearby-modal-header">
        <svg style={{ width: 24, height: 24, cursor: 'pointer', color: '#8b949e' }} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" onClick={() => setShowNearbyModal(false)}>
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        <h2>Personas Cerca ({users.filter(u => u.isOnline && u.latitude !== 0).length})</h2>
    </div>
    <div className="nearby-modal-content">
        {users.filter(u => u.isOnline && u.latitude !== 0)
            .sort((a, b) => a.distance - b.distance)
            .map(user => {
                const lookingForEmoji = user.preferences?.lookingFor?.[0] 
                    ? lookingForOptions.find(opt => opt.id === user.preferences.lookingFor[0])?.emoji 
                    : 'üë•';
                const lookingForLabel = user.preferences?.lookingFor?.[0]
                    ? lookingForOptions.find(opt => opt.id === user.preferences.lookingFor[0])?.label.replace(/^.+\s/, '')
                    : 'Conexi√≥n';
                
                return (
                    <div key={user.id} className="nearby-user-item" onClick={() => { 
                        setShowNearbyModal(false); 
                        handleAvatarClick(user); 
                    }}>
                        <div className="nearby-user-avatar-wrap">
                            {user.hasStory && !viewedStories[user.id] ? (
                                <div className="nearby-user-story-ring">
                                    <img src={user.photo} alt={user.name} className="nearby-user-story-img"/>
                                </div>
                            ) : (
                                <img src={user.photo} alt={user.name} className="nearby-user-avatar"/>
                            )}
                        </div>
                        <div className="nearby-user-info">
                            <div className="nearby-user-name">
                                {user.name}
                                {user.hasStory && <span style={{ fontSize: '12px' }}>üì∏</span>}
                            </div>
                            <div className="nearby-user-looking">
                                {lookingForEmoji} {lookingForLabel}
                            </div>
                            {user.thought && (
                                <div className="nearby-user-thought">"{user.thought}"</div>
                            )}
                        </div>
                        <div className="nearby-user-distance">
                            <span className="nearby-user-meters">{user.distance}m</span>
                        </div>
                    </div>
                );
            })}
        {users.filter(u => u.isOnline && u.latitude !== 0).length === 0 && (
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '200px', color: '#6e7681', fontSize: '14px' }}>
                No hay personas cerca en este momento
            </div>
        )}
    </div>
</div>
                    <div className={`chat-overlay ${selectedUser ? 'active' : ''}`}>
                        {selectedUser && (<><div className="chat-header"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ width: 24, height: 24, cursor: 'pointer', color: '#aebac1' }} onClick={() => setSelectedUser(null)}><polyline points="15 18 9 12 15 6"/></svg><div className="chat-user-info"><img src={selectedUser.photo} alt={selectedUser.name} className="chat-user-avatar"/><div className="chat-user-details"><h3>{selectedUser.name}</h3><p>A {selectedUser.distance}m ‚Ä¢ {selectedUser.isOnline ? 'En l√≠nea' : 'Desconectado'}</p></div></div></div><div className="chat-content"><div className="chat-messages" ref={chatMessagesRef}>{chatMessages.length === 0 ? <div className="chat-info">¬°Inicia una conversaci√≥n con {selectedUser.name}!<br/>Est√°n a solo {selectedUser.distance}m de distancia.</div> : chatMessages.map((msg) => (<div key={msg.id} className={`message ${msg.senderId === currentUser?.id ? 'sent' : 'received'}`}>{msg.type === 'like' ? <span style={{ fontSize: '24px' }}>‚ù§Ô∏è</span> : msg.text}<span className="message-time">{formatMessageTime(msg.timestamp)}</span></div>))}</div><div className="chat-input-container"><input type="text" className="chat-input" placeholder="Escribe un mensaje..." value={messageInput} onChange={(e) => setMessageInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && sendMessage()}/><button className="chat-send-btn" onClick={sendMessage} disabled={!messageInput.trim()}><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button></div></div></>)}
                    </div>

                    {socialNotifications.map((notification, index) => (
                        <div key={notification.id} className="social-notification" style={{ top: `${100 + index * 110}px` }}>
                            <button className="social-notification-close" onClick={() => setSocialNotifications(prev => prev.filter(n => n.id !== notification.id))}><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                            <div className="social-notification-header"><img src={notification.user.photo} alt={notification.user.name} className="social-notification-avatar"/><div className="social-notification-info"><div className="social-notification-name">{notification.user.name}</div><div className="social-notification-distance">üìç A {notification.user.distance}m de ti</div></div></div>
                            <div className="social-notification-message">¬°{notification.user.name.split(' ')[0]} est√° cerca! ¬øTe animas a saludarle?</div>
                            <div className="social-notification-actions"><button className="social-notification-btn social-notification-btn-primary" onClick={() => { openChat(notification.user); setSocialNotifications(prev => prev.filter(n => n.id !== notification.id)); }}><svg style={{ width: 16, height: 16 }} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Saludar</button><button className="social-notification-btn social-notification-btn-secondary" onClick={() => setSocialNotifications(prev => prev.filter(n => n.id !== notification.id))}>Ahora no</button></div>
                        </div>
                    ))}
                    
                    {emojiBurst && (
                        <div className="emoji-burst-container">
                            {[...Array(20)].map((_, i) => (
                                <span 
                                    key={i} 
                                    className="emoji-bubble" 
                                    style={{ 
                                        left: `${10 + Math.random() * 80}%`, 
                                        bottom: `${Math.random() * 30}%`,
                                        animationDelay: `${Math.random() * 0.3}s`,
                                        fontSize: `${24 + Math.random() * 24}px`
                                    }}
                                >
                                    {emojiBurst}
                                </span>
                            ))}
                        </div>
                    )}
                </>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<RadarSocialApp />);
    </script>
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered:', reg.scope))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>
    <script>
// === SISTEMA DE NOTIFICACIONES PUSH ===
async function requestNotificationPermission() {
    if (!('Notification' in window)) {
        console.log('Browser no soporta notificaciones');
        return false;
    }
    
    if (Notification.permission === 'granted') {
        return true;
    }
    
    if (Notification.permission !== 'denied') {
        const permission = await Notification.requestPermission();
        return permission === 'granted';
    }
    
    return false;
}

// Mostrar notificaci√≥n cuando alguien aparece cerca
function showProximityNotification(user) {
    if (Notification.permission !== 'granted') return;
    
    const distance = user.distance;
    let title, body, emoji;
    
    // Personalizar mensaje seg√∫n distancia
    if (distance < 10) {
        emoji = '‚ö°';
        title = `¬°WOW! ${user.name.split(' ')[0]} est√° a solo ${distance}m`;
        body = '¬øTe animas a saludar? Podr√≠an estar en el mismo lugar';
    } else if (distance < 25) {
        emoji = 'üëã';
        title = `${user.name.split(' ')[0]} est√° cerca (${distance}m)`;
        body = user.thought || 'An√≠mate y sal√∫dalo';
    } else if (distance < 50) {
        emoji = 'üí´';
        title = `${user.name.split(' ')[0]} acaba de conectarse`;
        body = `A ${distance}m de ti`;
    } else {
        emoji = 'üìç';
        title = `Nueva persona cerca`;
        body = `${user.name.split(' ')[0]} ‚Ä¢ ${distance}m`;
    }
    
    const notification = new Notification(title, {
        body: body,
        icon: user.photo,
        badge: 'https://em-content.zobj.net/thumbs/240/apple/354/waving-hand_1f44b.png',
        tag: `proximity-${user.id}`,
        requireInteraction: false,
        silent: false,
        vibrate: [200, 100, 200],
        data: {
            userId: user.id,
            userName: user.name,
            distance: distance,
            timestamp: Date.now()
        }
    });
    
    notification.onclick = function(event) {
        event.preventDefault();
        window.focus();
        // Abrir modal de ese usuario
        const clickEvent = new CustomEvent('openUserModal', { 
            detail: { userId: user.id } 
        });
        window.dispatchEvent(clickEvent);
        notification.close();
    };
    
    // Auto-cerrar despu√©s de 8 segundos
    setTimeout(() => notification.close(), 8000);
}

// Solicitar permisos al cargar la app
window.addEventListener('load', async () => {
    const hasPermission = await requestNotificationPermission();
    if (hasPermission) {
        console.log('‚úÖ Notificaciones habilitadas');
    } else {
        console.log('‚ö†Ô∏è Notificaciones bloqueadas');
    }
});
</script>
</body>
</html>
