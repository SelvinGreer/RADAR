<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NexMe</title>
    <!-- v7.9.0 Build: 2025-12-11 | Interest filtering, profile interests display, movement intelligence -->
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Encuentra y conecta con personas cerca de ti">
    <meta name="theme-color" content="#0d1117">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA2kFaHgj0LpeB3MJBUTG_piDyW_zJ1wzU&libraries=places,geometry"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100vh;
            height: 100dvh;
        }

        #root {
            width: 100%;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            padding: 0;
        }

        .radar-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #google-map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .map-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            background: linear-gradient(180deg, rgba(13, 17, 23, 0.95) 0%, rgba(13, 17, 23, 0.7) 70%, transparent 100%);
            backdrop-filter: blur(12px);
            padding: max(env(safe-area-inset-top), 12px) 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            color: #c9d1d9;
        }

        .map-people-counter {
            background: rgba(13, 17, 23, 0.9);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 8px 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(56, 189, 98, 0.2);
        }

        .map-people-counter-number {
            font-size: 16px;
            font-weight: 700;
            color: #38bd62;
        }

        .map-people-counter-text {
            font-size: 12px;
            color: rgba(230, 237, 243, 0.8);
        }

        /* Badges container removed in v6.2 */

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* v6.1 FIX: Slider position adjusted */
        .range-slider-container {
            position: fixed;
            left: 50%;
            bottom: 80px;
            transform: translateX(-50%);
            z-index: 50;
            width: 300px;
            padding: 12px 0;
        }

        .range-slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 0 4px;
        }

        .range-slider-title {
            font-size: 11px;
            font-weight: 600;
            color: rgba(139, 148, 158, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .range-slider-value {
            font-size: 18px;
            font-weight: 700;
            color: #38bd62;
        }

        .range-slider-track {
            position: relative;
            width: 100%;
            height: 4px;
            background: rgba(48, 54, 61, 0.4);
            border-radius: 2px;
            cursor: pointer;
        }

        .range-slider-progress {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, rgba(56, 189, 98, 0.6) 0%, #38bd62 100%);
            border-radius: 2px;
        }

        .range-slider-thumb {
            position: absolute;
            top: 50%;
            width: 18px;
            height: 18px;
            background: linear-gradient(145deg, #38bd62 0%, #2ea556 100%);
            border: 3px solid #0d1117;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: grab;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4), 0 0 16px rgba(56, 189, 98, 0.6);
        }

        .range-slider-marks {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            padding: 0 4px;
        }

        .range-slider-mark {
            font-size: 9px;
            color: rgba(139, 148, 158, 0.4);
            font-weight: 500;
        }

        /* v6.1 FIX: Input container - fixed bottom, no safe-area */
        .thought-input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 15;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            padding: 50px 12px 16px 12px;
            background: linear-gradient(to bottom, 
                rgba(13, 17, 23, 0) 0%, 
                rgba(13, 17, 23, 0.8) 40%, 
                rgba(13, 17, 23, 1) 70%,
                rgba(13, 17, 23, 1) 100%
            );
        }

        .thought-input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            background: #1f2c34;
            border-radius: 24px;
            padding: 6px 12px;
            gap: 8px;
            border: 1px solid rgba(134, 150, 160, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .thought-input-icon {
            width: 24px;
            height: 24px;
            color: #8696a0;
            cursor: pointer;
            flex-shrink: 0;
            transition: color 0.2s ease;
        }

        .thought-input-icon:hover {
            color: #aebac1;
        }

        .thought-input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 8px 4px;
            color: #e9edef;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            outline: none;
            min-width: 0;
        }

        .thought-input::placeholder {
            color: #8696a0;
        }

        .thought-icons-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .send-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #00a884;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: background 0.2s ease;
        }

        .send-button:hover {
            background: #06cf9c;
        }

        .send-button:active {
            background: #008f72;
        }

        .send-button svg {
            width: 22px;
            height: 22px;
            color: #fff;
        }

        /* GPS Waiting Screen */
        .location-permission {
            position: fixed;
            inset: 0;
            background: rgba(13, 17, 23, 0.97);
            backdrop-filter: blur(20px);
            z-index: 400;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
        }

        .permission-card {
            background: rgba(22, 27, 34, 0.95);
            border: 1px solid rgba(48, 54, 61, 0.6);
            border-radius: 18px;
            padding: 34px 26px;
            text-align: center;
            max-width: 350px;
        }

        .permission-icon {
            width: 68px;
            height: 68px;
            margin: 0 auto 22px;
            color: #58a6ff;
        }

        .permission-card h2 {
            font-size: 21px;
            color: #f0f6fc;
            margin-bottom: 11px;
        }

        .permission-card p {
            color: #8b949e;
            line-height: 1.6;
            font-size: 14px;
        }

        .gps-dots {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .gps-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #38bd62;
            animation: pulse 1s ease-in-out infinite;
        }

        .gps-dot:nth-child(2) { animation-delay: 0.2s; }
        .gps-dot:nth-child(3) { animation-delay: 0.4s; }

        /* Landing Page - Redesigned v6.2 */
        /* Avatar breathing animations */
        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.04); }
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            15% { transform: scale(1.08); }
            30% { transform: scale(1); }
            45% { transform: scale(1.06); }
            60% { transform: scale(1); }
        }

        /* Overlays */
        .sidebar, .profile-overlay, .inbox-overlay, .tech-settings-overlay, .chat-overlay {
            position: fixed;
            inset: 0;
            background: #0d1117;
            z-index: 200;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .sidebar {
            width: 280px;
            transform: translateX(-100%);
            border-right: 1px solid rgba(48, 54, 61, 0.5);
        }

        .sidebar.active, .profile-overlay.active, .inbox-overlay.active, 
        .tech-settings-overlay.active, .chat-overlay.active {
            transform: translateX(0);
        }

        .overlay-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 150;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .overlay-backdrop.active {
            opacity: 1;
            pointer-events: all;
        }

        /* Common header styles */
        .sidebar-header, .profile-header, .inbox-header, .tech-settings-header, .chat-header {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 20px;
            background: rgba(22, 27, 34, 0.95);
            border-bottom: 1px solid rgba(48, 54, 61, 0.5);
        }

        .sidebar-header h2, .profile-header h2, .inbox-header h2, .tech-settings-header h2 {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
            color: #f0f6fc;
            margin: 0;
        }

        .sidebar-content, .profile-content, .inbox-list, .tech-settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px 0;
        }

        .sidebar-item {
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            color: #c9d1d9;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .sidebar-item:hover {
            background: rgba(48, 54, 61, 0.3);
        }

        .sidebar-item svg {
            width: 22px;
            height: 22px;
            color: #8b949e;
        }

        /* Profile */
        .profile-content {
            padding: 24px 20px;
        }

        .profile-avatar-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 28px;
        }

        .profile-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid rgba(88, 166, 255, 0.3);
            object-fit: cover;
            margin-bottom: 16px;
        }

        .profile-name {
            font-size: 24px;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 4px;
        }

        .profile-bio {
            color: #8b949e;
            text-align: center;
            font-size: 14px;
        }

        .profile-section {
            margin-bottom: 24px;
        }

        .profile-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #8b949e;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .profile-field {
            background: rgba(22, 27, 34, 0.6);
            border: 1px solid rgba(48, 54, 61, 0.4);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .profile-field-label {
            color: #8b949e;
            font-size: 14px;
        }

        .profile-field-value {
            color: #f0f6fc;
            font-size: 14px;
            font-weight: 500;
        }

        /* Inbox */
        .inbox-list {
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        /* Notes/Thoughts Section - Horizontal scroll */
        .inbox-notes-section {
            padding: 40px 0 16px 0;
            border-bottom: 1px solid rgba(48, 54, 61, 0.5);
        }

        .inbox-notes-scroll {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding: 0 16px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .inbox-notes-scroll::-webkit-scrollbar {
            display: none;
        }

        .inbox-note-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 72px;
            cursor: pointer;
        }

        .inbox-note-avatar-container {
            position: relative;
            margin-bottom: 6px;
        }

        .inbox-note-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            object-fit: cover;
        }

        .inbox-note-ring {
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            padding: 3px;
        }

        .inbox-note-ring.has-story {
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
        }

        .inbox-note-ring.online {
            background: #38bd62;
        }

        .inbox-note-ring.default {
            background: #404040;
        }

        .inbox-note-ring-inner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: #0d1117;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .inbox-note-thought {
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            background: #3a3a3a;
            color: #e0e0e0;
            padding: 6px 10px;
            border-radius: 14px;
            font-size: 11px;
            white-space: nowrap;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .inbox-note-thought::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background: #3a3a3a;
            border-radius: 50%;
        }

        .inbox-note-name {
            font-size: 11px;
            color: #e6edf3;
            text-align: center;
            max-width: 72px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .inbox-note-distance {
            font-size: 10px;
            color: #38bd62;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .inbox-note-add {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: rgba(56, 189, 98, 0.1);
            border: 2px dashed rgba(56, 189, 98, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #38bd62;
            font-size: 24px;
        }

        /* Tabs */
        .inbox-tabs {
            display: flex;
            border-bottom: 1px solid rgba(48, 54, 61, 0.5);
        }

        .inbox-tab {
            flex: 1;
            padding: 14px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #8b949e;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .inbox-tab.active {
            color: #f0f6fc;
            border-bottom-color: #f0f6fc;
        }

        .inbox-tab-badge {
            background: #f85149;
            color: #fff;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
        }

        /* Chat Items */
        .inbox-chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .inbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .inbox-item:hover {
            background: rgba(22, 27, 34, 0.6);
        }

        .inbox-item:active {
            background: rgba(22, 27, 34, 0.8);
        }

        .inbox-avatar-container {
            position: relative;
        }

        .inbox-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            object-fit: cover;
        }

        .inbox-online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            background: #38bd62;
            border: 3px solid #0d1117;
            border-radius: 50%;
        }

        .inbox-info {
            flex: 1;
            min-width: 0;
        }

        .inbox-name-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .inbox-name {
            font-size: 15px;
            font-weight: 600;
            color: #f0f6fc;
        }

        .inbox-time {
            font-size: 12px;
            color: #6e7681;
        }

        .inbox-preview {
            font-size: 14px;
            color: #8b949e;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .inbox-preview.unread {
            color: #f0f6fc;
            font-weight: 500;
        }

        .inbox-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .inbox-favorite {
            color: #6e7681;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .inbox-favorite.active {
            color: #f7d046;
        }

        .inbox-unread-dot {
            width: 10px;
            height: 10px;
            background: #58a6ff;
            border-radius: 50%;
        }

        .inbox-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #6e7681;
            padding: 40px 20px;
        }

        .inbox-empty svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.4;
        }

        /* Tech Settings */
        .tech-settings-content {
            padding: 20px;
        }

        .tech-mode-selector {
            margin-bottom: 30px;
        }

        .tech-mode-selector h3, .tech-list h3 {
            font-size: 14px;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 12px;
            text-transform: uppercase;
        }

        .tech-mode-options {
            display: flex;
            gap: 12px;
        }

        .tech-mode-option {
            flex: 1;
            padding: 12px;
            background: rgba(22, 27, 34, 0.5);
            border: 2px solid rgba(48, 54, 61, 0.5);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
        }

        .tech-mode-option.active {
            background: rgba(56, 189, 98, 0.15);
            border-color: rgba(56, 189, 98, 0.6);
        }

        .tech-mode-option .icon {
            font-size: 24px;
            margin-bottom: 6px;
        }

        .tech-mode-option .label {
            font-size: 12px;
            font-weight: 600;
            color: #c9d1d9;
        }

        .tech-mode-option.active .label {
            color: #38bd62;
        }

        .tech-mode-option .description {
            font-size: 10px;
            color: #8b949e;
            margin-top: 4px;
        }

        .tech-list {
            margin-top: 20px;
        }

        .tech-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: rgba(22, 27, 34, 0.5);
            border: 1px solid rgba(48, 54, 61, 0.5);
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .tech-item.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .tech-item-info {
            flex: 1;
        }

        .tech-item-name {
            font-size: 15px;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tech-item-icon {
            font-size: 18px;
        }

        .tech-item-description {
            font-size: 12px;
            color: #8b949e;
        }

        .tech-toggle {
            position: relative;
            width: 50px;
            height: 28px;
            background: rgba(139, 148, 158, 0.3);
            border-radius: 14px;
            cursor: pointer;
        }

        .tech-toggle.active {
            background: rgba(56, 189, 98, 0.5);
        }

        .tech-toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: #8b949e;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .tech-toggle.active::after {
            left: 25px;
            background: #38bd62;
        }

        /* Preferences Panel */
        .preferences-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .preferences-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .preferences-container {
            background: #161b22;
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid rgba(48, 54, 61, 0.5);
        }

        .preferences-header {
            padding: 20px;
            border-bottom: 1px solid rgba(48, 54, 61, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: #161b22;
            z-index: 10;
        }

        .preferences-header h2 {
            margin: 0;
            font-size: 18px;
            color: #e6edf3;
        }

        .preferences-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(139, 148, 158, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .preferences-close svg {
            width: 18px;
            height: 18px;
            color: #8b949e;
        }

        .preferences-section {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(48, 54, 61, 0.3);
        }

        .preferences-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #8b949e;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .preferences-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .preferences-label {
            font-size: 14px;
            color: #e6edf3;
        }

        .preferences-select {
            background: #21262d;
            border: 1px solid rgba(48, 54, 61, 0.5);
            border-radius: 8px;
            padding: 8px 12px;
            color: #e6edf3;
            font-size: 14px;
            outline: none;
            min-width: 120px;
        }

        .preferences-input {
            background: #21262d;
            border: 1px solid rgba(48, 54, 61, 0.5);
            border-radius: 8px;
            padding: 8px 12px;
            color: #e6edf3;
            font-size: 14px;
            outline: none;
            width: 70px;
            text-align: center;
        }

        .age-range-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .age-range-separator {
            color: #8b949e;
        }

        /* Interest chips */
        .interests-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .interest-chip {
            padding: 8px 14px;
            background: #21262d;
            border: 1px solid rgba(48, 54, 61, 0.5);
            border-radius: 20px;
            font-size: 13px;
            color: #8b949e;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .interest-chip.selected {
            background: rgba(56, 189, 98, 0.2);
            border-color: #38bd62;
            color: #38bd62;
        }

        .interest-chip:hover {
            border-color: #8b949e;
        }

        /* Looking for options */
        .looking-for-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .looking-for-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #21262d;
            border: 1px solid rgba(48, 54, 61, 0.5);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .looking-for-option.selected {
            background: rgba(56, 189, 98, 0.15);
            border-color: #38bd62;
        }

        .looking-for-checkbox {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid #8b949e;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .looking-for-option.selected .looking-for-checkbox {
            background: #38bd62;
            border-color: #38bd62;
        }

        .looking-for-checkbox svg {
            width: 14px;
            height: 14px;
            color: #fff;
            opacity: 0;
        }

        .looking-for-option.selected .looking-for-checkbox svg {
            opacity: 1;
        }

        .looking-for-label {
            font-size: 14px;
            color: #e6edf3;
        }

        .preferences-save-btn {
            width: 100%;
            padding: 14px;
            background: #38bd62;
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: background 0.2s ease;
        }

        .preferences-save-btn:hover {
            background: #2ea44f;
        }

        /* Direction indicator for far users */
        .direction-indicator {
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 2px;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
        }

        .direction-indicator.approaching {
            color: #38bd62;
        }

        .direction-indicator.leaving {
            color: #f85149;
        }

        .direction-arrow {
            font-size: 10px;
        }

        /* Chat */
        .chat-header {
            background: #1f2c33;
            border: none;
        }

        .chat-user-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .chat-user-details h3 {
            font-size: 16px;
            font-weight: 400;
            color: #e9edef;
            margin: 0;
        }

        .chat-user-details p {
            font-size: 13px;
            color: #8696a0;
            margin: 0;
        }

        .chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: #0b141a;
        }

        .chat-info {
            background: rgba(22, 27, 34, 0.6);
            border: 1px solid rgba(48, 54, 61, 0.3);
            padding: 12px 16px;
            border-radius: 10px;
            color: #8b949e;
            font-size: 13px;
            text-align: center;
        }

        .message {
            max-width: 75%;
            padding: 6px 7px 8px 9px;
            border-radius: 8px;
            font-size: 14.2px;
            line-height: 19px;
            position: relative;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
            margin-bottom: 2px;
        }

        .message.sent {
            background: #005c4b;
            color: #e9edef;
            align-self: flex-end;
            border-radius: 8px 8px 0 8px;
        }

        .message.received {
            background: #1f2c33;
            color: #e9edef;
            align-self: flex-start;
            border-radius: 0 8px 8px 8px;
        }

        .message-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin-left: 8px;
            float: right;
            margin-top: 4px;
        }

        .chat-input-container {
            padding: 5px 8px;
            background: #1f2c33;
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            background: #2a3942;
            border: none;
            border-radius: 20px;
            padding: 10px 12px;
            color: #e9edef;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            outline: none;
        }

        .chat-input::placeholder {
            color: #8696a0;
        }

        .chat-send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #00a884;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .chat-send-btn:disabled {
            background: #182229;
        }

        .chat-send-btn svg {
            color: #0b141a;
            width: 24px;
            height: 24px;
        }

        .chat-send-btn:disabled svg {
            color: #8696a0;
        }

        /* Instagram Modal */
        .instagram-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9998;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .instagram-modal-backdrop.active {
            opacity: 1;
            pointer-events: all;
        }

        .instagram-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(13, 17, 23, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 20px 20px 0 0;
            padding: 20px;
            z-index: 9999;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .instagram-modal.active {
            transform: translateY(0);
        }

        .instagram-modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .instagram-modal-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(142, 142, 142, 0.3);
        }

        .instagram-modal-info {
            flex: 1;
        }

        .instagram-modal-name {
            font-size: 16px;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 4px;
        }

        .instagram-modal-distance {
            font-size: 14px;
            color: #8b949e;
        }

        .instagram-modal-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .instagram-modal-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            padding: 12px 20px;
            color: #e6edf3;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            outline: none;
        }

        .instagram-modal-input::placeholder {
            color: #6e7681;
        }

        .instagram-modal-heart {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .instagram-modal-heart svg {
            width: 28px;
            height: 28px;
            color: #f0f6fc;
        }

        /* Story Viewer */
        .story-viewer {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .story-viewer.active {
            opacity: 1;
            visibility: visible;
        }

        .story-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .story-progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            z-index: 10;
        }

        .story-progress-fill {
            height: 100%;
            background: #fff;
            animation: storyProgress 5s linear forwards;
        }

        @keyframes storyProgress {
            from { width: 0%; }
            to { width: 100%; }
        }

        .story-header {
            position: absolute;
            top: 16px;
            left: 16px;
            right: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }

        .story-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .story-user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #fff;
            object-fit: cover;
        }

        .story-user-name {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .story-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .story-close svg {
            width: 20px;
            height: 20px;
            color: #fff;
        }

        .story-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .story-reactions {
            position: absolute;
            bottom: 110px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 11;
        }

        .story-reaction-btn {
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
            transition: transform 0.15s ease, background 0.15s ease;
            z-index: 10;
        }

        .story-reaction-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
        }

        .story-reaction-btn:active {
            transform: scale(0.95);
            background: rgba(56, 189, 98, 0.4);
        }

        .story-message-btn {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            padding: 14px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50px;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            z-index: 11;
        }

        /* Story Upload */
        .story-upload-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 300;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .story-upload-overlay.active {
            display: flex;
        }

        .story-upload-container {
            width: 100%;
            max-width: 500px;
            background: #161b22;
            border-radius: 16px;
            padding: 24px;
        }

        .story-upload-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .story-upload-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: #f0f6fc;
            margin: 0;
        }

        .story-upload-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
        }

        .story-upload-close svg {
            width: 20px;
            height: 20px;
            color: #8b949e;
        }

        .story-preview-area {
            width: 100%;
            aspect-ratio: 9/16;
            max-height: 60vh;
            background: #0d1117;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
        }

        .story-preview-area img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .story-preview-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            color: #6e7681;
        }

        .story-preview-placeholder svg {
            width: 64px;
            height: 64px;
        }

        .story-upload-actions {
            display: flex;
            gap: 12px;
        }

        .story-select-btn, .story-publish-btn {
            flex: 1;
            height: 48px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .story-select-btn {
            background: rgba(56, 189, 98, 0.15);
            color: #38bd62;
            border: 1px solid rgba(56, 189, 98, 0.3);
        }

        .story-publish-btn {
            background: linear-gradient(135deg, #38bd62 0%, #2d9d51 100%);
            color: #fff;
        }

        .story-publish-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .story-remove-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .story-remove-btn svg {
            width: 20px;
            height: 20px;
            color: #fff;
        }

        /* Social Notifications */
        .social-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(22, 27, 34, 0.98);
            border: 1px solid rgba(56, 189, 98, 0.3);
            border-radius: 16px;
            padding: 16px 20px;
            max-width: 340px;
            width: calc(100% - 40px);
            z-index: 9998;
            backdrop-filter: blur(10px);
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .social-notification-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .social-notification-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 2px solid rgba(56, 189, 98, 0.5);
            object-fit: cover;
        }

        .social-notification-info {
            flex: 1;
        }

        .social-notification-name {
            font-size: 15px;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 2px;
        }

        .social-notification-distance {
            font-size: 13px;
            color: #8b949e;
        }

        .social-notification-message {
            font-size: 14px;
            color: #c9d1d9;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .social-notification-actions {
            display: flex;
            gap: 8px;
        }

        .social-notification-btn {
            flex: 1;
            height: 38px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .social-notification-btn-primary {
            background: linear-gradient(135deg, #38bd62 0%, #2d9d51 100%);
            color: #fff;
        }

        .social-notification-btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: #8b949e;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .social-notification-close {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .social-notification-close svg {
            width: 14px;
            height: 14px;
            color: #8b949e;
        }

        /* Avatar animation */
        @keyframes magnetPull {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.15); opacity: 1; }
            80% { transform: scale(0.95); }
            100% { transform: scale(1); opacity: 1; }
        }

        .avatar-entering {
            animation: magnetPull 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        html {
            overscroll-behavior: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAhcfX0M5oqX7rZ6WdCZaHfxHKcxySxQl8",
            authDomain: "radar-social-5a61f.firebaseapp.com",
            projectId: "radar-social-5a61f",
            storageBucket: "radar-social-5a61f.firebasestorage.app",
            messagingSenderId: "1010787643000",
            appId: "1:1010787643000:web:e9dc6a1c175d875b90478d"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        function NexMeApp() {
            // State
            const [radius, setRadius] = useState(1000);
            const [thought, setThought] = useState('');
            const [currentUser, setCurrentUser] = useState(null);
            const [userLocation, setUserLocation] = useState(null);
            const [users, setUsers] = useState([]);
            const [markerRefreshTick, setMarkerRefreshTick] = useState(0);
            const [selectedUser, setSelectedUser] = useState(null);
            const [showInstagramModal, setShowInstagramModal] = useState(false);
            const [instagramModalUser, setInstagramModalUser] = useState(null);
            const [quickMessage, setQuickMessage] = useState('');
            const [messages, setMessages] = useState({});
            const [messageInput, setMessageInput] = useState('');
            const [showSidebar, setShowSidebar] = useState(false);
            const [showProfile, setShowProfile] = useState(false);
            const [showInbox, setShowInbox] = useState(false);
            const [showTechSettings, setShowTechSettings] = useState(false);
            const [showStoryUpload, setShowStoryUpload] = useState(false);
            const [storyImage, setStoryImage] = useState(null);
            const [uploadingStory, setUploadingStory] = useState(false);
            const [viewingStory, setViewingStory] = useState(null);
            const [viewedStories, setViewedStories] = useState({});
            const [socialNotifications, setSocialNotifications] = useState([]);
            const [googleMap, setGoogleMap] = useState(null);
            const [waitingForGPS, setWaitingForGPS] = useState(true);
            const [locationAccuracy, setLocationAccuracy] = useState(20);
            const [isDraggingDial, setIsDraggingDial] = useState(false);
            const [enteringUsers, setEnteringUsers] = useState(new Set());
            const [lastSeenUsers, setLastSeenUsers] = useState({});
            const [inboxTab, setInboxTab] = useState('messages'); // 'messages' or 'requests'
            const [favoriteUsers, setFavoriteUsers] = useState([]);
            const [chatHistory, setChatHistory] = useState([]); // Lista de chats con historial
            const [initialLoadComplete, setInitialLoadComplete] = useState(false); // Para evitar notificaciones al conectar
            const [knownUserIds, setKnownUserIds] = useState(new Set()); // IDs de usuarios ya conocidos
            const [unreadMessages, setUnreadMessages] = useState({}); // {oderId: count}
            const [totalUnread, setTotalUnread] = useState(0); // Total de mensajes no ledos
            const [showPreferences, setShowPreferences] = useState(false); // Panel de preferencias
            
            // Preferencias de usuario
            const [userPreferences, setUserPreferences] = useState({
                age: 25,
                gender: '', // '', 'male', 'female', 'other'
                interests: [],
                lookingFor: [], // ['friendship', 'casual', 'networking', 'romance']
                ageRangeMin: 18,
                ageRangeMax: 50,
                genderPreference: 'all' // 'all', 'male', 'female', 'other'
            });
            
            // Lista de intereses disponibles
            const availableInterests = [
                { id: 'gym', label: ' Gym', emoji: '' },
                { id: 'coffee', label: ' Caf', emoji: '' },
                { id: 'party', label: ' Fiesta', emoji: '' },
                { id: 'reading', label: ' Lectura', emoji: '' },
                { id: 'gaming', label: ' Gaming', emoji: '' },
                { id: 'music', label: ' Msica', emoji: '' },
                { id: 'travel', label: ' Viajes', emoji: '' },
                { id: 'food', label: ' Comida', emoji: '' },
                { id: 'sports', label: ' Deportes', emoji: '' },
                { id: 'art', label: ' Arte', emoji: '' },
                { id: 'movies', label: ' Cine', emoji: '' },
                { id: 'nature', label: ' Naturaleza', emoji: '' },
                { id: 'tech', label: ' Tecnologa', emoji: '' },
                { id: 'pets', label: ' Mascotas', emoji: '' },
                { id: 'yoga', label: ' Yoga', emoji: '' },
                { id: 'dance', label: ' Baile', emoji: '' }
            ];
            
            // Opciones de "Qu busco"
            const lookingForOptions = [
                { id: 'friendship', label: ' Amistad', emoji: '' },
                { id: 'casual', label: ' Conexin casual', emoji: '' },
                { id: 'networking', label: ' Networking', emoji: '' },
                { id: 'romance', label: ' Romance', emoji: '' }
            ];
            
            // Historial de posiciones para inteligencia de movimiento
            const userPositionHistory = useRef({}); // {oderId: [{lat, lng, timestamp}, ...]}
            
            // Calcular velocidad y direccin de un usuario
            const calculateMovement = (userId, currentLat, currentLng) => {
                const history = userPositionHistory.current[userId] || [];
                const now = Date.now();
                
                // Agregar posicin actual al historial
                history.push({ lat: currentLat, lng: currentLng, timestamp: now });
                
                // Mantener solo las ltimas 5 posiciones (ltimos ~15 segundos)
                if (history.length > 5) history.shift();
                userPositionHistory.current[userId] = history;
                
                // Necesitamos al menos 2 puntos para calcular movimiento
                if (history.length < 2) {
                    return { speed: 0, direction: 0, approaching: null };
                }
                
                const oldest = history[0];
                const newest = history[history.length - 1];
                const timeDiff = (newest.timestamp - oldest.timestamp) / 1000; // segundos
                
                if (timeDiff < 1) return { speed: 0, direction: 0, approaching: null };
                
                // Calcular distancia recorrida
                const distance = calculateDistance(oldest.lat, oldest.lng, newest.lat, newest.lng);
                const speed = distance / timeDiff; // m/s
                const speedKmh = speed * 3.6; // km/h
                
                // Calcular direccin (ngulo en radianes)
                const direction = Math.atan2(
                    newest.lng - oldest.lng,
                    newest.lat - oldest.lat
                ) * (180 / Math.PI); // convertir a grados
                
                return { speed: speedKmh, direction, approaching: null };
            };
            
            // Determinar si usuario se acerca o aleja
            const isApproaching = (userId, userLat, userLng, myLat, myLng) => {
                const history = userPositionHistory.current[userId] || [];
                if (history.length < 2) return null;
                
                const oldest = history[0];
                const newest = history[history.length - 1];
                
                const oldDistance = calculateDistance(oldest.lat, oldest.lng, myLat, myLng);
                const newDistance = calculateDistance(newest.lat, newest.lng, myLat, myLng);
                
                const diff = oldDistance - newDistance;
                if (Math.abs(diff) < 5) return null; // Menos de 5m de diferencia = esttico
                
                return diff > 0; // true = acercndose, false = alejndose
            };
            
            // Audio para notificaciones
            const notificationSound = useRef(null);
            
            // Crear sonido de notificacin (suave ping)
            useEffect(() => {
                // Crear un AudioContext para generar el sonido
                const createNotificationSound = () => {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800; // Frecuencia del tono
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                };
                
                notificationSound.current = createNotificationSound;
            }, []);
            
            const [techSettings, setTechSettings] = useState({
                mode: 'auto', gps: true, kalman: true, deadReckoning: false, ultrasonic: false, ble: true
            });
            const [activeTech, setActiveTech] = useState({ name: 'GPS', icon: '', precision: 5.0 });
            const [bleDevices, setBleDevices] = useState([]); // Dispositivos BLE detectados
            const [bleSupported, setBleSupported] = useState(false);
            
            const mapRef = useRef(null);
            const chatMessagesRef = useRef(null);
            const markersRef = useRef({}); // Changed to object: { oderId: {marker, overlay, lat, lng} }
            const lastMarkersDataRef = useRef('');
            const lastTickRef = useRef(0);
            const currentUserPositionRef = useRef({ lat: 0, lng: 0 });
            
            // Kalman Filter State
            const kalmanState = useRef({
                lat: { x: 0, p: 1, q: 0.00001, r: 0.001 }, // q=process noise, r=measurement noise
                lng: { x: 0, p: 1, q: 0.00001, r: 0.001 }
            });
            
            // Kalman Filter Implementation
            const applyKalmanFilter = (measurement, state) => {
                // Prediction
                const p_pred = state.p + state.q;
                
                // Update
                const k = p_pred / (p_pred + state.r); // Kalman gain
                const x_new = state.x + k * (measurement - state.x);
                const p_new = (1 - k) * p_pred;
                
                return { x: x_new, p: p_new, q: state.q, r: state.r };
            };
            
            const filterGPSWithKalman = (lat, lng, accuracy) => {
                // Initialize if first reading
                if (kalmanState.current.lat.x === 0) {
                    kalmanState.current.lat.x = lat;
                    kalmanState.current.lng.x = lng;
                    return { lat, lng };
                }
                
                // Adjust measurement noise based on GPS accuracy
                const r = Math.max(0.0001, accuracy / 100000);
                kalmanState.current.lat.r = r;
                kalmanState.current.lng.r = r;
                
                // Apply Kalman filter
                kalmanState.current.lat = applyKalmanFilter(lat, kalmanState.current.lat);
                kalmanState.current.lng = applyKalmanFilter(lng, kalmanState.current.lng);
                
                return {
                    lat: kalmanState.current.lat.x,
                    lng: kalmanState.current.lng.x
                };
            };
            
            // BLE Scanner - Check support and scan
            useEffect(() => {
                // Check if Web Bluetooth is supported
                if ('bluetooth' in navigator) {
                    setBleSupported(true);
                    console.log(' BLE: Bluetooth API disponible');
                } else {
                    setBleSupported(false);
                    console.log(' BLE: Bluetooth API no disponible en este navegador');
                }
            }, []);
            
            const startBLEScan = async () => {
                if (!bleSupported || !techSettings.ble) return;
                
                try {
                    console.log(' BLE: Iniciando escaneo...');
                    
                    // Request device with generic filter
                    const device = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices: ['battery_service', 'device_information']
                    });
                    
                    if (device) {
                        console.log(' BLE: Dispositivo encontrado:', device.name);
                        
                        // Try to get RSSI for distance estimation
                        const server = await device.gatt?.connect();
                        if (server) {
                            // Estimate distance from RSSI (simplified)
                            // Note: Real RSSI requires native APIs, this is a simulation
                            const estimatedDistance = Math.random() * 10 + 1; // 1-11m simulated
                            
                            setBleDevices(prev => {
                                const existing = prev.find(d => d.id === device.id);
                                if (existing) {
                                    return prev.map(d => d.id === device.id ? { ...d, distance: estimatedDistance, lastSeen: Date.now() } : d);
                                }
                                return [...prev, { 
                                    id: device.id, 
                                    name: device.name || 'Desconocido', 
                                    distance: estimatedDistance,
                                    lastSeen: Date.now()
                                }];
                            });
                            
                            setActiveTech({ name: 'BLE + GPS', icon: '', precision: 3.0 });
                            await server.disconnect();
                        }
                    }
                } catch (error) {
                    if (error.name !== 'NotFoundError') {
                        console.log(' BLE: Error de escaneo:', error.message);
                    }
                }
            };
            
            // Auto-update active technology based on context
            const updateActiveTechnology = (accuracy, isMoving, nearbyUsers) => {
                if (techSettings.mode !== 'auto') return;
                
                const hasNearbyBLE = bleDevices.some(d => (Date.now() - d.lastSeen) < 30000);
                const hasVeryNearUsers = nearbyUsers.some(u => u.distance < 10);
                
                if (hasNearbyBLE && hasVeryNearUsers && techSettings.ble) {
                    setActiveTech({ name: 'BLE + Kalman', icon: '', precision: 1.5 });
                } else if (techSettings.kalman && accuracy < 30) {
                    setActiveTech({ name: 'GPS + Kalman', icon: '', precision: Math.max(2, accuracy / 3) });
                } else {
                    setActiveTech({ name: 'GPS', icon: '', precision: accuracy });
                }
            };

            // Simple distance calculation
            const calculateDistance = (lat1, lon1, lat2, lon2) => {
                const R = 6371e3;
                const 1 = lat1 * Math.PI / 180;
                const 2 = lat2 * Math.PI / 180;
                const  = (lat2 - lat1) * Math.PI / 180;
                const  = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin( / 2) * Math.sin( / 2) +
                          Math.cos(1) * Math.cos(2) * Math.sin( / 2) * Math.sin( / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            };

            // Simplified initial location - wait for good GPS
            const getInitialLocation = () => {
                return new Promise((resolve) => {
                    let attempts = 0;
                    const maxAttempts = 5;
                    
                    const tryGetLocation = () => {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const { latitude, longitude, accuracy } = position.coords;
                                if (accuracy < 50 || attempts >= maxAttempts) {
                                    console.log(` GPS OK: ${latitude.toFixed(6)}, ${longitude.toFixed(6)} (${accuracy.toFixed(0)}m)`);
                                    resolve({ latitude, longitude, accuracy });
                                } else {
                                    attempts++;
                                    setTimeout(tryGetLocation, 1000);
                                }
                            },
                            (error) => {
                                attempts++;
                                if (attempts < maxAttempts) setTimeout(tryGetLocation, 1000);
                                else resolve(null);
                            },
                            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                        );
                    };
                    tryGetLocation();
                });
            };

            // Initialize Google Map - centered on user with FIXED zoom and pan limit
            const FIXED_ZOOM = 15;
            
            const initializeGoogleMap = (lat, lng) => {
                if (!mapRef.current || googleMap) return;
                
                // Save user position for pan limits
                currentUserPositionRef.current = { lat, lng };
                
                const darkStyle = [
                    { elementType: 'geometry', stylers: [{ color: '#0d1117' }] },
                    { elementType: 'labels.text.stroke', stylers: [{ color: '#0d1117' }] },
                    { elementType: 'labels.text.fill', stylers: [{ color: '#8696a0' }] },
                    { featureType: 'poi', stylers: [{ visibility: 'off' }] },
                    { featureType: 'transit', stylers: [{ visibility: 'off' }] },
                    { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#1f2933' }] },
                    { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0a1520' }] }
                ];
                
                const map = new google.maps.Map(mapRef.current, {
                    center: { lat, lng },
                    zoom: FIXED_ZOOM,
                    minZoom: FIXED_ZOOM,
                    maxZoom: FIXED_ZOOM,
                    styles: darkStyle,
                    disableDefaultUI: true,
                    zoomControl: false,
                    gestureHandling: 'greedy',
                    clickableIcons: false
                });
                
                // Force zoom to stay fixed
                map.addListener('zoom_changed', () => {
                    if (map.getZoom() !== FIXED_ZOOM) {
                        map.setZoom(FIXED_ZOOM);
                    }
                });
                
                // Limit pan to 1km radius from user position
                map.addListener('dragend', () => {
                    const center = map.getCenter();
                    const userPos = currentUserPositionRef.current;
                    const distance = calculateDistance(userPos.lat, userPos.lng, center.lat(), center.lng());
                    
                    if (distance > 1000) {
                        // Calculate point at 1km in same direction
                        const bearing = Math.atan2(
                            center.lng() - userPos.lng,
                            center.lat() - userPos.lat
                        );
                        const maxLat = userPos.lat + (0.009 * Math.cos(bearing)); // ~1km
                        const maxLng = userPos.lng + (0.009 * Math.sin(bearing)); // ~1km
                        map.panTo({ lat: maxLat, lng: maxLng });
                    }
                });
                
                setGoogleMap(map);
                console.log(' Map initialized at:', lat, lng);
            };

            // Create user marker on map - Instagram Notes style
            const createUserMarker = (user, map, size, isCurrentUser = false, isOrbital = true, orbitalIndex = -1) => {
                const markerDiv = document.createElement('div');
                markerDiv.style.cssText = `display:flex;flex-direction:column;align-items:center;cursor:pointer;position:relative;`;
                
                // Determine thought bubble side based on orbital position
                // Circle positions: 0=top, 1=top-right, 2=right, 3=bottom-right, 4=bottom, 5=bottom-left, 6=left, 7=top-left
                // Right side (thought goes RIGHT): 0, 1, 2, 3 (top to bottom-right)
                // Left side (thought goes LEFT): 4, 5, 6, 7 (bottom to top-left)
                const isRightSide = orbitalIndex >= 0 && orbitalIndex <= 3;
                const isExplorer = !isOrbital && !isCurrentUser;
                
                // Thought bubble with circles (Instagram Notes style) - for ALL users including current user
                if (user.thought && user.thought.trim()) {
                    // Main bubble container
                    const bubbleContainer = document.createElement('div');
                    
                    if (isCurrentUser) {
                        // Current user: 10 o'clock position (left side)
                        bubbleContainer.style.cssText = `
                            position: absolute;
                            top: -3px;
                            left: -45px;
                            display: flex;
                            flex-direction: column;
                            align-items: flex-end;
                            z-index: 10;
                        `;
                    } else if (isOrbital && isRightSide) {
                        // Orbital on RIGHT side (indices 0,1,2,3): thought goes to the RIGHT (2 o'clock)
                        bubbleContainer.style.cssText = `
                            position: absolute;
                            top: 0px;
                            left: ${size - 8}px;
                            display: flex;
                            flex-direction: column;
                            align-items: flex-start;
                            z-index: 10;
                        `;
                    } else if (isOrbital) {
                        // Orbital on LEFT side (indices 4,5,6,7): thought goes to the LEFT (10 o'clock)
                        bubbleContainer.style.cssText = `
                            position: absolute;
                            top: 0px;
                            right: ${size - 8}px;
                            display: flex;
                            flex-direction: column;
                            align-items: flex-end;
                            z-index: 10;
                        `;
                    } else {
                        // Far users (not orbital): thought goes to the LEFT (10 o'clock)
                        bubbleContainer.style.cssText = `
                            position: absolute;
                            top: 0px;
                            right: ${size - 4}px;
                            display: flex;
                            flex-direction: column;
                            align-items: flex-end;
                            z-index: 10;
                        `;
                    }
                    
                    // Thought bubble - single line (reduced 35% total, explorers ~40% smaller than orbitals)
                    const thoughtBubble = document.createElement('div');
                    thoughtBubble.style.cssText = `
                        background: #3a3a3a;
                        color: #e0e0e0;
                        padding: ${isExplorer ? '2px 4px' : '4px 6px'};
                        border-radius: ${isExplorer ? '6px' : '9px'};
                        font-size: ${isExplorer ? '6px' : '8px'};
                        font-weight: 400;
                        white-space: nowrap;
                        text-align: center;
                        line-height: 1.2;
                    `;
                    thoughtBubble.textContent = user.thought;
                    bubbleContainer.appendChild(thoughtBubble);
                    
                    // Circle connectors pointing to avatar
                    const circlesContainer = document.createElement('div');
                    
                    if (isCurrentUser) {
                        // Current user: diagonal to bottom-right
                        circlesContainer.style.cssText = `
                            display: flex;
                            flex-direction: column;
                            align-items: flex-end;
                            margin-top: 1px;
                            margin-right: -5px;
                        `;
                    } else if (isOrbital && isRightSide) {
                        // Orbital right side: circles point to bottom-left
                        circlesContainer.style.cssText = `
                            display: flex;
                            flex-direction: column;
                            align-items: flex-start;
                            margin-top: 1px;
                            margin-left: -3px;
                        `;
                    } else {
                        // Orbital left side / far users: circles point to bottom-right
                        circlesContainer.style.cssText = `
                            display: flex;
                            flex-direction: column;
                            align-items: flex-end;
                            margin-top: 1px;
                            margin-right: -3px;
                        `;
                    }
                    
                    // Medium circle
                    const circle1 = document.createElement('div');
                    circle1.style.cssText = `width:${isExplorer ? '3' : '4'}px;height:${isExplorer ? '3' : '4'}px;background:#3a3a3a;border-radius:50%;margin-bottom:1px;`;
                    circlesContainer.appendChild(circle1);
                    
                    // Small circle
                    const circle2 = document.createElement('div');
                    circle2.style.cssText = `width:${isExplorer ? '2' : '2'}px;height:${isExplorer ? '2' : '2'}px;background:#3a3a3a;border-radius:50%;`;
                    circlesContainer.appendChild(circle2);
                    
                    bubbleContainer.appendChild(circlesContainer);
                    markerDiv.appendChild(bubbleContainer);
                }
                
                // Avatar container
                const avatarContainer = document.createElement('div');
                
                // Check for unread messages
                const userUnreadCount = !isCurrentUser ? (unreadMessages[user.id] || 0) : 0;
                const hasUnseenStory = user.hasStory && !viewedStories[user.id];
                
                // Determine breathing animation - stronger for notifications
                let breatheAnimation;
                if (userUnreadCount > 0 || hasUnseenStory) {
                    // Heartbeat for users with notifications (stories/messages)
                    breatheAnimation = 'animation: heartbeat 2s ease-in-out infinite;';
                } else {
                    // Gentle breathing for all others
                    breatheAnimation = 'animation: breathe 3s ease-in-out infinite;';
                }
                
                // Random delay to desync animations
                const animDelay = `animation-delay: ${(Math.random() * 2).toFixed(1)}s;`;
                
                avatarContainer.style.cssText = `width:${size}px;height:${size}px;position:relative;${breatheAnimation}${animDelay}`;
                
                // Ring - Priority: Unread messages (yellow) > Unseen story (gradient) > Default (gray)
                const ring = document.createElement('div');
                let ringStyle;
                
                if (userUnreadCount > 0) {
                    // Unread messages - Yellow ring
                    ringStyle = 'background: linear-gradient(45deg, #f7d046, #ffb347, #f7d046);';
                } else if (hasUnseenStory) {
                    // Story ring - Instagram gradient (only if NOT viewed)
                    ringStyle = 'background:linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);';
                } else {
                    // Default ring - gray (viewed story or no story)
                    ringStyle = 'background: #404040;';
                }
                ring.style.cssText = `position:absolute;width:100%;height:100%;border-radius:50%;${ringStyle}display:flex;align-items:center;justify-content:center;`;
                
                // Inner container to create the ring effect (dark background between ring and avatar)
                // Explorers have thinner ring (2px vs 3px)
                const innerContainer = document.createElement('div');
                const ringThickness = isExplorer ? 4 : 6; // 2px or 3px on each side
                const innerSize = size - ringThickness;
                innerContainer.style.cssText = `width:${innerSize}px;height:${innerSize}px;border-radius:50%;background:#0d1117;display:flex;align-items:center;justify-content:center;`;
                
                const avatarImg = document.createElement('img');
                avatarImg.src = user.photo;
                const imgPadding = isExplorer ? 2 : 4; // Less padding for explorers
                const imgSize = innerSize - imgPadding;
                avatarImg.style.cssText = `width:${imgSize}px;height:${imgSize}px;border-radius:50%;object-fit:cover;`;
                
                innerContainer.appendChild(avatarImg);
                ring.appendChild(innerContainer);
                avatarContainer.appendChild(ring);
                
                // Badge de mensajes no ledos - crculo naranja con contador
                if (userUnreadCount > 0) {
                    const unreadBadge = document.createElement('div');
                    const badgeSize = isExplorer ? 12 : 18;
                    const badgeFontSize = isExplorer ? 7 : 10;
                    unreadBadge.style.cssText = `
                        position: absolute;
                        bottom: -2px;
                        right: -2px;
                        min-width: ${badgeSize}px;
                        height: ${badgeSize}px;
                        background: linear-gradient(135deg, #ff6b35, #f7931e);
                        border-radius: ${badgeSize/2}px;
                        border: ${isExplorer ? '1' : '2'}px solid #0d1117;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: ${badgeFontSize}px;
                        font-weight: 700;
                        color: #fff;
                        padding: 0 ${isExplorer ? '2' : '4'}px;
                    `;
                    unreadBadge.textContent = userUnreadCount > 9 ? '9+' : userUnreadCount;
                    avatarContainer.appendChild(unreadBadge);
                }
                
                markerDiv.appendChild(avatarContainer);
                
                // Name + Distance label - ONLY for other users
                if (!isCurrentUser) {
                    const nameLabel = document.createElement('div');
                    nameLabel.style.cssText = `
                        margin-top: ${isExplorer ? '1px' : '2px'};
                        background: rgba(0,0,0,0.65);
                        padding: ${isExplorer ? '1px 4px' : '2px 5px'};
                        border-radius: 999px;
                        font-size: ${isExplorer ? '6px' : '7px'};
                        font-weight: 500;
                        color: #fff;
                        white-space: nowrap;
                        text-align: center;
                    `;
                    const firstName = user.name.split(' ')[0];
                    nameLabel.textContent = user.distance ? `${firstName} / ${user.distance}m` : firstName;
                    markerDiv.appendChild(nameLabel);
                    
                    // Direction indicator - ONLY for non-orbital users (beyond the 8 closest)
                    if (!isOrbital && user.approaching !== null && user.movement?.speed > 0.5) {
                        const directionIndicator = document.createElement('div');
                        const isApproachingUser = user.approaching === true;
                        const speedText = user.movement.speed.toFixed(1);
                        
                        directionIndicator.style.cssText = `
                            margin-top: 2px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            background: rgba(0,0,0,0.75);
                            padding: 2px 6px;
                            border-radius: 10px;
                            font-size: 9px;
                            color: ${isApproachingUser ? '#38bd62' : '#f85149'};
                        `;
                        
                        const arrow = document.createElement('span');
                        arrow.textContent = isApproachingUser ? '' : '';
                        arrow.style.fontSize = '11px';
                        
                        const speedLabel = document.createElement('span');
                        speedLabel.textContent = isApproachingUser 
                            ? `${speedText}km/h ` 
                            : `${speedText}km/h `;
                        
                        directionIndicator.appendChild(arrow);
                        directionIndicator.appendChild(speedLabel);
                        markerDiv.appendChild(directionIndicator);
                    }
                }
                
                markerDiv.addEventListener('click', () => handleAvatarClick(user));
                
                // Start invisible to prevent flash at wrong position
                markerDiv.style.opacity = '0';
                markerDiv.style.transition = 'opacity 0.15s ease';
                
                class CustomMarker extends google.maps.OverlayView {
                    constructor(position, content) {
                        super();
                        this.position = position;
                        this.content = content;
                        this.isFirstDraw = true;
                        this.isAnimating = false; // Flag for GPS movement animation
                    }
                    onAdd() { 
                        this.getPanes().overlayMouseTarget.appendChild(this.content); 
                    }
                    draw() {
                        const pos = this.getProjection().fromLatLngToDivPixel(this.position);
                        if (pos) {
                            this.content.style.position = 'absolute';
                            const width = this.content.offsetWidth || 70;
                            const height = this.content.offsetHeight || 100;
                            
                            if (this.isFirstDraw) {
                                // First draw: position instantly, no animation
                                this.isFirstDraw = false;
                                this.content.style.transition = 'none';
                                requestAnimationFrame(() => {
                                    requestAnimationFrame(() => {
                                        this.content.style.left = (pos.x - width / 2) + 'px';
                                        this.content.style.top = (pos.y - height) + 'px';
                                        this.content.style.opacity = '1';
                                    });
                                });
                            } else if (this.isAnimating) {
                                // GPS position changed: animate smoothly
                                this.content.style.transition = 'left 1s ease-out, top 1s ease-out';
                                this.content.style.left = (pos.x - width / 2) + 'px';
                                this.content.style.top = (pos.y - height) + 'px';
                                // Reset flag after animation
                                setTimeout(() => {
                                    this.isAnimating = false;
                                    this.content.style.transition = 'none';
                                }, 1000);
                            } else {
                                // Map panning: position instantly, no animation
                                this.content.style.transition = 'none';
                                this.content.style.left = (pos.x - width / 2) + 'px';
                                this.content.style.top = (pos.y - height) + 'px';
                            }
                        }
                    }
                    // Update position with smooth animation (GPS changed)
                    updatePosition(newLat, newLng) {
                        this.isAnimating = true; // Enable animation for this update
                        this.position = new google.maps.LatLng(newLat, newLng);
                        this.draw();
                    }
                    onRemove() { 
                        if (this.content.parentElement) {
                            this.content.parentElement.removeChild(this.content); 
                        }
                    }
                }
                
                const lat = user.displayLat || user.latitude;
                const lng = user.displayLng || user.longitude;
                const marker = new CustomMarker(new google.maps.LatLng(lat, lng), markerDiv);
                marker.setMap(map);
                return marker;
            };
            
            // Calculate orbital positions around user (circular)
            const getOrbitalPosition = (centerLat, centerLng, index, totalSlots = 8) => {
                // Orbit radius ~230 meters visual display (only users 50m real distance go to orbit)
                const orbitRadius = 0.00207; // ~230 meters in lat/lng for visual display
                const angle = (index * (360 / totalSlots)) * (Math.PI / 180);
                return {
                    lat: centerLat + (orbitRadius * Math.cos(angle)),
                    lng: centerLng + (orbitRadius * Math.sin(angle))
                };
            };
            
            // Clear all markers
            const clearAllMarkers = () => {
                Object.values(markersRef.current).forEach(item => {
                    if (item && item.marker && item.marker.setMap) {
                        item.marker.setMap(null);
                    }
                });
                markersRef.current = {};
            };
            
            // Remove specific marker
            const removeMarker = (userId) => {
                if (markersRef.current[userId]) {
                    if (markersRef.current[userId].marker && markersRef.current[userId].marker.setMap) {
                        markersRef.current[userId].marker.setMap(null);
                    }
                    delete markersRef.current[userId];
                }
            };

            // Auth effect
            useEffect(() => {
                console.log(' NEXME v7.9.0 - Large cropped phone with real map screenshot');
                
                const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
                    if (firebaseUser) {
                        const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                        let thought = '', hasActiveStory = false, storyUrl = null, storyTimestamp = null;
                        
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            let thoughtTimestampMs = null;
                            if (userData.thought && userData.thoughtTimestamp) {
                                thoughtTimestampMs = userData.thoughtTimestamp.toMillis ? userData.thoughtTimestamp.toMillis() : userData.thoughtTimestamp;
                                const hoursPassed = (Date.now() - thoughtTimestampMs) / 3600000;
                                if (hoursPassed < 24) thought = userData.thought;
                                else thoughtTimestampMs = null;
                            }
                            if (userData.storyUrl && userData.storyTimestamp) {
                                const hoursPassed = (Date.now() - (userData.storyTimestamp.toMillis ? userData.storyTimestamp.toMillis() : userData.storyTimestamp)) / 3600000;
                                if (hoursPassed < 12) {
                                    hasActiveStory = true;
                                    storyUrl = userData.storyUrl;
                                    storyTimestamp = userData.storyTimestamp.toMillis ? userData.storyTimestamp.toMillis() : userData.storyTimestamp;
                                }
                            }
                            // Cargar preferencias del usuario
                            if (userData.preferences) {
                                setUserPreferences(userData.preferences);
                                console.log(' Preferencias cargadas:', userData.preferences);
                            }
                            // Guardar thoughtTimestamp para verificar cooldown
                            if (thoughtTimestampMs) {
                                window.lastThoughtTimestamp = thoughtTimestampMs;
                            }
                        }
                        
                        const initialUser = {
                            id: firebaseUser.uid,
                            name: firebaseUser.displayName || 'Usuario',
                            photo: firebaseUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(firebaseUser.displayName || 'User')}&background=38bd62&color=fff&size=150`,
                            thought, hasStory: hasActiveStory, storyUrl, storyTimestamp,
                            email: firebaseUser.email, latitude: 0, longitude: 0, isOnline: true
                        };
                        
                        setCurrentUser(initialUser);
                        // El campo de texto empieza vaco, el pensamiento solo se muestra en el avatar
                        
                        await db.collection('users').doc(firebaseUser.uid).set({
                            uid: firebaseUser.uid,
                            displayName: firebaseUser.displayName,
                            email: firebaseUser.email,
                            photoURL: firebaseUser.photoURL,
                            isOnline: true,
                            lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                            location: new firebase.firestore.GeoPoint(0, 0),
                            pendingGPS: true
                        }, { merge: true });
                        
                        // v6.1: Get initial location with retries
                        if ('geolocation' in navigator) {
                            const location = await getInitialLocation();
                            if (location) {
                                setUserLocation({ latitude: location.latitude, longitude: location.longitude });
                                setCurrentUser(prev => ({ ...prev, latitude: location.latitude, longitude: location.longitude }));
                                setWaitingForGPS(false);
                                
                                await db.collection('users').doc(firebaseUser.uid).update({
                                    location: new firebase.firestore.GeoPoint(location.latitude, location.longitude),
                                    pendingGPS: false,
                                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                            
                            // Continue watching position - simplified
                            let usersUnsubscribe = null;
                            let lastUpdateTime = 0;
                            
                            const watchId = navigator.geolocation.watchPosition(
                                async (position) => {
                                    let { latitude, longitude, accuracy } = position.coords;
                                    
                                    // Ignore very inaccurate readings
                                    if (accuracy > 100) return;
                                    
                                    // Throttle updates to max once per 3 seconds
                                    const now = Date.now();
                                    if (now - lastUpdateTime < 3000) return;
                                    lastUpdateTime = now;
                                    
                                    // Apply Kalman Filter if enabled
                                    if (techSettings.kalman) {
                                        const filtered = filterGPSWithKalman(latitude, longitude, accuracy);
                                        latitude = filtered.lat;
                                        longitude = filtered.lng;
                                        // Kalman improves accuracy estimation
                                        accuracy = Math.max(2, accuracy / 2);
                                    }
                                    
                                    // Update location
                                    setUserLocation({ latitude, longitude });
                                    setCurrentUser(prev => ({ ...prev, latitude, longitude }));
                                    setLocationAccuracy(accuracy);
                                    
                                    // Update active technology
                                    updateActiveTechnology(accuracy, false, users);
                                    
                                    // Listen to other users (only setup once)
                                    if (!usersUnsubscribe) {
                                        usersUnsubscribe = db.collection('users')
                                            .where('isOnline', '==', true)
                                            .onSnapshot((snapshot) => {
                                                setCurrentUser(currentUserState => {
                                                    if (!currentUserState?.latitude) return currentUserState;
                                                    
                                                    const otherUsers = [];
                                                    snapshot.forEach((doc) => {
                                                        const userData = doc.data();
                                                        if (userData.uid === firebaseUser.uid) return;
                                                        
                                                        let isOnline = false;
                                                        if (userData.lastSeen) {
                                                            const lastSeenTime = userData.lastSeen.toMillis ? userData.lastSeen.toMillis() : userData.lastSeen;
                                                            isOnline = (Date.now() - lastSeenTime) <= 90000;
                                                        }
                                                        
                                                        if (userData.location && isOnline) {
                                                            const userLat = userData.location.latitude;
                                                            const userLon = userData.location.longitude;
                                                            
                                                            if (userLat !== 0 && userLon !== 0) {
                                                                const distance = Math.round(calculateDistance(
                                                                    currentUserState.latitude, currentUserState.longitude,
                                                                    userLat, userLon
                                                                ));
                                                                
                                                                let displayThought = '';
                                                                if (userData.thought && userData.thoughtTimestamp) {
                                                                    const hoursPassed = (Date.now() - (userData.thoughtTimestamp.toMillis ? userData.thoughtTimestamp.toMillis() : userData.thoughtTimestamp)) / 3600000;
                                                                    if (hoursPassed < 24) displayThought = userData.thought;
                                                                }
                                                                
                                                                let hasActiveStory = false, storyUrl = null, storyTimestamp = null;
                                                                if (userData.storyUrl && userData.storyTimestamp) {
                                                                    const hoursPassed = (Date.now() - (userData.storyTimestamp.toMillis ? userData.storyTimestamp.toMillis() : userData.storyTimestamp)) / 3600000;
                                                                    if (hoursPassed < 12) {
                                                                        hasActiveStory = true;
                                                                        storyUrl = userData.storyUrl;
                                                                        storyTimestamp = userData.storyTimestamp.toMillis ? userData.storyTimestamp.toMillis() : userData.storyTimestamp;
                                                                    }
                                                                }
                                                                
                                                                otherUsers.push({
                                                                    id: userData.uid,
                                                                    name: userData.displayName || 'Usuario',
                                                                    photo: userData.photoURL || 'https://ui-avatars.com/api/?name=User&background=38bd62&color=fff',
                                                                    thought: displayThought,
                                                                    hasStory: hasActiveStory, storyUrl, storyTimestamp,
                                                                    distance, isOnline: true,
                                                                    latitude: userLat, longitude: userLon,
                                                                    preferences: userData.preferences || null,
                                                                    // Calcular movimiento
                                                                    movement: calculateMovement(userData.uid, userLat, userLon),
                                                                    approaching: isApproaching(
                                                                        userData.uid, userLat, userLon,
                                                                        currentUserState.latitude, currentUserState.longitude
                                                                    )
                                                                });
                                                            }
                                                        }
                                                    });
                                                    
                                                    setUsers(otherUsers);
                                                    return currentUserState;
                                                });
                                            });
                                    }
                                    
                                    // Update Firestore (throttled by the check above)
                                    await db.collection('users').doc(firebaseUser.uid).update({
                                        location: new firebase.firestore.GeoPoint(latitude, longitude),
                                        isOnline: true,
                                        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                                        accuracy: accuracy,
                                        pendingGPS: false
                                    });
                                },
                                (error) => console.error('Location error:', error),
                                { enableHighAccuracy: true, timeout: 30000, maximumAge: 10000 }
                            );
                            
                            return () => {
                                navigator.geolocation.clearWatch(watchId);
                                if (usersUnsubscribe) usersUnsubscribe();
                            };
                        }
                    } else {
                        setCurrentUser(null);
                    }
                });
                
                return () => unsubscribe();
            }, []);

            // Initialize map when location ready
            useEffect(() => {
                if (!currentUser?.latitude || currentUser.latitude === 0 || googleMap) return;
                initializeGoogleMap(currentUser.latitude, currentUser.longitude);
            }, [currentUser?.latitude, currentUser?.longitude, googleMap]);

            // Listen for unread messages
            useEffect(() => {
                if (!currentUser?.id) return;
                
                const unsubscribe = db.collection('chats')
                    .where('participants', 'array-contains', currentUser.id)
                    .onSnapshot((snapshot) => {
                        const unreadCounts = {};
                        let total = 0;
                        
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            const myUnreadField = `unreadCount_${currentUser.id}`;
                            const count = data[myUnreadField] || 0;
                            
                            if (count > 0) {
                                // Encontrar el ID del otro usuario
                                const otherUserId = data.participants?.find(id => id !== currentUser.id);
                                if (otherUserId) {
                                    // Verificar si es un mensaje nuevo (comparar con el anterior)
                                    const previousCount = unreadMessages[otherUserId] || 0;
                                    if (count > previousCount && previousCount >= 0) {
                                        // Nuevo mensaje! Reproducir sonido
                                        if (notificationSound.current && initialLoadComplete) {
                                            try {
                                                notificationSound.current();
                                            } catch (e) {
                                                console.log('Audio not ready');
                                            }
                                        }
                                    }
                                    unreadCounts[otherUserId] = count;
                                    total += count;
                                }
                            }
                        });
                        
                        setUnreadMessages(unreadCounts);
                        setTotalUnread(total);
                    });
                
                return () => unsubscribe();
            }, [currentUser?.id, initialLoadComplete]);

            // Recalculate distances when current user moves
            useEffect(() => {
                if (!currentUser?.latitude || currentUser.latitude === 0) return;
                if (users.length === 0) return;
                
                // Recalculate all user distances based on current position
                setUsers(prevUsers => prevUsers.map(user => ({
                    ...user,
                    distance: Math.round(calculateDistance(
                        currentUser.latitude, currentUser.longitude,
                        user.latitude, user.longitude
                    ))
                })));
            }, [currentUser?.latitude, currentUser?.longitude]);

            // Update map markers - orbital system around user
            useEffect(() => {
                if (!googleMap || !currentUser?.latitude || currentUser.latitude === 0) return;
                
                // Get users in range and sort by distance
                // Apply lookingFor, age, and gender filters (interests are just informational)
                const usersInRange = users
                    .filter(u => {
                        // Basic filters
                        if (u.distance > radius || !u.isOnline || u.latitude === 0) return false;
                        
                        // Age filter: only apply if user has age range set AND other user has age
                        if (u.preferences?.age) {
                            if (u.preferences.age < userPreferences.ageRangeMin) return false;
                            if (u.preferences.age > userPreferences.ageRangeMax) return false;
                        }
                        
                        // Gender filter: only apply if not "all"
                        if (userPreferences.genderPreference !== 'all') {
                            // If other user has no gender set, don't show them
                            if (!u.preferences?.gender) return false;
                            if (u.preferences.gender !== userPreferences.genderPreference) return false;
                        }
                        
                        // LookingFor filter
                        const myLookingFor = userPreferences.lookingFor.length > 0;
                        const theirLookingFor = u.preferences?.lookingFor?.length > 0;
                        
                        if (myLookingFor && theirLookingFor) {
                            // Both have configured - must match
                            const hasCommonLookingFor = u.preferences.lookingFor.some(
                                lf => userPreferences.lookingFor.includes(lf)
                            );
                            if (!hasCommonLookingFor) return false;
                        } else if (myLookingFor && !theirLookingFor) {
                            // I configured, they didn't - don't show
                            return false;
                        } else if (!myLookingFor && theirLookingFor) {
                            // I didn't configure, they did - don't show
                            return false;
                        }
                        // Both not configured - show each other
                        
                        return true;
                    })
                    .sort((a, b) => a.distance - b.distance);
                
                // Create a signature to compare if data actually changed
                // Include user positions to detect movement (now with smooth animation, no flickering)
                const currentDataSignature = JSON.stringify({
                    usersCount: usersInRange.length,
                    userIds: usersInRange.map(u => u.id).join(','),
                    userPositions: usersInRange.map(u => `${u.latitude.toFixed(5)},${u.longitude.toFixed(5)}`).join('|'),
                    userThoughts: usersInRange.map(u => u.thought || '').join('|'),
                    userStories: usersInRange.map(u => u.hasStory ? '1' : '0').join(''),
                    currentThought: currentUser.thought || '',
                    currentHasStory: currentUser.hasStory || false,
                    currentLat: currentUser.latitude.toFixed(5),
                    currentLng: currentUser.longitude.toFixed(5)
                });
                
                // Force update if tick changed (manual refresh) OR if data changed
                const tickChanged = markerRefreshTick !== lastTickRef.current;
                lastTickRef.current = markerRefreshTick;
                
                if (!tickChanged && currentDataSignature === lastMarkersDataRef.current) {
                    return;
                }
                lastMarkersDataRef.current = currentDataSignature;
                
                // Track which markers should exist
                const activeMarkerIds = new Set();
                
                // Only users within 50m go in orbital positions (max 8)
                const closeUsers = usersInRange.filter(u => u.distance <= 50);
                const farFromOrbit = usersInRange.filter(u => u.distance > 50);
                const orbitUsers = closeUsers.slice(0, 8);
                
                // Debug log
                console.log(` Orbitales: ${closeUsers.length} (50m), Exploradores: ${farFromOrbit.length} (>50m)`);
                
                // Users close but beyond 8 orbital slots go to real position
                const closeButNotOrbital = closeUsers.slice(8);
                
                // Update or create current user marker
                const currentUserId = 'current_user';
                activeMarkerIds.add(currentUserId);
                
                const existingCurrentMarker = markersRef.current[currentUserId];
                const currentUserChanged = existingCurrentMarker && (
                    existingCurrentMarker.hasStory !== currentUser.hasStory ||
                    existingCurrentMarker.thought !== (currentUser.thought || '')
                );
                
                if (existingCurrentMarker && !currentUserChanged) {
                    // Update existing marker position only
                    existingCurrentMarker.marker.updatePosition(currentUser.latitude, currentUser.longitude);
                } else {
                    // Remove old marker if exists and create new one (story/thought changed)
                    if (existingCurrentMarker) removeMarker(currentUserId);
                    
                    const marker = createUserMarker(currentUser, googleMap, 48, true, true, -1);
                    markersRef.current[currentUserId] = { 
                        marker, 
                        type: 'current', 
                        lat: currentUser.latitude, 
                        lng: currentUser.longitude,
                        hasStory: currentUser.hasStory,
                        thought: currentUser.thought || ''
                    };
                }
                
                // Update or create orbital markers
                orbitUsers.forEach((user, index) => {
                    const orbitalPos = getOrbitalPosition(currentUser.latitude, currentUser.longitude, index, 8);
                    activeMarkerIds.add(user.id);
                    
                    const existingMarker = markersRef.current[user.id];
                    const userChanged = existingMarker && (
                        existingMarker.hasStory !== user.hasStory ||
                        existingMarker.thought !== (user.thought || '')
                    );
                    
                    if (existingMarker && existingMarker.type === 'orbital' && !userChanged) {
                        // Update existing orbital marker - smooth transition
                        existingMarker.marker.updatePosition(orbitalPos.lat, orbitalPos.lng);
                    } else {
                        // Remove if exists, then create new
                        if (existingMarker) removeMarker(user.id);
                        
                        const userWithPos = {
                            ...user,
                            displayLat: orbitalPos.lat,
                            displayLng: orbitalPos.lng
                        };
                        const marker = createUserMarker(userWithPos, googleMap, 38, false, true, index);
                        markersRef.current[user.id] = { 
                            marker, 
                            type: 'orbital', 
                            lat: orbitalPos.lat, 
                            lng: orbitalPos.lng,
                            hasStory: user.hasStory,
                            thought: user.thought || ''
                        };
                    }
                });
                
                // Update or create explorer markers (beyond 50m OR beyond 8 orbital slots)
                const realPositionUsers = [...farFromOrbit, ...closeButNotOrbital];
                realPositionUsers.forEach(user => {
                    activeMarkerIds.add(user.id);
                    
                    const existingMarker = markersRef.current[user.id];
                    const userChanged = existingMarker && (
                        existingMarker.hasStory !== user.hasStory ||
                        existingMarker.thought !== (user.thought || '')
                    );
                    
                    if (existingMarker && existingMarker.type === 'explorer' && !userChanged) {
                        // Update existing explorer marker - smooth transition to real GPS position
                        existingMarker.marker.updatePosition(user.latitude, user.longitude);
                    } else {
                        // Remove if exists, then create new
                        if (existingMarker) removeMarker(user.id);
                        
                        const marker = createUserMarker(user, googleMap, 22, false, false, -1);
                        markersRef.current[user.id] = { 
                            marker, 
                            type: 'explorer', 
                            lat: user.latitude, 
                            lng: user.longitude,
                            hasStory: user.hasStory,
                            thought: user.thought || ''
                        };
                    }
                });
                
                // Remove markers for users no longer in range
                Object.keys(markersRef.current).forEach(userId => {
                    if (!activeMarkerIds.has(userId)) {
                        removeMarker(userId);
                    }
                });
                
            }, [googleMap, currentUser?.latitude, currentUser?.longitude, currentUser?.photo, currentUser?.thought, currentUser?.hasStory, users, radius, viewedStories, unreadMessages, userPreferences.lookingFor, userPreferences.ageRangeMin, userPreferences.ageRangeMax, userPreferences.genderPreference, markerRefreshTick]);
            
            // Center map on user - only when position changes significantly
            useEffect(() => {
                if (!googleMap || !currentUser?.latitude || currentUser.latitude === 0) return;
                
                const currentCenter = googleMap.getCenter();
                const newLat = currentUser.latitude;
                const newLng = currentUser.longitude;
                
                // Only recenter if moved more than ~20 meters
                if (currentCenter) {
                    const distance = calculateDistance(
                        currentCenter.lat(), currentCenter.lng(),
                        newLat, newLng
                    );
                    if (distance < 20) return; // Don't recenter for small movements
                }
                
                googleMap.setCenter({ lat: newLat, lng: newLng });
            }, [googleMap, currentUser?.latitude, currentUser?.longitude]);

            // Heartbeat
            useEffect(() => {
                if (!currentUser) return;
                const interval = setInterval(() => {
                    if (!document.hidden) {
                        db.collection('users').doc(currentUser.id).update({
                            isOnline: true,
                            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                        }).catch(console.error);
                    }
                }, 10000);
                return () => clearInterval(interval);
            }, [currentUser]);
            
            // Force marker refresh every 30 seconds to catch any missed updates (reduced from 10s to prevent flickering)
            useEffect(() => {
                const interval = setInterval(() => {
                    setMarkerRefreshTick(t => t + 1);
                }, 30000);
                return () => clearInterval(interval);
            }, []);
            
            // Detect page visibility change - refresh when user returns to tab
            useEffect(() => {
                const handleVisibilityChange = () => {
                    if (!document.hidden) {
                        console.log(' Tab visible - forcing refresh');
                        setMarkerRefreshTick(t => t + 1);
                    }
                };
                
                document.addEventListener('visibilitychange', handleVisibilityChange);
                return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
            }, []);
            
            // Detect online/offline status - refresh when reconnected
            useEffect(() => {
                const handleOnline = () => {
                    console.log(' Connection restored - forcing refresh');
                    setMarkerRefreshTick(t => t + 1);
                };
                
                window.addEventListener('online', handleOnline);
                return () => window.removeEventListener('online', handleOnline);
            }, []);

            // Guardar preferencias en Firebase
            const savePreferences = async () => {
                if (!currentUser?.id) return;
                
                try {
                    await db.collection('users').doc(currentUser.id).update({
                        preferences: userPreferences,
                        preferencesUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setShowPreferences(false);
                    console.log(' Preferencias guardadas');
                } catch (error) {
                    console.error('Error guardando preferencias:', error);
                }
            };
            
            // Cargar preferencias de Firebase
            const loadPreferences = async (userId) => {
                try {
                    const doc = await db.collection('users').doc(userId).get();
                    if (doc.exists && doc.data().preferences) {
                        setUserPreferences(doc.data().preferences);
                        console.log(' Preferencias cargadas');
                    }
                } catch (error) {
                    console.error('Error cargando preferencias:', error);
                }
            };
            
            // Toggle interest selection
            const toggleInterest = (interestId) => {
                setUserPreferences(prev => ({
                    ...prev,
                    interests: prev.interests.includes(interestId)
                        ? prev.interests.filter(i => i !== interestId)
                        : [...prev.interests, interestId]
                }));
            };
            
            // Toggle lookingFor selection - SINGLE selection only
            const toggleLookingFor = (optionId) => {
                setUserPreferences(prev => ({
                    ...prev,
                    lookingFor: prev.lookingFor.includes(optionId) ? [] : [optionId]
                }));
            };
            
            // Calcular intereses en comn
            const getCommonInterests = (userInterests) => {
                if (!userPreferences.interests || !userInterests) return [];
                return userPreferences.interests.filter(i => userInterests.includes(i));
            };
            
            // Filtrar usuarios por preferencias
            const filterByPreferences = (usersList) => {
                return usersList.filter(user => {
                    // Si no hay preferencias configuradas, mostrar todos
                    if (!user.preferences) return true;
                    
                    // Filtrar por edad
                    if (user.preferences.age) {
                        if (user.preferences.age < userPreferences.ageRangeMin) return false;
                        if (user.preferences.age > userPreferences.ageRangeMax) return false;
                    }
                    
                    // Filtrar por gnero
                    if (userPreferences.genderPreference !== 'all' && user.preferences.gender) {
                        if (user.preferences.gender !== userPreferences.genderPreference) return false;
                    }
                    
                    return true;
                });
            };

            // Handlers
            const handleGoogleSignIn = async () => {
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    provider.setCustomParameters({ prompt: 'select_account' });
                    await auth.signInWithPopup(provider);
                } catch (error) {
                    console.error('Sign in error:', error);
                    alert('Error: ' + error.message);
                }
            };

            const handleLogout = async () => {
                try {
                    if (currentUser) {
                        await db.collection('users').doc(currentUser.id).update({
                            isOnline: false,
                            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    await auth.signOut();
                    setCurrentUser(null);
                    setShowSidebar(false);
                } catch (error) {
                    console.error('Logout error:', error);
                }
            };

            const handleThoughtSubmit = async () => {
                if (!thought.trim() || !currentUser) return;
                
                // Verificar si han pasado 15 minutos desde el ltimo pensamiento
                if (window.lastThoughtTimestamp) {
                    const now = Date.now();
                    const minutesPassed = (now - window.lastThoughtTimestamp) / 60000;
                    
                    if (minutesPassed < 15) {
                        const minutesLeft = Math.ceil(15 - minutesPassed);
                        alert(`Debes esperar ${minutesLeft} minuto${minutesLeft > 1 ? 's' : ''} para publicar otro pensamiento`);
                        return;
                    }
                }
                
                const newThought = thought.trim();
                const now = Date.now();
                try {
                    await db.collection('users').doc(currentUser.id).update({
                        thought: newThought,
                        thoughtTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setCurrentUser(prev => ({ ...prev, thought: newThought }));
                    window.lastThoughtTimestamp = now; // Actualizar timestamp local
                    setThought(''); // Limpiar el campo despus de publicar
                } catch (error) {
                    console.error('Error updating thought:', error);
                }
            };

            const handleAvatarClick = (user) => {
                if (user.id === currentUser?.id) {
                    if (currentUser.hasStory && currentUser.storyUrl) setViewingStory(currentUser);
                    else setShowStoryUpload(true);
                } else {
                    if (user.hasStory && user.storyUrl) {
                        // Mark as viewed immediately when opening
                        setViewedStories(prev => ({ ...prev, [user.id]: Date.now() }));
                        setViewingStory(user);
                    }
                    else { setInstagramModalUser(user); setShowInstagramModal(true); }
                }
            };

            const handleStoryImageSelect = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => setStoryImage(event.target.result);
                    reader.readAsDataURL(file);
                }
            };

            const handleStoryPublish = async () => {
                if (!storyImage || !currentUser) return;
                setUploadingStory(true);
                try {
                    const response = await fetch(storyImage);
                    const blob = await response.blob();
                    const storyRef = storage.ref().child(`stories/${currentUser.id}/${Date.now()}.jpg`);
                    await storyRef.put(blob);
                    const downloadURL = await storyRef.getDownloadURL();
                    
                    await db.collection('users').doc(currentUser.id).update({
                        storyUrl: downloadURL,
                        storyTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    setCurrentUser(prev => ({ ...prev, hasStory: true, storyUrl: downloadURL, storyTimestamp: Date.now() }));
                    setStoryImage(null);
                    setShowStoryUpload(false);
                } catch (error) {
                    console.error('Error uploading story:', error);
                    alert('Error: ' + error.message);
                } finally {
                    setUploadingStory(false);
                }
            };

            const openChat = (user) => {
                setSelectedUser(user);
                setShowInstagramModal(false);
                
                const chatId = [currentUser.id, user.id].sort().join('_');
                
                // Marcar mensajes como ledos
                db.collection('chats').doc(chatId).update({
                    [`unreadCount_${currentUser.id}`]: 0
                }).catch(() => {}); // Ignorar si el chat no existe an
                
                // Limpiar contador local
                setUnreadMessages(prev => {
                    const updated = { ...prev };
                    delete updated[user.id];
                    return updated;
                });
                
                db.collection('chats').doc(chatId).collection('messages')
                    .orderBy('timestamp', 'asc')
                    .onSnapshot((snapshot) => {
                        const msgs = [];
                        snapshot.forEach((doc) => msgs.push({ id: doc.id, ...doc.data() }));
                        setMessages(prev => ({ ...prev, [chatId]: msgs }));
                        setTimeout(() => {
                            if (chatMessagesRef.current) chatMessagesRef.current.scrollTop = chatMessagesRef.current.scrollHeight;
                        }, 100);
                    });
            };

            const sendMessage = async () => {
                if (!messageInput.trim() || !selectedUser || !currentUser) return;
                const chatId = [currentUser.id, selectedUser.id].sort().join('_');
                const text = messageInput.trim();
                setMessageInput('');
                
                try {
                    await db.collection('chats').doc(chatId).collection('messages').add({
                        text, senderId: currentUser.id, senderName: currentUser.name,
                        senderPhoto: currentUser.photo, timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await db.collection('chats').doc(chatId).set({
                        participants: [currentUser.id, selectedUser.id],
                        lastMessage: text,
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                        [`unreadCount_${selectedUser.id}`]: firebase.firestore.FieldValue.increment(1)
                    }, { merge: true });
                } catch (error) {
                    console.error('Error sending message:', error);
                    setMessageInput(text);
                }
            };

            const sendQuickMessage = async () => {
                if (!quickMessage.trim() || !instagramModalUser || !currentUser) return;
                const chatId = [currentUser.id, instagramModalUser.id].sort().join('_');
                
                try {
                    await db.collection('chats').doc(chatId).collection('messages').add({
                        text: quickMessage.trim(), senderId: currentUser.id, senderName: currentUser.name,
                        senderPhoto: currentUser.photo, timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await db.collection('chats').doc(chatId).set({
                        participants: [currentUser.id, instagramModalUser.id],
                        lastMessage: quickMessage.trim(),
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                        [`unreadCount_${instagramModalUser.id}`]: firebase.firestore.FieldValue.increment(1)
                    }, { merge: true });
                    setQuickMessage('');
                    setShowInstagramModal(false);
                    openChat(instagramModalUser);
                } catch (error) {
                    console.error('Error sending quick message:', error);
                }
            };

            const sendLike = async () => {
                if (!instagramModalUser || !currentUser) return;
                const chatId = [currentUser.id, instagramModalUser.id].sort().join('_');
                try {
                    await db.collection('chats').doc(chatId).collection('messages').add({
                        text: '', senderId: currentUser.id, senderName: currentUser.name,
                        senderPhoto: currentUser.photo, timestamp: firebase.firestore.FieldValue.serverTimestamp(), type: 'like'
                    });
                    await db.collection('chats').doc(chatId).set({
                        participants: [currentUser.id, instagramModalUser.id],
                        lastMessage: '', lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                        [`unreadCount_${instagramModalUser.id}`]: firebase.firestore.FieldValue.increment(1)
                    }, { merge: true });
                    setShowInstagramModal(false);
                } catch (error) {
                    console.error('Error sending like:', error);
                }
            };

            const formatMessageTime = (timestamp) => {
                if (!timestamp) return '';
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            };

            // Format time ago for stories
            const formatTimeAgo = (timestamp) => {
                if (!timestamp) return 'Hace un momento';
                const now = Date.now();
                const time = typeof timestamp === 'number' ? timestamp : (timestamp.toMillis ? timestamp.toMillis() : timestamp);
                const diff = now - time;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                
                if (minutes < 1) return 'Hace un momento';
                if (minutes < 60) return `Hace ${minutes}m`;
                if (hours < 24) return `Hace ${hours}h`;
                return 'Hace ms de 1 da';
            };

            // Send reaction to story
            const sendStoryReaction = async (emoji) => {
                if (!viewingStory || !currentUser || viewingStory.id === currentUser.id) return;
                
                const chatId = [currentUser.id, viewingStory.id].sort().join('_');
                try {
                    await db.collection('chats').doc(chatId).collection('messages').add({
                        text: `Reaccion ${emoji} a tu historia`,
                        senderId: currentUser.id,
                        senderName: currentUser.name,
                        senderPhoto: currentUser.photo,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        type: 'story_reaction',
                        emoji: emoji
                    });
                    await db.collection('chats').doc(chatId).set({
                        participants: [currentUser.id, viewingStory.id],
                        lastMessage: `${emoji}`,
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                        [`unreadCount_${viewingStory.id}`]: firebase.firestore.FieldValue.increment(1)
                    }, { merge: true });
                    
                    // Close story and show confirmation
                    setViewedStories(prev => ({ ...prev, [viewingStory.id]: Date.now() }));
                    setViewingStory(null);
                } catch (error) {
                    console.error('Error sending reaction:', error);
                }
            };

            // Auto-close story after 5 seconds
            useEffect(() => {
                if (!viewingStory) return;
                
                const timer = setTimeout(() => {
                    setViewedStories(prev => ({ ...prev, [viewingStory.id]: Date.now() }));
                    setViewingStory(null);
                }, 5000); // 5 seconds
                
                return () => clearTimeout(timer);
            }, [viewingStory]);

            // Proximity notifications - notify ONLY when NEW user appears after initial load
            useEffect(() => {
                if (!currentUser?.latitude || users.length === 0) return;
                
                const closeUsers = users.filter(u => u.distance <= 100 && u.isOnline);
                const currentUserIds = new Set(closeUsers.map(u => u.id));
                
                // First load - just record who's here, don't notify
                if (!initialLoadComplete) {
                    setKnownUserIds(currentUserIds);
                    setInitialLoadComplete(true);
                    return;
                }
                
                // Check for NEW users (not in knownUserIds)
                closeUsers.forEach(user => {
                    if (!knownUserIds.has(user.id)) {
                        // This is a NEW user who just appeared!
                        setSocialNotifications(prev => {
                            // Don't add duplicate notifications
                            if (prev.some(n => n.userId === user.id)) return prev;
                            return [...prev, {
                                id: `${user.id}-${Date.now()}`,
                                userId: user.id,
                                user: user,
                                timestamp: Date.now()
                            }];
                        });
                    }
                });
                
                // Update known users
                setKnownUserIds(currentUserIds);
                
                // Auto-remove notifications after 8 seconds
                const cleanupInterval = setInterval(() => {
                    setSocialNotifications(prev => 
                        prev.filter(n => (Date.now() - n.timestamp) < 8000)
                    );
                }, 1000);
                
                return () => clearInterval(cleanupInterval);
            }, [users, currentUser?.latitude]);

            // Render
            if (!currentUser) {
                // Show NexMe landing page with phone mockup
                return (
                    <div style={{
                        minHeight: '100vh',
                        background: '#1a1a1a',
                        color: '#e6edf3',
                        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                        overflowX: 'hidden'
                    }}>
                        {/* Header */}
                        <header style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            padding: '16px 32px',
                            borderBottom: '1px solid #2d2d2d',
                            position: 'sticky',
                            top: 0,
                            background: '#1a1a1a',
                            zIndex: 100
                        }}>
                            <div style={{ fontSize: '20px', fontWeight: '600', color: '#fff' }}>
                                NexMe
                            </div>
                            <nav style={{ display: 'flex', gap: '32px', fontSize: '14px', color: '#a0a0a0' }}>
                                <span style={{ cursor: 'pointer' }}>Caractersticas</span>
                                <span style={{ cursor: 'pointer' }}>Cmo funciona</span>
                                <span style={{ cursor: 'pointer' }}>Privacidad</span>
                            </nav>
                            <button onClick={handleGoogleSignIn} style={{
                                padding: '10px 20px',
                                borderRadius: '6px',
                                border: 'none',
                                background: '#38bd62',
                                color: '#fff',
                                fontSize: '14px',
                                fontWeight: '500',
                                cursor: 'pointer'
                            }}>
                                Probar NexMe
                            </button>
                        </header>

                        {/* Hero Section - Phone cropped at bottom */}
                        <section style={{
                            display: 'grid',
                            gridTemplateColumns: '1fr 1fr',
                            minHeight: '100vh',
                            maxWidth: '1200px',
                            margin: '0 auto',
                            padding: '40px 32px 0',
                            alignItems: 'center',
                            overflow: 'hidden',
                            position: 'relative'
                        }}>
                            {/* Left Column - Login */}
                            <div style={{
                                display: 'flex',
                                flexDirection: 'column',
                                justifyContent: 'center',
                                paddingLeft: '40px'
                            }}>
                                <h1 style={{
                                    fontSize: '48px',
                                    fontWeight: '400',
                                    lineHeight: '1.15',
                                    margin: '0 0 20px 0',
                                    color: '#fff',
                                    fontFamily: 'Georgia, serif'
                                }}>
                                    <span style={{ fontStyle: 'italic' }}>Solos?</span><br/>
                                    Conectados.
                                </h1>

                                <p style={{
                                    fontSize: '16px',
                                    color: '#a0a0a0',
                                    margin: '0 0 40px 0'
                                }}>
                                    La app para conocer personas cerca de ti
                                </p>

                                <div style={{ maxWidth: '320px' }}>
                                    <button onClick={handleGoogleSignIn} style={{
                                        width: '100%',
                                        padding: '12px 20px',
                                        borderRadius: '8px',
                                        border: '1px solid #3d3d3d',
                                        background: '#2d2d2d',
                                        color: '#fff',
                                        fontSize: '14px',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '10px',
                                        marginBottom: '20px'
                                    }}>
                                        <svg width="18" height="18" viewBox="0 0 24 24">
                                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                        </svg>
                                        Continuar con Google
                                    </button>

                                    <div style={{ display: 'flex', alignItems: 'center', margin: '20px 0', color: '#666' }}>
                                        <div style={{ flex: 1, height: '1px', background: '#3d3d3d' }}></div>
                                        <span style={{ padding: '0 16px', fontSize: '13px' }}>o</span>
                                        <div style={{ flex: 1, height: '1px', background: '#3d3d3d' }}></div>
                                    </div>

                                    <input type="email" placeholder="Introduce tu email" style={{
                                        width: '100%',
                                        padding: '12px 16px',
                                        borderRadius: '8px',
                                        border: '1px solid #3d3d3d',
                                        background: 'transparent',
                                        color: '#fff',
                                        fontSize: '14px',
                                        marginBottom: '12px',
                                        boxSizing: 'border-box',
                                        outline: 'none'
                                    }}/>

                                    <button style={{
                                        width: '100%',
                                        padding: '12px 20px',
                                        borderRadius: '8px',
                                        border: '1px solid #3d3d3d',
                                        background: 'transparent',
                                        color: '#fff',
                                        fontSize: '14px',
                                        cursor: 'pointer'
                                    }}>
                                        Continuar con correo electrnico
                                    </button>

                                    <p style={{ fontSize: '12px', color: '#666', marginTop: '20px', lineHeight: '1.5' }}>
                                        Al continuar, reconoces la{' '}
                                        <span style={{ color: '#888', textDecoration: 'underline', cursor: 'pointer' }}>Poltica de Privacidad</span>
                                        {' '}de NexMe.
                                    </p>
                                </div>
                            </div>

                            {/* Right Column - Phone Mockup - Large & Cropped */}
                            <div style={{
                                display: 'flex',
                                alignItems: 'flex-start',
                                justifyContent: 'center',
                                position: 'relative',
                                height: '100%',
                                paddingTop: '20px'
                            }}>
                                {/* iPhone Frame - Large 65vh */}
                                <div style={{
                                    width: '380px',
                                    height: '85vh',
                                    background: '#000',
                                    borderRadius: '55px',
                                    padding: '12px',
                                    boxShadow: '0 50px 120px rgba(0,0,0,0.8), inset 0 0 0 3px #333',
                                    position: 'relative'
                                }}>
                                    {/* Screen */}
                                    <div style={{
                                        width: '100%',
                                        height: '100%',
                                        borderRadius: '45px',
                                        overflow: 'hidden',
                                        position: 'relative',
                                        background: '#0d1117'
                                    }}>
                                        {/* Map Background Image */}
                                        <div style={{
                                            position: 'absolute',
                                            inset: 0,
                                            backgroundImage: 'url(nexme-map-bg.jpg)',
                                            backgroundSize: 'cover',
                                            backgroundPosition: 'center top'
                                        }}/>

                                        {/* App Header Overlay */}
                                        <div style={{
                                            position: 'absolute',
                                            top: 0,
                                            left: 0,
                                            right: 0,
                                            background: 'linear-gradient(180deg, rgba(13,17,23,0.95) 0%, rgba(13,17,23,0.8) 70%, transparent 100%)',
                                            padding: '40px 16px 20px',
                                            zIndex: 10
                                        }}>
                                            <div style={{
                                                display: 'flex',
                                                justifyContent: 'space-between',
                                                alignItems: 'center'
                                            }}>
                                                <div style={{ fontSize: '22px', color: '#fff' }}></div>
                                                <div style={{
                                                    background: 'rgba(56, 189, 98, 0.15)',
                                                    padding: '8px 18px',
                                                    borderRadius: '20px',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '8px',
                                                    border: '1px solid rgba(56, 189, 98, 0.3)'
                                                }}>
                                                    <span style={{ color: '#38bd62', fontWeight: '700', fontSize: '16px' }}>3</span>
                                                    <span style={{ color: '#8b949e', fontSize: '14px' }}>cerca</span>
                                                </div>
                                                <div style={{ fontSize: '20px', color: '#fff' }}></div>
                                            </div>
                                        </div>

                                        {/* Animated Avatars on Map */}
                                        {/* Avatar 1 - Main user with story ring and thought */}
                                        <div className="hero-avatar-1" style={{
                                            position: 'absolute',
                                            top: '38%',
                                            left: '45%',
                                            zIndex: 5
                                        }}>
                                            <div style={{
                                                position: 'absolute',
                                                top: '-38px',
                                                left: '50%',
                                                transform: 'translateX(-50%)',
                                                background: 'rgba(13, 17, 23, 0.95)',
                                                color: '#e6edf3',
                                                padding: '6px 12px',
                                                borderRadius: '12px',
                                                fontSize: '11px',
                                                whiteSpace: 'nowrap',
                                                border: '1px solid rgba(56, 189, 98, 0.4)',
                                                boxShadow: '0 4px 12px rgba(0,0,0,0.3)'
                                            }}>
                                                Que xopa! 
                                            </div>
                                            <div style={{
                                                width: '58px',
                                                height: '58px',
                                                borderRadius: '50%',
                                                background: 'linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888)',
                                                padding: '3px',
                                                boxShadow: '0 4px 20px rgba(240, 148, 51, 0.4)'
                                            }}>
                                                <div style={{
                                                    width: '100%',
                                                    height: '100%',
                                                    borderRadius: '50%',
                                                    background: '#0d1117',
                                                    padding: '2px'
                                                }}>
                                                    <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150" style={{
                                                        width: '100%',
                                                        height: '100%',
                                                        borderRadius: '50%',
                                                        objectFit: 'cover'
                                                    }}/>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Avatar 2 - Girl looking for coffee */}
                                        <div className="hero-avatar-2" style={{
                                            position: 'absolute',
                                            top: '22%',
                                            right: '15%',
                                            zIndex: 4
                                        }}>
                                            <div style={{
                                                position: 'absolute',
                                                top: '-34px',
                                                left: '50%',
                                                transform: 'translateX(-50%)',
                                                background: 'rgba(13, 17, 23, 0.95)',
                                                color: '#e6edf3',
                                                padding: '5px 10px',
                                                borderRadius: '10px',
                                                fontSize: '10px',
                                                whiteSpace: 'nowrap',
                                                border: '1px solid #30363d',
                                                boxShadow: '0 4px 12px rgba(0,0,0,0.3)'
                                            }}>
                                                Buscando caf 
                                            </div>
                                            <div style={{
                                                width: '46px',
                                                height: '46px',
                                                borderRadius: '50%',
                                                background: 'linear-gradient(45deg, #f09433, #dc2743)',
                                                padding: '2px',
                                                boxShadow: '0 4px 15px rgba(220, 39, 67, 0.3)'
                                            }}>
                                                <div style={{
                                                    width: '100%',
                                                    height: '100%',
                                                    borderRadius: '50%',
                                                    background: '#0d1117',
                                                    padding: '2px'
                                                }}>
                                                    <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=150" style={{
                                                        width: '100%',
                                                        height: '100%',
                                                        borderRadius: '50%',
                                                        objectFit: 'cover'
                                                    }}/>
                                                </div>
                                            </div>
                                            <div style={{
                                                position: 'absolute',
                                                bottom: '-18px',
                                                left: '50%',
                                                transform: 'translateX(-50%)',
                                                background: 'rgba(56, 189, 98, 0.2)',
                                                color: '#38bd62',
                                                padding: '2px 8px',
                                                borderRadius: '8px',
                                                fontSize: '9px',
                                                fontWeight: '600'
                                            }}>
                                                Mara / 120m
                                            </div>
                                        </div>

                                        {/* Avatar 3 - Guy at gym */}
                                        <div className="hero-avatar-3" style={{
                                            position: 'absolute',
                                            bottom: '35%',
                                            left: '18%',
                                            zIndex: 4
                                        }}>
                                            <div style={{
                                                position: 'absolute',
                                                top: '-34px',
                                                left: '50%',
                                                transform: 'translateX(-50%)',
                                                background: 'rgba(13, 17, 23, 0.95)',
                                                color: '#e6edf3',
                                                padding: '5px 10px',
                                                borderRadius: '10px',
                                                fontSize: '10px',
                                                whiteSpace: 'nowrap',
                                                border: '1px solid #30363d',
                                                boxShadow: '0 4px 12px rgba(0,0,0,0.3)'
                                            }}>
                                                Gym? 
                                            </div>
                                            <div style={{
                                                width: '42px',
                                                height: '42px',
                                                borderRadius: '50%',
                                                background: '#38bd62',
                                                padding: '2px',
                                                boxShadow: '0 4px 15px rgba(56, 189, 98, 0.3)'
                                            }}>
                                                <div style={{
                                                    width: '100%',
                                                    height: '100%',
                                                    borderRadius: '50%',
                                                    background: '#0d1117',
                                                    padding: '2px'
                                                }}>
                                                    <img src="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=150" style={{
                                                        width: '100%',
                                                        height: '100%',
                                                        borderRadius: '50%',
                                                        objectFit: 'cover'
                                                    }}/>
                                                </div>
                                            </div>
                                            <div style={{
                                                position: 'absolute',
                                                bottom: '-18px',
                                                left: '50%',
                                                transform: 'translateX(-50%)',
                                                background: 'rgba(56, 189, 98, 0.2)',
                                                color: '#38bd62',
                                                padding: '2px 8px',
                                                borderRadius: '8px',
                                                fontSize: '9px',
                                                fontWeight: '600'
                                            }}>
                                                Carlos / 85m
                                            </div>
                                        </div>

                                        {/* Bottom Controls Overlay */}
                                        <div style={{
                                            position: 'absolute',
                                            bottom: 0,
                                            left: 0,
                                            right: 0,
                                            background: 'linear-gradient(0deg, rgba(13,17,23,0.98) 0%, rgba(13,17,23,0.9) 70%, transparent 100%)',
                                            padding: '30px 16px 20px',
                                            zIndex: 10
                                        }}>
                                            <div style={{ marginBottom: '8px' }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                                                    <span style={{ fontSize: '10px', color: '#8b949e', fontWeight: '500' }}>RADIO DE BSQUEDA</span>
                                                    <span style={{ fontSize: '14px', color: '#38bd62', fontWeight: '700' }}>1000m</span>
                                                </div>
                                                <div style={{ position: 'relative', height: '6px', background: '#21262d', borderRadius: '3px' }}>
                                                    <div style={{ width: '100%', height: '100%', background: 'linear-gradient(90deg, #38bd62, #2ea55c)', borderRadius: '3px' }}/>
                                                    <div style={{
                                                        position: 'absolute',
                                                        right: '-4px',
                                                        top: '50%',
                                                        transform: 'translateY(-50%)',
                                                        width: '14px',
                                                        height: '14px',
                                                        background: '#38bd62',
                                                        borderRadius: '50%',
                                                        border: '2px solid #0d1117'
                                                    }}/>
                                                </div>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '4px' }}>
                                                    <span style={{ fontSize: '9px', color: '#6e7681' }}>0m</span>
                                                    <span style={{ fontSize: '9px', color: '#6e7681' }}>500m</span>
                                                    <span style={{ fontSize: '9px', color: '#6e7681' }}>1km</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>

                        {/* How it Works Section */}
                        <section style={{
                            padding: '100px 32px',
                            borderTop: '1px solid #2d2d2d',
                            background: '#141414'
                        }}>
                            <div style={{ maxWidth: '1000px', margin: '0 auto', textAlign: 'center' }}>
                                <h2 style={{
                                    fontSize: '36px',
                                    fontWeight: '400',
                                    marginBottom: '16px',
                                    fontFamily: 'Georgia, serif'
                                }}>
                                    Cmo funciona NexMe
                                </h2>
                                <p style={{
                                    color: '#888',
                                    fontSize: '16px',
                                    maxWidth: '600px',
                                    margin: '0 auto 60px',
                                    lineHeight: '1.6'
                                }}>
                                    Conecta con personas reales cerca de ti en 3 simples pasos
                                </p>

                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: 'repeat(3, 1fr)',
                                    gap: '40px'
                                }}>
                                    <div style={{ textAlign: 'center' }}>
                                        <div style={{
                                            width: '80px',
                                            height: '80px',
                                            borderRadius: '50%',
                                            background: 'rgba(56, 189, 98, 0.1)',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            margin: '0 auto 20px',
                                            fontSize: '32px'
                                        }}>
                                            
                                        </div>
                                        <h3 style={{ fontSize: '18px', marginBottom: '12px' }}>1. Activa tu ubicacin</h3>
                                        <p style={{ color: '#888', fontSize: '14px', lineHeight: '1.6' }}>
                                            NexMe usa GPS de alta precisin para detectar personas entre 5 y 1000 metros de distancia.
                                        </p>
                                    </div>

                                    <div style={{ textAlign: 'center' }}>
                                        <div style={{
                                            width: '80px',
                                            height: '80px',
                                            borderRadius: '50%',
                                            background: 'rgba(56, 189, 98, 0.1)',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            margin: '0 auto 20px',
                                            fontSize: '32px'
                                        }}>
                                            
                                        </div>
                                        <h3 style={{ fontSize: '18px', marginBottom: '12px' }}>2. Descubre quin est cerca</h3>
                                        <p style={{ color: '#888', fontSize: '14px', lineHeight: '1.6' }}>
                                            Ve los avatares de personas cercanas en el mapa en tiempo real con sus pensamientos y estados.
                                        </p>
                                    </div>

                                    <div style={{ textAlign: 'center' }}>
                                        <div style={{
                                            width: '80px',
                                            height: '80px',
                                            borderRadius: '50%',
                                            background: 'rgba(56, 189, 98, 0.1)',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            margin: '0 auto 20px',
                                            fontSize: '32px'
                                        }}>
                                            
                                        </div>
                                        <h3 style={{ fontSize: '18px', marginBottom: '12px' }}>3. Conecta y chatea</h3>
                                        <p style={{ color: '#888', fontSize: '14px', lineHeight: '1.6' }}>
                                            Enva mensajes directos, ve sus stories y conoce gente nueva al instante.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </section>

                        {/* Features Section */}
                        <section style={{
                            padding: '100px 32px',
                            borderTop: '1px solid #2d2d2d'
                        }}>
                            <div style={{ maxWidth: '1000px', margin: '0 auto' }}>
                                <h2 style={{
                                    fontSize: '36px',
                                    fontWeight: '400',
                                    marginBottom: '60px',
                                    fontFamily: 'Georgia, serif',
                                    textAlign: 'center'
                                }}>
                                    Caractersticas
                                </h2>

                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: 'repeat(2, 1fr)',
                                    gap: '40px'
                                }}>
                                    <div style={{
                                        padding: '30px',
                                        borderRadius: '16px',
                                        border: '1px solid #2d2d2d',
                                        background: '#1f1f1f'
                                    }}>
                                        <div style={{ fontSize: '28px', marginBottom: '16px' }}></div>
                                        <h3 style={{ fontSize: '18px', marginBottom: '10px' }}>Mapa en tiempo real</h3>
                                        <p style={{ color: '#888', fontSize: '14px', lineHeight: '1.6' }}>
                                            Visualiza a todos los usuarios cercanos en un mapa interactivo de Google Maps. Los avatares se mueven suavemente cuando las personas se desplazan.
                                        </p>
                                    </div>

                                    <div style={{
                                        padding: '30px',
                                        borderRadius: '16px',
                                        border: '1px solid #2d2d2d',
                                        background: '#1f1f1f'
                                    }}>
                                        <div style={{ fontSize: '28px', marginBottom: '16px' }}></div>
                                        <h3 style={{ fontSize: '18px', marginBottom: '10px' }}>Pensamientos</h3>
                                        <p style={{ color: '#888', fontSize: '14px', lineHeight: '1.6' }}>
                                            Comparte qu ests buscando o pensando. "Caf?", "Gym?", "Alguien para estudiar" - los dems ven tus intenciones al instante.
                                        </p>
                                    </div>

                                    <div style={{
                                        padding: '30px',
                                        borderRadius: '16px',
                                        border: '1px solid #2d2d2d',
                                        background: '#1f1f1f'
                                    }}>
                                        <div style={{ fontSize: '28px', marginBottom: '16px' }}></div>
                                        <h3 style={{ fontSize: '18px', marginBottom: '10px' }}>Stories de 12 horas</h3>
                                        <p style={{ color: '#888', fontSize: '14px', lineHeight: '1.6' }}>
                                            Comparte fotos que desaparecen automticamente. Los usuarios con stories activas tienen un anillo colorido estilo Instagram.
                                        </p>
                                    </div>

                                    <div style={{
                                        padding: '30px',
                                        borderRadius: '16px',
                                        border: '1px solid #2d2d2d',
                                        background: '#1f1f1f'
                                    }}>
                                        <div style={{ fontSize: '28px', marginBottom: '16px' }}></div>
                                        <h3 style={{ fontSize: '18px', marginBottom: '10px' }}>Chat instantneo</h3>
                                        <p style={{ color: '#888', fontSize: '14px', lineHeight: '1.6' }}>
                                            Enva mensajes directos a cualquier persona cercana. Notificaciones en tiempo real y bandeja de entrada organizada.
                                        </p>
                                    </div>

                                    <div style={{
                                        padding: '30px',
                                        borderRadius: '16px',
                                        border: '1px solid #2d2d2d',
                                        background: '#1f1f1f'
                                    }}>
                                        <div style={{ fontSize: '28px', marginBottom: '16px' }}></div>
                                        <h3 style={{ fontSize: '18px', marginBottom: '10px' }}>Filtros inteligentes</h3>
                                        <p style={{ color: '#888', fontSize: '14px', lineHeight: '1.6' }}>
                                            Filtra por edad, gnero e intereses. Ajusta el radio de bsqueda de 5m a 1km para encontrar exactamente a quien buscas.
                                        </p>
                                    </div>

                                    <div style={{
                                        padding: '30px',
                                        borderRadius: '16px',
                                        border: '1px solid #2d2d2d',
                                        background: '#1f1f1f'
                                    }}>
                                        <div style={{ fontSize: '28px', marginBottom: '16px' }}></div>
                                        <h3 style={{ fontSize: '18px', marginBottom: '10px' }}>Privacidad total</h3>
                                        <p style={{ color: '#888', fontSize: '14px', lineHeight: '1.6' }}>
                                            T controlas cundo compartes tu ubicacin. Desactvala cuando quieras y desapareces del mapa al instante.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </section>

                        {/* Social Proof Section */}
                        <section style={{
                            padding: '100px 32px',
                            borderTop: '1px solid #2d2d2d',
                            background: '#141414',
                            textAlign: 'center'
                        }}>
                            <h2 style={{
                                fontSize: '36px',
                                fontWeight: '400',
                                marginBottom: '60px',
                                fontFamily: 'Georgia, serif'
                            }}>
                                Conoce gente de verdad
                            </h2>

                            <div style={{
                                display: 'flex',
                                justifyContent: 'center',
                                gap: '60px',
                                flexWrap: 'wrap',
                                maxWidth: '800px',
                                margin: '0 auto'
                            }}>
                                <div>
                                    <div style={{ fontSize: '48px', fontWeight: '600', color: '#38bd62' }}>50m</div>
                                    <div style={{ color: '#888', fontSize: '14px' }}>Radio mnimo</div>
                                </div>
                                <div>
                                    <div style={{ fontSize: '48px', fontWeight: '600', color: '#38bd62' }}>1km</div>
                                    <div style={{ color: '#888', fontSize: '14px' }}>Radio mximo</div>
                                </div>
                                <div>
                                    <div style={{ fontSize: '48px', fontWeight: '600', color: '#38bd62' }}>12h</div>
                                    <div style={{ color: '#888', fontSize: '14px' }}>Duracin stories</div>
                                </div>
                                <div>
                                    <div style={{ fontSize: '48px', fontWeight: '600', color: '#38bd62' }}></div>
                                    <div style={{ color: '#888', fontSize: '14px' }}>Conexiones</div>
                                </div>
                            </div>
                        </section>

                        {/* Final CTA */}
                        <section style={{
                            padding: '100px 32px',
                            borderTop: '1px solid #2d2d2d',
                            textAlign: 'center'
                        }}>
                            <h2 style={{
                                fontSize: '36px',
                                fontWeight: '400',
                                marginBottom: '16px',
                                fontFamily: 'Georgia, serif'
                            }}>
                                Empieza a conectar hoy
                            </h2>
                            <p style={{
                                color: '#888',
                                marginBottom: '32px',
                                fontSize: '16px'
                            }}>
                                Gratis. Sin anuncios. Sin lmites.
                            </p>
                            <button onClick={handleGoogleSignIn} style={{
                                padding: '16px 40px',
                                borderRadius: '8px',
                                border: 'none',
                                background: '#38bd62',
                                color: '#fff',
                                fontSize: '16px',
                                fontWeight: '500',
                                cursor: 'pointer',
                                display: 'inline-flex',
                                alignItems: 'center',
                                gap: '10px'
                            }}>
                                <svg width="20" height="20" viewBox="0 0 24 24">
                                    <path fill="#fff" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="#fff" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="#fff" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="#fff" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                Comenzar con Google
                            </button>
                        </section>

                        {/* Footer */}
                        <footer style={{
                            padding: '30px 32px',
                            borderTop: '1px solid #2d2d2d',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            color: '#666',
                            fontSize: '13px'
                        }}>
                            <span> 2024 NexMe</span>
                            <div style={{ display: 'flex', gap: '24px' }}>
                                <span style={{ cursor: 'pointer' }}>Trminos</span>
                                <span style={{ cursor: 'pointer' }}>Privacidad</span>
                                <span style={{ cursor: 'pointer' }}>Contacto</span>
                            </div>
                        </footer>

                        {/* CSS Animations */}
                        <style>{`
                            @keyframes float {
                                0%, 100% { transform: translateY(0px); }
                                50% { transform: translateY(-8px); }
                            }
                            @keyframes floatSide {
                                0%, 100% { transform: translateX(0px); }
                                50% { transform: translateX(6px); }
                            }
                            @keyframes pulse {
                                0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.3; }
                                50% { transform: translate(-50%, -50%) scale(1.15); opacity: 0.1; }
                            }
                            @keyframes breathe {
                                0%, 100% { transform: scale(1); }
                                50% { transform: scale(1.05); }
                            }
                            .hero-avatar-1 { animation: breathe 3s ease-in-out infinite; }
                            .hero-avatar-2 { animation: float 4s ease-in-out infinite 0.5s; }
                            .hero-avatar-3 { animation: floatSide 5s ease-in-out infinite 1s; }
                            .phone-avatar-float { animation: float 4s ease-in-out infinite; }
                            .phone-avatar-float2 { animation: float 5s ease-in-out infinite 1s; }
                            .pulse-ring { animation: pulse 3s ease-in-out infinite; }
                            .pulse-ring2 { animation: pulse 3s ease-in-out infinite 0.5s; }
                            @media (max-width: 900px) {
                                section[style*="grid-template-columns: 1fr 1fr"] {
                                    grid-template-columns: 1fr !important;
                                }
                                section[style*="grid-template-columns: repeat(3"] {
                                    grid-template-columns: 1fr !important;
                                }
                                section[style*="grid-template-columns: repeat(2"] {
                                    grid-template-columns: 1fr !important;
                                }
                                nav { display: none !important; }
                            }
                        `}</style>
                    </div>
                );
            }

            const usersInRange = users.filter(u => {
                // Basic filters
                if (u.distance > radius || !u.isOnline || u.latitude === 0) return false;
                
                // Interest filter: only apply if current user has interests set
                if (userPreferences.interests.length > 0) {
                    if (!u.preferences?.interests || u.preferences.interests.length === 0) return true;
                    const hasCommonInterest = u.preferences.interests.some(
                        interest => userPreferences.interests.includes(interest)
                    );
                    if (!hasCommonInterest) return false;
                }
                
                return true;
            });
            const chatId = selectedUser ? [currentUser?.id, selectedUser.id].sort().join('_') : null;
            const chatMessages = chatId ? (messages[chatId] || []) : [];

            return (
                <>
                    {waitingForGPS && (
                        <div className="location-permission">
                            <div className="permission-card">
                                <svg className="permission-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
                                </svg>
                                <h2>Esperando GPS...</h2>
                                <p>Obteniendo tu ubicacin con alta precisin. Esto puede tomar unos segundos.</p>
                                <div className="gps-dots">
                                    <div className="gps-dot"/><div className="gps-dot"/><div className="gps-dot"/>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="main-container">
                        <div className="radar-container">
                            <div id="google-map" ref={mapRef}></div>
                            
                            <div className="map-header">
                                <svg className="header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" onClick={() => setShowSidebar(true)}>
                                    <line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/>
                                </svg>
                                <div className="map-people-counter" onClick={() => setMarkerRefreshTick(t => t + 1)} style={{ cursor: 'pointer' }}>
                                    <span className="map-people-counter-number">{usersInRange.length}</span>
                                    <span className="map-people-counter-text">cerca</span>
                                </div>
                                <div style={{ position: 'relative' }} onClick={() => setShowInbox(true)}>
                                    <svg className="header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>
                                    </svg>
                                    {totalUnread > 0 && (
                                        <div style={{
                                            position: 'absolute',
                                            top: '-6px',
                                            right: '-6px',
                                            minWidth: '18px',
                                            height: '18px',
                                            background: 'linear-gradient(135deg, #ff6b35, #f7931e)',
                                            borderRadius: '9px',
                                            border: '2px solid #0d1117',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontSize: '10px',
                                            fontWeight: '700',
                                            color: '#fff',
                                            padding: '0 4px'
                                        }}>
                                            {totalUnread > 9 ? '9+' : totalUnread}
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            
                        </div>
                        
                        <div className="range-slider-container">
                            <div className="range-slider-label">
                                <span className="range-slider-title">Radio de bsqueda</span>
                                <span className="range-slider-value">{radius}m</span>
                            </div>
                            <div className="range-slider-track"
                                onMouseDown={(e) => { const rect = e.currentTarget.getBoundingClientRect(); const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width)); setRadius(Math.round(percent * 1000)); setIsDraggingDial(true); }}
                                onMouseMove={(e) => { if (!isDraggingDial) return; const rect = e.currentTarget.getBoundingClientRect(); const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width)); setRadius(Math.round(percent * 1000)); }}
                                onMouseUp={() => setIsDraggingDial(false)}
                                onMouseLeave={() => setIsDraggingDial(false)}
                                onTouchStart={(e) => { const rect = e.currentTarget.getBoundingClientRect(); const touch = e.touches[0]; const percent = Math.max(0, Math.min(1, (touch.clientX - rect.left) / rect.width)); setRadius(Math.round(percent * 1000)); setIsDraggingDial(true); }}
                                onTouchMove={(e) => { if (!isDraggingDial) return; const rect = e.currentTarget.getBoundingClientRect(); const touch = e.touches[0]; const percent = Math.max(0, Math.min(1, (touch.clientX - rect.left) / rect.width)); setRadius(Math.round(percent * 1000)); }}
                                onTouchEnd={() => setIsDraggingDial(false)}
                            >
                                <div className="range-slider-progress" style={{ width: `${(radius / 1000) * 100}%` }}/>
                                <div className="range-slider-thumb" style={{ left: `${(radius / 1000) * 100}%` }}/>
                            </div>
                            <div className="range-slider-marks">
                                <span className="range-slider-mark">0m</span>
                                <span className="range-slider-mark">500m</span>
                                <span className="range-slider-mark">1km</span>
                            </div>
                        </div>
                        
                        <div className="thought-input-container">
                            <div className="thought-input-wrapper">
                                {/* Emoji icon */}
                                <svg className="thought-input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                                    <line x1="9" y1="9" x2="9.01" y2="9"/>
                                    <line x1="15" y1="9" x2="15.01" y2="9"/>
                                </svg>
                                <input type="text" className="thought-input" placeholder="Mensaje" value={thought} onChange={(e) => setThought(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleThoughtSubmit()} maxLength={15}/>
                            </div>
                            <button className="send-button" onClick={handleThoughtSubmit}>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M5 12h14M12 5l7 7-7 7"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    {/* Sidebar */}
                    <div className={`overlay-backdrop ${showSidebar ? 'active' : ''}`} onClick={() => setShowSidebar(false)}/>
                    <div className={`sidebar ${showSidebar ? 'active' : ''}`}>
                        <div className="sidebar-header">
                            <h2>Men</h2>
                            <svg style={{ width: 24, height: 24, cursor: 'pointer', color: '#8b949e' }} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" onClick={() => setShowSidebar(false)}>
                                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </div>
                        <div className="sidebar-content">
                            <div className="sidebar-item" onClick={() => { setShowProfile(true); setShowSidebar(false); }}>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                <span>Mi Perfil</span>
                            </div>
                            <div className="sidebar-item" onClick={() => { setShowInbox(true); setShowSidebar(false); }}>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                                <span>Mensajes</span>
                            </div>
                            <div className="sidebar-item" onClick={() => { setShowTechSettings(true); setShowSidebar(false); }}>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                                <span>Tecnologas</span>
                            </div>
                            <div className="sidebar-item" onClick={() => { setShowStoryUpload(true); setShowSidebar(false); }}>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                                <span>Subir Historia</span>
                            </div>
                            <div className="sidebar-item" onClick={() => { setShowPreferences(true); setShowSidebar(false); }}>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                                <span>Mis Preferencias</span>
                            </div>
                            <div className="sidebar-item" style={{ marginTop: 'auto', color: '#f87171' }} onClick={handleLogout}>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                                <span>Cerrar Sesin</span>
                            </div>
                            <div style={{ padding: '16px 20px', borderTop: '1px solid rgba(48,54,61,0.5)', marginTop: '12px' }}>
                                <span style={{ fontSize: '11px', color: '#6e7681', fontWeight: '500' }}>NexMe v7.9.0</span>
                            </div>
                        </div>
                    </div>

                    {/* Profile */}
                    <div className={`profile-overlay ${showProfile ? 'active' : ''}`}>
                        <div className="profile-header">
                            <svg style={{ width: 24, height: 24, cursor: 'pointer', color: '#8b949e' }} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" onClick={() => setShowProfile(false)}><polyline points="15 18 9 12 15 6"/></svg>
                            <h2>Mi Perfil</h2>
                        </div>
                        <div className="profile-content">
                            <div className="profile-avatar-section">
                                <img src={currentUser?.photo} alt={currentUser?.name} className="profile-avatar-large"/>
                                <h2 className="profile-name">{currentUser?.name}</h2>
                                <p className="profile-bio">{currentUser?.thought || 'Sin pensamiento actual'}</p>
                            </div>
                            <div className="profile-section">
                                <h3 className="profile-section-title">Informacin</h3>
                                <div className="profile-field"><span className="profile-field-label">Email</span><span className="profile-field-value">{currentUser?.email}</span></div>
                                <div className="profile-field"><span className="profile-field-label">Estado</span><span className="profile-field-value" style={{ color: '#38bd62' }}> En lnea</span></div>
                                <div className="profile-field"><span className="profile-field-label">Historia</span><span className="profile-field-value">{currentUser?.hasStory ? ' Activa' : 'Sin historia'}</span></div>
                            </div>
                            <div className="profile-section">
                                <h3 className="profile-section-title">Ubicacin</h3>
                                <div className="profile-field"><span className="profile-field-label">Precisin GPS</span><span className="profile-field-value">{locationAccuracy.toFixed(1)}m</span></div>
                                <div className="profile-field"><span className="profile-field-label">Tecnologa</span><span className="profile-field-value">{activeTech.icon} {activeTech.name}</span></div>
                            </div>
                        </div>
                    </div>

                    {/* Inbox - Redesigned */}
                    <div className={`inbox-overlay ${showInbox ? 'active' : ''}`}>
                        <div className="inbox-header">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ width: 24, height: 24, cursor: 'pointer', color: '#8b949e' }} onClick={() => setShowInbox(false)}><polyline points="15 18 9 12 15 6"/></svg>
                            <h2>Mensajes</h2>
                            <div style={{ display: 'flex', gap: '16px' }}>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ width: 22, height: 22, cursor: 'pointer', color: '#8b949e' }}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                            </div>
                        </div>
                        
                        <div className="inbox-list">
                            {/* Notes/Thoughts Section */}
                            <div className="inbox-notes-section">
                                <div className="inbox-notes-scroll">
                                    {/* Your Note */}
                                    <div className="inbox-note-item" onClick={() => { setShowInbox(false); }}>
                                        <div className="inbox-note-avatar-container">
                                            {currentUser?.thought && (
                                                <div className="inbox-note-thought">{currentUser.thought}</div>
                                            )}
                                            <div className={`inbox-note-ring ${currentUser?.hasStory ? 'has-story' : 'default'}`}>
                                                <div className="inbox-note-ring-inner">
                                                    <img src={currentUser?.photo} alt="Tu nota" className="inbox-note-avatar"/>
                                                </div>
                                            </div>
                                            {!currentUser?.thought && (
                                                <div style={{ position: 'absolute', bottom: -2, right: -2, width: 20, height: 20, background: '#38bd62', borderRadius: '50%', border: '2px solid #0d1117', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                                    <span style={{ color: '#fff', fontSize: 14, fontWeight: 'bold' }}>+</span>
                                                </div>
                                            )}
                                        </div>
                                        <span className="inbox-note-name">Tu nota</span>
                                    </div>
                                    
                                    {/* Nearby users with thoughts - sorted by distance */}
                                    {users
                                        .filter(u => u.isOnline && u.latitude !== 0)
                                        .sort((a, b) => a.distance - b.distance)
                                        .slice(0, 10)
                                        .map(user => (
                                            <div key={user.id} className="inbox-note-item" onClick={() => { 
                                                if (user.hasStory) {
                                                    setViewedStories(prev => ({ ...prev, [user.id]: Date.now() }));
                                                    setViewingStory(user);
                                                }
                                                else { openChat(user); setShowInbox(false); }
                                            }}>
                                                <div className="inbox-note-avatar-container">
                                                    {user.thought && (
                                                        <div className="inbox-note-thought">{user.thought}</div>
                                                    )}
                                                    <div className={`inbox-note-ring ${user.hasStory ? 'has-story' : user.isOnline ? 'online' : 'default'}`}>
                                                        <div className="inbox-note-ring-inner">
                                                            <img src={user.photo} alt={user.name} className="inbox-note-avatar"/>
                                                        </div>
                                                    </div>
                                                </div>
                                                <span className="inbox-note-name">{user.name.split(' ')[0]}</span>
                                                <span className="inbox-note-distance">{user.distance}m</span>
                                            </div>
                                        ))
                                    }
                                </div>
                            </div>
                            
                            {/* Tabs */}
                            <div className="inbox-tabs">
                                <div className={`inbox-tab ${inboxTab === 'messages' ? 'active' : ''}`} onClick={() => setInboxTab('messages')}>
                                    Mensajes
                                </div>
                                <div className={`inbox-tab ${inboxTab === 'requests' ? 'active' : ''}`} onClick={() => setInboxTab('requests')}>
                                    Solicitudes
                                </div>
                            </div>
                            
                            {/* Chat List */}
                            <div className="inbox-chats-list">
                                {users.length === 0 ? (
                                    <div className="inbox-empty">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                        <p>No hay conversaciones an</p>
                                        <p style={{ fontSize: '13px', marginTop: '8px' }}>Saluda a alguien cercano!</p>
                                    </div>
                                ) : (
                                    users
                                        .filter(u => u.isOnline)
                                        .sort((a, b) => {
                                            // Mensajes no ledos primero, luego favoritos, luego por distancia
                                            const aUnread = unreadMessages[a.id] ? 0 : 1;
                                            const bUnread = unreadMessages[b.id] ? 0 : 1;
                                            if (aUnread !== bUnread) return aUnread - bUnread;
                                            const aFav = favoriteUsers.includes(a.id) ? 0 : 1;
                                            const bFav = favoriteUsers.includes(b.id) ? 0 : 1;
                                            if (aFav !== bFav) return aFav - bFav;
                                            return a.distance - b.distance;
                                        })
                                        .map(user => (
                                            <div key={user.id} className="inbox-item" onClick={() => { openChat(user); setShowInbox(false); }}>
                                                <div className="inbox-avatar-container">
                                                    <img 
                                                        src={user.photo} 
                                                        alt={user.name} 
                                                        className="inbox-avatar"
                                                        style={unreadMessages[user.id] ? { border: '3px solid #f7d046' } : {}}
                                                    />
                                                    {user.isOnline && <div className="inbox-online-indicator"/>}
                                                    {unreadMessages[user.id] > 0 && (
                                                        <div style={{
                                                            position: 'absolute',
                                                            bottom: '-2px',
                                                            right: '-2px',
                                                            minWidth: '18px',
                                                            height: '18px',
                                                            background: 'linear-gradient(135deg, #ff6b35, #f7931e)',
                                                            borderRadius: '9px',
                                                            border: '2px solid #0d1117',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'center',
                                                            fontSize: '10px',
                                                            fontWeight: '700',
                                                            color: '#fff',
                                                            padding: '0 4px'
                                                        }}>
                                                            {unreadMessages[user.id] > 9 ? '9+' : unreadMessages[user.id]}
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="inbox-info">
                                                    <div className="inbox-name-row">
                                                        <span className="inbox-name" style={unreadMessages[user.id] ? { fontWeight: '700' } : {}}>{user.name}</span>
                                                        <span className="inbox-time"> {user.distance}m</span>
                                                    </div>
                                                    <div className={`inbox-preview ${unreadMessages[user.id] ? 'unread' : ''}`}>
                                                        {user.thought ? `"${user.thought}"` : 'Toca para iniciar chat'}
                                                    </div>
                                                </div>
                                                <div className="inbox-actions">
                                                    <svg 
                                                        viewBox="0 0 24 24" 
                                                        fill={favoriteUsers.includes(user.id) ? '#f7d046' : 'none'} 
                                                        stroke="currentColor" 
                                                        strokeWidth="2" 
                                                        className={`inbox-favorite ${favoriteUsers.includes(user.id) ? 'active' : ''}`}
                                                        style={{ width: 20, height: 20 }}
                                                        onClick={(e) => { 
                                                            e.stopPropagation();
                                                            setFavoriteUsers(prev => 
                                                                prev.includes(user.id) 
                                                                    ? prev.filter(id => id !== user.id)
                                                                    : [...prev, user.id]
                                                            );
                                                        }}
                                                    >
                                                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                                    </svg>
                                                </div>
                                            </div>
                                        ))
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Preferences Panel */}
                    <div className={`preferences-overlay ${showPreferences ? 'active' : ''}`}>
                        <div className="preferences-container">
                            <div className="preferences-header">
                                <h2> Mis Preferencias</h2>
                                <div className="preferences-close" onClick={() => setShowPreferences(false)}>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                    </svg>
                                </div>
                            </div>
                            
                            {/* Mi informacin */}
                            <div className="preferences-section">
                                <div className="preferences-section-title"> Mi informacin</div>
                                <div className="preferences-row">
                                    <span className="preferences-label">Mi edad</span>
                                    <input 
                                        type="number" 
                                        className="preferences-input"
                                        value={userPreferences.age}
                                        onChange={(e) => setUserPreferences(prev => ({ ...prev, age: parseInt(e.target.value) || 18 }))}
                                        min="18"
                                        max="99"
                                    />
                                </div>
                                <div className="preferences-row">
                                    <span className="preferences-label">Mi gnero</span>
                                    <select 
                                        className="preferences-select"
                                        value={userPreferences.gender}
                                        onChange={(e) => setUserPreferences(prev => ({ ...prev, gender: e.target.value }))}
                                    >
                                        <option value="">Prefiero no decir</option>
                                        <option value="male">Hombre</option>
                                        <option value="female">Mujer</option>
                                        <option value="other">Otro</option>
                                    </select>
                                </div>
                            </div>
                            
                            {/* Busco personas */}
                            <div className="preferences-section">
                                <div className="preferences-section-title"> Busco personas</div>
                                <div className="preferences-row">
                                    <span className="preferences-label">Rango de edad</span>
                                    <div className="age-range-container">
                                        <input 
                                            type="number" 
                                            className="preferences-input"
                                            value={userPreferences.ageRangeMin}
                                            onChange={(e) => setUserPreferences(prev => ({ ...prev, ageRangeMin: parseInt(e.target.value) || 18 }))}
                                            min="18"
                                            max="99"
                                        />
                                        <span className="age-range-separator">-</span>
                                        <input 
                                            type="number" 
                                            className="preferences-input"
                                            value={userPreferences.ageRangeMax}
                                            onChange={(e) => setUserPreferences(prev => ({ ...prev, ageRangeMax: parseInt(e.target.value) || 99 }))}
                                            min="18"
                                            max="99"
                                        />
                                    </div>
                                </div>
                                <div className="preferences-row">
                                    <span className="preferences-label">Gnero</span>
                                    <select 
                                        className="preferences-select"
                                        value={userPreferences.genderPreference}
                                        onChange={(e) => setUserPreferences(prev => ({ ...prev, genderPreference: e.target.value }))}
                                    >
                                        <option value="all">Todos</option>
                                        <option value="male">Hombres</option>
                                        <option value="female">Mujeres</option>
                                        <option value="other">Otro</option>
                                    </select>
                                </div>
                            </div>
                            
                            {/* Intereses */}
                            <div className="preferences-section">
                                <div className="preferences-section-title"> Mis intereses</div>
                                <div className="interests-grid">
                                    {availableInterests.map(interest => (
                                        <div 
                                            key={interest.id}
                                            className={`interest-chip ${userPreferences.interests.includes(interest.id) ? 'selected' : ''}`}
                                            onClick={() => toggleInterest(interest.id)}
                                        >
                                            {interest.label}
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            {/* Qu busco ahora */}
                            <div className="preferences-section">
                                <div className="preferences-section-title"> Qu busco ahora?</div>
                                <div className="looking-for-grid">
                                    {lookingForOptions.map(option => (
                                        <div 
                                            key={option.id}
                                            className={`looking-for-option ${userPreferences.lookingFor.includes(option.id) ? 'selected' : ''}`}
                                            onClick={() => toggleLookingFor(option.id)}
                                        >
                                            <div className="looking-for-checkbox">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3">
                                                    <polyline points="20 6 9 17 4 12"/>
                                                </svg>
                                            </div>
                                            <span className="looking-for-label">{option.label}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            {/* Guardar */}
                            <div className="preferences-section" style={{ borderBottom: 'none' }}>
                                <button className="preferences-save-btn" onClick={savePreferences}>
                                     Guardar Preferencias
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Tech Settings */}
                    <div className={`tech-settings-overlay ${showTechSettings ? 'active' : ''}`}>
                        <div className="tech-settings-header">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ width: 24, height: 24, cursor: 'pointer', color: '#8b949e' }} onClick={() => setShowTechSettings(false)}><polyline points="15 18 9 12 15 6"/></svg>
                            <h2>Tecnologas de Precisin</h2>
                        </div>
                        <div className="tech-settings-content">
                            <div className="tech-mode-selector">
                                <h3>Modo de Operacin</h3>
                                <div className="tech-mode-options">
                                    <div className={`tech-mode-option ${techSettings.mode === 'auto' ? 'active' : ''}`} onClick={() => setTechSettings(prev => ({ ...prev, mode: 'auto' }))}>
                                        <div className="icon"></div><div className="label">Auto</div><div className="description">Seleccin inteligente</div>
                                    </div>
                                    <div className={`tech-mode-option ${techSettings.mode === 'manual' ? 'active' : ''}`} onClick={() => setTechSettings(prev => ({ ...prev, mode: 'manual' }))}>
                                        <div className="icon"></div><div className="label">Manual</div><div className="description">Control total</div>
                                    </div>
                                </div>
                            </div>
                            <div className="tech-list">
                                <h3>Tecnologas Disponibles</h3>
                                <div className={`tech-item ${techSettings.mode === 'auto' ? 'disabled' : ''}`}>
                                    <div className="tech-item-info">
                                        <div className="tech-item-name"><span className="tech-item-icon"></span>GPS Estndar</div>
                                        <div className="tech-item-description">Ubicacin satelital. Precisin: 5-15m</div>
                                    </div>
                                    <div className={`tech-toggle ${techSettings.gps ? 'active' : ''}`} onClick={() => techSettings.mode !== 'auto' && setTechSettings(prev => ({ ...prev, gps: !prev.gps }))}/>
                                </div>
                                <div className={`tech-item ${techSettings.mode === 'auto' ? 'disabled' : ''}`}>
                                    <div className="tech-item-info">
                                        <div className="tech-item-name"><span className="tech-item-icon"></span>Filtro Kalman</div>
                                        <div className="tech-item-description">Suaviza GPS, reduce saltos. Precisin: 2-5m</div>
                                    </div>
                                    <div className={`tech-toggle ${techSettings.kalman ? 'active' : ''}`} onClick={() => techSettings.mode !== 'auto' && setTechSettings(prev => ({ ...prev, kalman: !prev.kalman }))}/>
                                </div>
                                <div className={`tech-item ${techSettings.mode === 'auto' ? 'disabled' : ''}`}>
                                    <div className="tech-item-info">
                                        <div className="tech-item-name"><span className="tech-item-icon"></span>Bluetooth BLE</div>
                                        <div className="tech-item-description">{bleSupported ? 'Detecta cercanos. Precisin: 1-10m' : 'No disponible en este navegador'}</div>
                                    </div>
                                    <div className={`tech-toggle ${techSettings.ble && bleSupported ? 'active' : ''}`} onClick={() => techSettings.mode !== 'auto' && bleSupported && setTechSettings(prev => ({ ...prev, ble: !prev.ble }))}/>
                                </div>
                                {techSettings.ble && bleSupported && (
                                    <div style={{ padding: '12px', background: 'rgba(56, 189, 98, 0.1)', borderRadius: '8px', marginTop: '8px' }}>
                                        <button 
                                            onClick={startBLEScan}
                                            style={{ 
                                                width: '100%', 
                                                padding: '12px', 
                                                background: '#38bd62', 
                                                border: 'none', 
                                                borderRadius: '8px', 
                                                color: '#fff', 
                                                fontWeight: '600',
                                                cursor: 'pointer'
                                            }}
                                        >
                                             Escanear dispositivos BLE
                                        </button>
                                        {bleDevices.length > 0 && (
                                            <div style={{ marginTop: '8px', fontSize: '12px', color: '#8b949e' }}>
                                                Dispositivos: {bleDevices.length} encontrados
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Story Upload */}
                    <div className={`story-upload-overlay ${showStoryUpload ? 'active' : ''}`}>
                        <div className="story-upload-container">
                            <div className="story-upload-header">
                                <h2>Nueva Historia</h2>
                                <div className="story-upload-close" onClick={() => { setShowStoryUpload(false); setStoryImage(null); }}>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                </div>
                            </div>
                            <div className="story-preview-area">
                                {storyImage ? (
                                    <>
                                        <img src={storyImage} alt="Preview"/>
                                        <div className="story-remove-btn" onClick={() => setStoryImage(null)}>
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                        </div>
                                    </>
                                ) : (
                                    <div className="story-preview-placeholder">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                                        <span>Selecciona una imagen</span>
                                    </div>
                                )}
                            </div>
                            <div className="story-upload-actions">
                                <label className="story-select-btn">
                                    <svg style={{ width: 20, height: 20 }} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                                    Galera
                                    <input type="file" accept="image/*" style={{ display: 'none' }} onChange={handleStoryImageSelect}/>
                                </label>
                                <button className="story-publish-btn" disabled={!storyImage || uploadingStory} onClick={handleStoryPublish}>
                                    {uploadingStory ? 'Subiendo...' : (<><svg style={{ width: 20, height: 20 }} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>Publicar</>)}
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Story Viewer */}
                    <div className={`story-viewer ${viewingStory ? 'active' : ''}`}>
                        {viewingStory && (
                            <div className="story-container">
                                <div className="story-progress-bar"><div className="story-progress-fill" key={viewingStory.id}></div></div>
                                <div className="story-header">
                                    <div className="story-user-info">
                                        <img src={viewingStory.photo} alt={viewingStory.name} className="story-user-avatar"/>
                                        <div style={{ display: 'flex', flexDirection: 'column' }}>
                                            <span className="story-user-name">{viewingStory.name}</span>
                                            <span style={{ fontSize: '11px', color: 'rgba(255,255,255,0.6)' }}>
                                                {viewingStory.storyTimestamp ? formatTimeAgo(viewingStory.storyTimestamp) : 'Hace un momento'}
                                            </span>
                                        </div>
                                    </div>
                                    <div className="story-close" onClick={() => { setViewedStories(prev => ({ ...prev, [viewingStory.id]: Date.now() })); setViewingStory(null); }}>
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                    </div>
                                </div>
                                <img src={viewingStory.storyUrl} alt="Story" className="story-image"/>
                                {viewingStory.id !== currentUser?.id && (
                                    <>
                                        <div className="story-reactions">
                                            {['', '', '', '', ''].map(emoji => (
                                                <button key={emoji} className="story-reaction-btn" onClick={() => sendStoryReaction(emoji)}>{emoji}</button>
                                            ))}
                                        </div>
                                        <button className="story-message-btn" onClick={() => { setViewingStory(null); openChat(viewingStory); }}>
                                            <svg style={{ width: 20, height: 20 }} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                            Enviar mensaje
                                        </button>
                                    </>
                                )}
                            </div>
                        )}
                    </div>

                    {/* Instagram Modal */}
                    <div className={`instagram-modal-backdrop ${showInstagramModal ? 'active' : ''}`} onClick={() => setShowInstagramModal(false)}/>
                    <div className={`instagram-modal ${showInstagramModal ? 'active' : ''}`}>
                        {instagramModalUser && (
                            <>
                                <div className="instagram-modal-header">
                                    <img src={instagramModalUser.photo} alt={instagramModalUser.name} className="instagram-modal-avatar"/>
                                    <div className="instagram-modal-info">
                                        <div className="instagram-modal-name">{instagramModalUser.name}</div>
                                        <div className="instagram-modal-distance"> A {instagramModalUser.distance}m {instagramModalUser.thought && ` "${instagramModalUser.thought}"`}</div>
                                    </div>
                                </div>
                                
                                {/* Intereses del usuario */}
                                {instagramModalUser.preferences?.interests && instagramModalUser.preferences.interests.length > 0 && (
                                    <div style={{ 
                                        padding: '12px 16px', 
                                        borderBottom: '1px solid rgba(48,54,61,0.3)',
                                        display: 'flex',
                                        flexWrap: 'wrap',
                                        gap: '6px'
                                    }}>
                                        {instagramModalUser.preferences.interests.map(interestId => {
                                            const interest = availableInterests.find(i => i.id === interestId);
                                            const isCommon = userPreferences.interests.includes(interestId);
                                            return interest ? (
                                                <span key={interestId} style={{
                                                    padding: '4px 10px',
                                                    borderRadius: '12px',
                                                    fontSize: '12px',
                                                    background: isCommon ? 'rgba(56, 189, 98, 0.2)' : 'rgba(139, 148, 158, 0.15)',
                                                    color: isCommon ? '#38bd62' : '#8b949e',
                                                    border: isCommon ? '1px solid rgba(56, 189, 98, 0.3)' : '1px solid transparent'
                                                }}>
                                                    {interest.emoji} {isCommon && ''}
                                                </span>
                                            ) : null;
                                        })}
                                    </div>
                                )}
                                
                                {/* Qu busca */}
                                {instagramModalUser.preferences?.lookingFor && instagramModalUser.preferences.lookingFor.length > 0 && (
                                    <div style={{ 
                                        padding: '8px 16px', 
                                        borderBottom: '1px solid rgba(48,54,61,0.3)',
                                        fontSize: '12px',
                                        color: '#8b949e'
                                    }}>
                                        Busca: {instagramModalUser.preferences.lookingFor.map(id => {
                                            const option = lookingForOptions.find(o => o.id === id);
                                            return option?.emoji || '';
                                        }).join(' ')}
                                    </div>
                                )}
                                
                                <div className="instagram-modal-actions">
                                    <input type="text" className="instagram-modal-input" placeholder={`Mensaje a ${instagramModalUser.name}...`} value={quickMessage} onChange={(e) => setQuickMessage(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && sendQuickMessage()}/>
                                    <div className="instagram-modal-heart" onClick={sendLike}>
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>

                    {/* Chat */}
                    <div className={`chat-overlay ${selectedUser ? 'active' : ''}`}>
                        {selectedUser && (
                            <>
                                <div className="chat-header">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ width: 24, height: 24, cursor: 'pointer', color: '#aebac1' }} onClick={() => setSelectedUser(null)}><polyline points="15 18 9 12 15 6"/></svg>
                                    <div className="chat-user-info">
                                        <img src={selectedUser.photo} alt={selectedUser.name} className="chat-user-avatar"/>
                                        <div className="chat-user-details">
                                            <h3>{selectedUser.name}</h3>
                                            <p>A {selectedUser.distance}m  {selectedUser.isOnline ? 'En lnea' : 'Desconectado'}</p>
                                        </div>
                                    </div>
                                </div>
                                <div className="chat-content">
                                    <div className="chat-messages" ref={chatMessagesRef}>
                                        {chatMessages.length === 0 ? (
                                            <div className="chat-info">Inicia una conversacin con {selectedUser.name}!<br/>Estn a solo {selectedUser.distance}m de distancia.</div>
                                        ) : (
                                            chatMessages.map((msg) => (
                                                <div key={msg.id} className={`message ${msg.senderId === currentUser?.id ? 'sent' : 'received'}`}>
                                                    {msg.type === 'like' ? <span style={{ fontSize: '24px' }}></span> : msg.text}
                                                    <span className="message-time">{formatMessageTime(msg.timestamp)}</span>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                    <div className="chat-input-container">
                                        <input type="text" className="chat-input" placeholder="Escribe un mensaje..." value={messageInput} onChange={(e) => setMessageInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && sendMessage()}/>
                                        <button className="chat-send-btn" onClick={sendMessage} disabled={!messageInput.trim()}>
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                                        </button>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>

                    {/* Social Proximity Notifications */}
                    {socialNotifications.map((notification, index) => (
                        <div key={notification.id} className="social-notification" style={{ top: `${100 + index * 110}px` }}>
                            <button className="social-notification-close" onClick={() => setSocialNotifications(prev => prev.filter(n => n.id !== notification.id))}>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                            </button>
                            <div className="social-notification-header">
                                <img src={notification.user.photo} alt={notification.user.name} className="social-notification-avatar"/>
                                <div className="social-notification-info">
                                    <div className="social-notification-name">{notification.user.name}</div>
                                    <div className="social-notification-distance"> A {notification.user.distance}m de ti</div>
                                </div>
                            </div>
                            <div className="social-notification-message">
                                {notification.user.name.split(' ')[0]} est cerca! Te animas a saludarle?
                            </div>
                            <div className="social-notification-actions">
                                <button className="social-notification-btn social-notification-btn-primary" onClick={() => { openChat(notification.user); setSocialNotifications(prev => prev.filter(n => n.id !== notification.id)); }}>
                                    <svg style={{ width: 16, height: 16 }} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                    Saludar
                                </button>
                                <button className="social-notification-btn social-notification-btn-secondary" onClick={() => setSocialNotifications(prev => prev.filter(n => n.id !== notification.id))}>
                                    Ahora no
                                </button>
                            </div>
                        </div>
                    ))}
                </>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<NexMeApp />);
    </script>
</body>
</html>
